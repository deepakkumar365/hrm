# ğŸš€ Render Deployment Guide - Production Database Setup

## ğŸ“‹ Overview

This guide explains how to deploy your HRM application to Render with automatic database migrations for the production PostgreSQL database.

---

## âœ… What's Been Configured

### 1. **Environment Variables in `render.yaml`**

The following environment variables are automatically set on Render:

| Variable | Value | Purpose |
|----------|-------|---------|
| `ENVIRONMENT` | `production` | Tells the app to use production settings |
| `PROD_SESSION_SECRET` | Auto-generated | Secure session key for production |
| `PROD_DATABASE_URL` | Your production DB URL | Connection string for production PostgreSQL |
| `PYTHON_VERSION` | `3.11.4` | Python runtime version |

### 2. **Build Process (`build.sh`)**

During deployment, Render automatically:
1. âœ… Installs Python dependencies from `requirements-render.txt`
2. âœ… Runs `flask db upgrade` to apply all pending migrations
3. âœ… Creates all missing tables in the production database
4. âœ… Logs the process for debugging

### 3. **Application Configuration (`app.py`)**

The app automatically:
- Detects `ENVIRONMENT=production`
- Loads `PROD_SESSION_SECRET` and `PROD_DATABASE_URL`
- Connects to the production PostgreSQL database
- Logs: `ğŸŒ Running in PRODUCTION mode`

---

## ğŸ”„ Deployment Process

### **Step 1: Push to GitHub**

```bash
git add .
git commit -m "Configure production environment and migrations"
git push origin main
```

### **Step 2: Render Auto-Deploys**

Render will automatically:
1. Pull the latest code from GitHub
2. Run `./build.sh`:
   - Install dependencies
   - Run `flask db upgrade` against **production database**
   - Create all tables (`hrm_users`, `hrm_payroll_configuration`, etc.)
3. Start the application with `gunicorn`

### **Step 3: Verify Deployment**

Check the Render logs for:
```
ğŸ”§ Starting Render build process...
ğŸ“¦ Installing Python dependencies...
ğŸŒ Environment: production
ğŸ—„ï¸  Database URL: postgresql://noltrion_admin...
ğŸ”„ Running database migrations...
INFO  [alembic.runtime.migration] Running upgrade -> add_enhancements_001
INFO  [alembic.runtime.migration] Running upgrade -> add_payroll_config
INFO  [alembic.runtime.migration] Running upgrade add_enhancements_001, add_payroll_config -> merge_payroll_and_enhancements
âœ… Build completed successfully!
```

Then check application startup logs:
```
ğŸŒ Running in PRODUCTION mode
Server is ready. Spawning workers
```

---

## ğŸ—„ï¸ Database Migration Commands

### **Automatic (Recommended)**
Migrations run automatically during Render deployment via `build.sh`.

### **Manual (If Needed)**

If you need to run migrations manually on Render:

1. **Via Render Shell:**
   ```bash
   # Open shell in Render dashboard
   flask db upgrade
   ```

2. **Check Migration Status:**
   ```bash
   flask db current
   ```

3. **View Migration History:**
   ```bash
   flask db history
   ```

---

## ğŸ” Troubleshooting

### **Issue: "relation does not exist" errors**

**Cause:** Migrations haven't run yet or failed during deployment.

**Solution:**
1. Check Render build logs for migration errors
2. Manually run migrations via Render shell:
   ```bash
   flask db upgrade
   ```

### **Issue: "PROD_DATABASE_URL is not set"**

**Cause:** Environment variable not configured in Render.

**Solution:**
1. Go to Render Dashboard â†’ Your Service â†’ Environment
2. Verify `PROD_DATABASE_URL` is set correctly
3. Redeploy the service

### **Issue: "Multiple heads detected"**

**Cause:** Conflicting migration branches.

**Solution:**
```bash
# Locally, merge migration heads
flask db merge heads -m "merge_migrations"
git add migrations/
git commit -m "Merge migration heads"
git push origin main
```

### **Issue: Migration fails during deployment**

**Cause:** Database connection issue or invalid migration.

**Solution:**
1. Check database credentials in `PROD_DATABASE_URL`
2. Test connection locally:
   ```bash
   # In .env, temporarily set ENVIRONMENT=production
   python -c "from app import db; print(db.engine.url)"
   ```
3. Review migration files in `migrations/versions/`

---

## ğŸ” Security Best Practices

### **1. Never Commit Production Credentials**

âŒ **Don't do this:**
```bash
git add .env
git commit -m "Add production credentials"
```

âœ… **Do this instead:**
- Keep `.env` in `.gitignore`
- Set environment variables in Render Dashboard
- Use `render.yaml` for configuration (without sensitive values)

### **2. Use Strong Session Secrets**

The `PROD_SESSION_SECRET` is auto-generated by Render. If you need to set it manually:

```bash
python -c "import secrets; print(secrets.token_urlsafe(64))"
```

### **3. Database Connection Security**

Production database URL includes `?sslmode=require` to enforce SSL:
```
postgresql://user:pass@host:5432/db?sslmode=require
```

---

## ğŸ“Š Environment Comparison

| Aspect | Development | Production |
|--------|-------------|------------|
| **Environment Variable** | `ENVIRONMENT=development` | `ENVIRONMENT=production` |
| **Database** | `DEV_DATABASE_URL` (pgnoltrion) | `PROD_DATABASE_URL` (noltrion_hrm) |
| **Session Secret** | `DEV_SESSION_SECRET` | `PROD_SESSION_SECRET` (auto-generated) |
| **SSL Mode** | Optional | Required (`?sslmode=require`) |
| **Migrations** | Manual (`flask db upgrade`) | Automatic (via `build.sh`) |
| **Server** | Flask dev server | Gunicorn (production WSGI) |

---

## ğŸ§ª Testing Production Setup Locally

To test production configuration locally (without affecting production DB):

### **Option 1: Use a Staging Database**

1. Create a staging database on Render
2. Update `.env`:
   ```env
   ENVIRONMENT=production
   PROD_DATABASE_URL=postgresql://staging_db_url_here
   ```
3. Run migrations:
   ```bash
   flask db upgrade
   ```

### **Option 2: Test with Development DB**

1. Keep `.env` as:
   ```env
   ENVIRONMENT=development
   ```
2. Test migrations:
   ```bash
   flask db upgrade
   ```
3. Verify tables are created

---

## ğŸ“ Deployment Checklist

Before deploying to production:

- [ ] All migrations tested locally
- [ ] No conflicting migration heads (`flask db heads`)
- [ ] `.env` file NOT committed to Git
- [ ] `render.yaml` configured with correct environment variables
- [ ] `PROD_DATABASE_URL` points to correct production database
- [ ] `build.sh` is executable (`chmod +x build.sh`)
- [ ] `requirements-render.txt` includes all dependencies
- [ ] Health check endpoint (`/health`) is working
- [ ] Application starts successfully locally

---

## ğŸ†˜ Emergency Rollback

If deployment fails and you need to rollback:

### **1. Rollback Code**
```bash
# In Render Dashboard
# Go to: Deploys â†’ Select previous successful deploy â†’ Redeploy
```

### **2. Rollback Database**

If a migration caused issues:

```bash
# Via Render Shell
flask db downgrade -1  # Rollback one migration
```

Or restore from database backup:
```bash
# In Render Dashboard
# Go to: Database â†’ Backups â†’ Restore
```

---

## ğŸ“š Additional Resources

- **Flask-Migrate Documentation:** https://flask-migrate.readthedocs.io/
- **Render Documentation:** https://render.com/docs
- **PostgreSQL on Render:** https://render.com/docs/databases
- **Alembic (Migration Tool):** https://alembic.sqlalchemy.org/

---

## ğŸ¯ Quick Reference Commands

### **Local Development**
```bash
# Create new migration
flask db migrate -m "description"

# Apply migrations
flask db upgrade

# Check current migration
flask db current

# View migration history
flask db history
```

### **Render Deployment**
```bash
# Push to trigger deployment
git push origin main

# View logs
# Render Dashboard â†’ Logs

# Open shell
# Render Dashboard â†’ Shell â†’ flask db upgrade
```

---

## âœ… Success Indicators

Your deployment is successful when you see:

1. âœ… Build logs show: `âœ… Build completed successfully!`
2. âœ… Migration logs show: `Running upgrade -> [migration_name]`
3. âœ… Application logs show: `ğŸŒ Running in PRODUCTION mode`
4. âœ… Health check returns: `200 OK`
5. âœ… No "relation does not exist" errors
6. âœ… Application is accessible at your Render URL

---

## ğŸ“ Support

If you encounter issues:

1. Check Render build logs
2. Check application logs
3. Review this guide's troubleshooting section
4. Check database connection in Render Dashboard
5. Verify environment variables are set correctly

---

**Last Updated:** 2024
**Version:** 1.0
**Status:** âœ… Production Ready