{% extends "base.html" %}

{% block title %}OT Payroll Summary - Nexar{% endblock %}

{% block head %}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">OT Payroll Summary - Daily Grid</h1>
            <p class="text-muted small mb-0">
                <strong>How it works:</strong> 
                When a Manager APPROVES an OT, it automatically appears here. Simply filter by date, fill the 12 allowance fields, and click SAVE.
            </p>
        </div>
    </div>

    <!-- Filters -->
    <div class="filters-section">
        <div class="filter-group">
            <label for="filterDate">Filter by Date:</label>
            <input type="date" id="filterDate" value="{{ filter_date.isoformat() }}" onchange="filterByDate(this.value)">
        </div>
        <button class="add-employee-btn" onclick="openAddEmployeeModal()">
            <i class="fas fa-plus"></i> Add New
        </button>
    </div>

    <!-- Summary Cards -->
    <div class="summary-header">
        <div class="summary-card">
            <div class="label">Total Records</div>
            <div class="value">{{ stats.total_records }}</div>
        </div>
        <div class="summary-card">
            <div class="label">Total OT Hours</div>
            <div class="value">{{ "%.2f"|format(stats.total_ot_hours) }}</div>
        </div>
        <div class="summary-card">
            <div class="label">Total OT Amount</div>
            <div class="value">â‚¹{{ "%.2f"|format(stats.total_ot_amount) }}</div>
        </div>
        <div class="summary-card">
            <div class="label">Total Allowances</div>
            <div class="value">â‚¹{{ "%.2f"|format(stats.total_allowances) }}</div>
        </div>
        <div class="summary-card">
            <div class="label">Grand Total</div>
            <div class="value">â‚¹{{ "%.2f"|format(stats.total_amount) }}</div>
        </div>
    </div>

    <!-- Grid -->
    {% if ot_records %}
    <div class="grid-wrapper">
        <div class="ot-records-container" id="otGridContainer">
            {% for record in ot_records %}
            <div class="ot-record-card" data-id="{{ record.id }}" data-record-id="{{ record.id }}">
                <!-- Main Info -->
                <div class="record-field">
                    <span class="record-label">Employee</span>
                    <span class="record-value employee-cell">{{ record.employee.first_name }} {{ record.employee.last_name }}</span>
                </div>
                <div class="record-field">
                    <span class="record-label">ID</span>
                    <span class="record-value">{{ record.employee.employee_id }}</span>
                </div>
                <div class="record-field">
                    <span class="record-label">Dept</span>
                    <span class="record-value">{{ record.employee.department if record.employee.department else 'N/A' }}</span>
                </div>
                <div class="record-field">
                    <span class="record-label">OT Hours</span>
                    <input type="number" class="ot-hours-field" value="{{ record.ot_hours }}" step="0.5" min="0">
                </div>
                <div class="record-field">
                    <span class="record-label">Rate/Hr</span>
                    <span class="record-value ot-rate">â‚¹{{ "%.2f"|format(record.ot_rate_per_hour) }}</span>
                </div>
                <div class="record-field">
                    <span class="record-label">OT Amount</span>
                    <span class="record-value ot-amount">â‚¹{{ "%.2f"|format(record.ot_amount) }}</span>
                </div>
                <div class="record-actions">
                    <button type="button" class="calendar-btn" onclick="openCalendarModal({{ record.employee_id }}, '{{ record.employee.first_name }} {{ record.employee.last_name }}')" title="View Daily Breakdown">
                        <i class="fas fa-calendar"></i>
                    </button>
                    <button type="button" class="allowances-toggle" onclick="toggleAllowances(this, {{ record.id }})">
                        <i class="fas fa-chevron-down"></i> Allowances
                    </button>
                </div>
            </div>

            <!-- Allowances Section -->
            <div class="allowances-grid" data-record-id="{{ record.id }}">
                <div class="allowance-input-group">
                    <label>KD & CLAIM</label>
                    <input type="number" class="allowance-field" data-field="kd_and_claim" value="{{ record.kd_and_claim }}" step="0.01" min="0">
                </div>
                <div class="allowance-input-group">
                    <label>TRIPS</label>
                    <input type="number" class="allowance-field" data-field="trips" value="{{ record.trips }}" step="0.01" min="0">
                </div>
                <div class="allowance-input-group">
                    <label>SINPOST</label>
                    <input type="number" class="allowance-field" data-field="sinpost" value="{{ record.sinpost }}" step="0.01" min="0">
                </div>
                <div class="allowance-input-group">
                    <label>SANDSTONE</label>
                    <input type="number" class="allowance-field" data-field="sandstone" value="{{ record.sandstone }}" step="0.01" min="0">
                </div>
                <div class="allowance-input-group">
                    <label>SPX</label>
                    <input type="number" class="allowance-field" data-field="spx" value="{{ record.spx }}" step="0.01" min="0">
                </div>
                <div class="allowance-input-group">
                    <label>PSLE</label>
                    <input type="number" class="allowance-field" data-field="psle" value="{{ record.psle }}" step="0.01" min="0">
                </div>
                <div class="allowance-input-group">
                    <label>MANPOWER</label>
                    <input type="number" class="allowance-field" data-field="manpower" value="{{ record.manpower }}" step="0.01" min="0">
                </div>
                <div class="allowance-input-group">
                    <label>STACKING</label>
                    <input type="number" class="allowance-field" data-field="stacking" value="{{ record.stacking }}" step="0.01" min="0">
                </div>
                <div class="allowance-input-group">
                    <label>DISPOSE</label>
                    <input type="number" class="allowance-field" data-field="dispose" value="{{ record.dispose }}" step="0.01" min="0">
                </div>
                <div class="allowance-input-group">
                    <label>NIGHT</label>
                    <input type="number" class="allowance-field" data-field="night" value="{{ record.night }}" step="0.01" min="0">
                </div>
                <div class="allowance-input-group">
                    <label>PH</label>
                    <input type="number" class="allowance-field" data-field="ph" value="{{ record.ph }}" step="0.01" min="0">
                </div>
                <div class="allowance-input-group">
                    <label>SUN</label>
                    <input type="number" class="allowance-field" data-field="sun" value="{{ record.sun }}" step="0.01" min="0">
                </div>

                <!-- Totals Row -->
                <div>
                    <div class="totals-row">
                        <div class="total-item">
                            <span class="total-label">Total Allowances</span>
                            <span class="total-value total-allowances">â‚¹{{ "%.2f"|format(record.total_allowances) }}</span>
                        </div>
                        <div class="total-item">
                            <span class="total-label">OT Amount</span>
                            <span class="total-value ot-amount">â‚¹{{ "%.2f"|format(record.ot_amount) }}</span>
                        </div>
                        <div class="total-item">
                            <span class="total-label">Grand Total</span>
                            <span class="total-value grand-total">â‚¹{{ "%.2f"|format(record.total_amount) }}</span>
                        </div>
                        <button type="button" class="save-btn" onclick="saveRecord({{ record.id }}, this)">ðŸ’¾ Save</button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <!-- No Records -->
    <div class="grid-wrapper">
        <div class="no-records">
            <div class="no-records-icon">
                <i class="fas fa-inbox"></i>
            </div>
            <h4>No OT Records for {{ filter_date.strftime('%d %b %Y') }}</h4>
            <p class="text-muted mb-3">No approved OT found for this date.</p>
            <div>
                <p>What should happen next?</p>
                <ul>
                    <li>Employee marks OT (OT Management â†’ Mark OT Attendance)</li>
                    <li>Manager approves the OT (OT Management â†’ Manager Approval)</li>
                    <li>âœ¨ <strong>Auto-Magic</strong>: OT record appears here automatically</li>
                    <li>You then fill 12 allowance fields and click SAVE</li>
                </ul>
                <p>
                    ðŸ’¡ Tip: Change the date filter above to check other dates, or wait for a manager to approve an OT.
                </p>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Calendar Modal -->
<div id="calendarModal" class="calendar-modal">
    <div class="calendar-modal-content">
        <div class="calendar-modal-header">
            <h3 id="calendarTitle">Daily Breakdown</h3>
            <button class="close-btn" onclick="closeCalendarModal()">Ã—</button>
        </div>
        <div id="calendarContent"></div>
    </div>
</div>

<!-- Add Employee Modal -->
<div id="addEmployeeModal" class="add-employee-modal">
    <div class="add-employee-modal-content">
        <div class="calendar-modal-header">
            <h3>Add OT Record</h3>
            <button class="close-btn" onclick="closeAddEmployeeModal()">Ã—</button>
        </div>
        <form id="addEmployeeForm" onsubmit="submitAddEmployee(event)">
            <div class="form-group">
                <label for="employeeSelect">Select Employee:</label>
                <select id="employeeSelect" required>
                    <option value="">-- Choose Employee --</option>
                    <!-- Will be populated via AJAX -->
                </select>
            </div>
            <div class="form-group">
                <label for="otDate">OT Date:</label>
                <input type="date" id="otDate" value="{{ filter_date.isoformat() }}" required>
            </div>
            <div class="form-actions">
                <button type="button" class="btn-cancel" onclick="closeAddEmployeeModal()">Cancel</button>
                <button type="submit" class="btn-submit">Add Record</button>
            </div>
        </form>
    </div>
</div>

<script>
// Hide loader on page load
document.addEventListener('DOMContentLoaded', function() {
    const loader = document.getElementById('global-loader');
    if (loader) {
        loader.classList.remove('show');
    }
});

function filterByDate(date) {
    window.location.href = `/ot/daily-summary?date=${date}`;
}

function toggleAllowances(btn, recordId) {
    const allowancesGrid = document.querySelector(`.allowances-grid[data-record-id="${recordId}"]`);
    const icon = btn.querySelector('i');
    
    if (allowancesGrid.classList.contains('show')) {
        allowancesGrid.classList.remove('show');
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
    } else {
        allowancesGrid.classList.add('show');
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-up');
    }
}

function openCalendarModal(employeeId, employeeName) {
    const modal = document.getElementById('calendarModal');
    const title = document.getElementById('calendarTitle');
    const content = document.getElementById('calendarContent');
    
    title.textContent = `Daily Breakdown - ${employeeName}`;
    content.innerHTML = '<div><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
    
    fetch(`/ot/daily-summary/calendar/${employeeId}`)
        .then(response => response.json())
        .then(data => {
            buildCalendarView(data, content);
            modal.classList.add('show');
        })
        .catch(error => {
            console.error('Error:', error);
            content.innerHTML = '<p class="text-danger">Error loading calendar data.</p>';
            modal.classList.add('show');
        });
}

function closeCalendarModal() {
    document.getElementById('calendarModal').classList.remove('show');
}

function buildCalendarView(data, container) {
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const month = data.month;
    const year = data.year;
    
    // Get first day of month and number of days
    const firstDay = new Date(year, month - 1, 1).getDay();
    const daysInMonth = new Date(year, month, 0).getDate();
    
    let html = `<div>
                    ${monthNames[month - 1]} ${year}
                </div>`;
    html += '<div class="calendar-grid">';
    
    // Day headers
    const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    dayHeaders.forEach(day => {
        html += `<div>${day}</div>`;
    });
    
    // Empty cells for days before month starts
    for (let i = 0; i < firstDay; i++) {
        html += '<div class="calendar-day"></div>';
    }
    
    // Days of month
    for (let day = 1; day <= daysInMonth; day++) {
        const dateKey = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayData = data.calendar_data[dateKey];
        
        if (dayData) {
            html += `<div class="calendar-day has-data">
                        <div class="calendar-day-number">${day}</div>
                        <div class="calendar-day-amount">â‚¹${dayData.total.toFixed(2)}</div>
                        <div>${dayData.hours.toFixed(1)}h</div>
                    </div>`;
        } else {
            html += `<div class="calendar-day">
                        <div class="calendar-day-number">${day}</div>
                    </div>`;
        }
    }
    
    html += '</div>';
    container.innerHTML = html;
}

function openAddEmployeeModal() {
    const modal = document.getElementById('addEmployeeModal');
    const employeeSelect = document.getElementById('employeeSelect');
    const otDate = document.getElementById('otDate');
    
    // Clear previous options
    employeeSelect.innerHTML = '<option value="">-- Loading --</option>';
    
    // Fetch employees (you can add filtering here)
    fetch('/api/employees')
        .then(response => response.json())
        .then(employees => {
            employeeSelect.innerHTML = '<option value="">-- Choose Employee --</option>';
            employees.forEach(emp => {
                employeeSelect.innerHTML += `<option value="${emp.id}">${emp.first_name} ${emp.last_name} (${emp.employee_id})</option>`;
            });
        })
        .catch(error => {
            console.error('Error fetching employees:', error);
            employeeSelect.innerHTML = '<option value="">Error loading employees</option>';
        });
    
    modal.classList.add('show');
}

function closeAddEmployeeModal() {
    document.getElementById('addEmployeeModal').classList.remove('show');
}

function submitAddEmployee(event) {
    event.preventDefault();
    
    const employeeId = document.getElementById('employeeSelect').value;
    const otDate = document.getElementById('otDate').value;
    
    if (!employeeId) {
        alert('Please select an employee');
        return;
    }
    
    const formData = new FormData();
    formData.append('employee_id', employeeId);
    formData.append('ot_date', otDate);
    
    fetch('/ot/daily-summary/add', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeAddEmployeeModal();
            location.reload();
        } else {
            alert(data.error || 'Error adding record');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error adding record');
    });
}

function saveRecord(summaryId, btn) {
    const allowancesGrid = btn.closest('.allowances-grid');
    const recordCard = document.querySelector(`.ot-record-card[data-record-id="${summaryId}"]`);
    const formData = new FormData();
    
    // Get OT hours from card
    const otHours = recordCard.querySelector('.ot-hours-field').value;
    formData.append('ot_hours', otHours);
    
    // Get all allowance fields from grid
    allowancesGrid.querySelectorAll('.allowance-field').forEach(field => {
        formData.append(field.dataset.field, field.value);
    });
    
    // Show saving state
    btn.classList.add('saving');
    btn.disabled = true;
    btn.textContent = 'â³ Saving...';
    
    fetch(`/ot/daily-summary/update/${summaryId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update totals display
            const rate = parseFloat(recordCard.querySelector('.ot-rate').textContent.replace('â‚¹', ''));
            const newOtAmount = otHours * rate;
            recordCard.querySelector('.ot-amount').textContent = 'â‚¹' + newOtAmount.toFixed(2);
            
            // Calculate total allowances
            let totalAllowances = 0;
            allowancesGrid.querySelectorAll('.allowance-field').forEach(field => {
                totalAllowances += parseFloat(field.value) || 0;
            });
            
            allowancesGrid.querySelector('.total-allowances').textContent = 'â‚¹' + totalAllowances.toFixed(2);
            
            const grandTotal = newOtAmount + totalAllowances;
            allowancesGrid.querySelector('.grand-total').textContent = 'â‚¹' + grandTotal.toFixed(2);
            
            // Also update OT Amount in totals
            allowancesGrid.querySelector('.ot-amount').textContent = 'â‚¹' + newOtAmount.toFixed(2);
            
            // Restore button
            btn.classList.remove('saving');
            btn.disabled = false;
            btn.textContent = 'ðŸ’¾ Save';
            
            // Show success message
            alert('Record saved successfully!');
        } else {
            alert(data.error || 'Error saving record');
            btn.classList.remove('saving');
            btn.disabled = false;
            btn.textContent = 'ðŸ’¾ Save';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving record');
        btn.classList.remove('saving');
        btn.disabled = false;
        btn.textContent = 'ðŸ’¾ Save';
    });
}

// Close modals when clicking outside
window.onclick = function(event) {
    const calendarModal = document.getElementById('calendarModal');
    const addEmployeeModal = document.getElementById('addEmployeeModal');
    
    if (event.target === calendarModal) {
        calendarModal.classList.remove('show');
    }
    if (event.target === addEmployeeModal) {
        addEmployeeModal.classList.remove('show');
    }
};
</script>
{% endblock %}