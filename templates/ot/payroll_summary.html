{% extends "base.html" %}

{% block title %}OT Payroll Summary - Nexar{% endblock %}

{% block head %}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col">
            <h1 class="h3 fw-bold">
                <i class="fas fa-dollar-sign"></i>
                OT Payroll Summary
            </h1>
            <p class="text-muted mb-0">Monthly overtime payroll breakdown and analysis</p>
        </div>
    </div>

    <!-- Filters -->
    <div class="summary-container mb-4">
        <form method="GET" action="{{ url_for('ot_payroll_summary') }}" class="month-selector">
            <div class="form-group-inline">
                <label for="company">Company</label>
                <select name="company_id" id="company" onchange="this.form.submit()">
                    <option value="">-- Select Company --</option>
                    {% for company in available_companies %}
                    <option value="{{ company.id }}" {% if selected_company_id and selected_company_id|string == company.id|string %}selected{% elif not selected_company_id and loop.first %}selected{% endif %}>{{ company.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group-inline">
                <label for="user">User Name</label>
                <select name="user_id" id="user" onchange="this.form.submit()">
                    <option value="">-- All Users --</option>
                    {% for employee in available_employees %}
                    <option value="{{ employee.id }}" {% if selected_user_id == employee.id|string %}selected{% endif %}>{{ employee.first_name }} {{ employee.last_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group-inline">
                <label for="month">Month</label>
                <select name="month" id="month" onchange="this.form.submit()">
                    <option value="1" {% if month == 1 %}selected{% endif %}>January</option>
                    <option value="2" {% if month == 2 %}selected{% endif %}>February</option>
                    <option value="3" {% if month == 3 %}selected{% endif %}>March</option>
                    <option value="4" {% if month == 4 %}selected{% endif %}>April</option>
                    <option value="5" {% if month == 5 %}selected{% endif %}>May</option>
                    <option value="6" {% if month == 6 %}selected{% endif %}>June</option>
                    <option value="7" {% if month == 7 %}selected{% endif %}>July</option>
                    <option value="8" {% if month == 8 %}selected{% endif %}>August</option>
                    <option value="9" {% if month == 9 %}selected{% endif %}>September</option>
                    <option value="10" {% if month == 10 %}selected{% endif %}>October</option>
                    <option value="11" {% if month == 11 %}selected{% endif %}>November</option>
                    <option value="12" {% if month == 12 %}selected{% endif %}>December</option>
                </select>
            </div>
            <div class="form-group-inline">
                <label for="year">Year</label>
                <select name="year" id="year" onchange="this.form.submit()">
                    {% for y in range(year - 2, year + 3) %}
                    <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
            </div>
        </form>
    </div>

    <!-- Summary Statistics -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Total Hours</div>
            <div class="stat-value">{{ "%.2f"|format(total_hours) }}</div>
            <div class="stat-label">hours</div>
        </div>
        <div class="stat-card secondary">
            <div class="stat-label">Total Amount</div>
            <div class="stat-value">â‚¹{{ "%.2f"|format(total_amount) }}</div>
            <div class="stat-label">payroll</div>
        </div>
        <div class="stat-card tertiary">
            <div class="stat-label">OT Types</div>
            <div class="stat-value">{{ summary|length }}</div>
            <div class="stat-label">categories</div>
        </div>
        <div class="stat-card quaternary">
            <div class="stat-label">Average Rate</div>
            <div class="stat-value">
                {% if total_hours > 0 %}
                    â‚¹{{ "%.2f"|format(total_amount / total_hours) }}
                {% else %}
                    â‚¹0.00
                {% endif %}
            </div>
            <div class="stat-label">/hour</div>
        </div>
    </div>

    <!-- Export Buttons -->
    <div class="export-buttons">
        <button class="btn-export primary" onclick="exportToCSV()">
            <i class="fas fa-download"></i>
            Export CSV
        </button>
        <button class="btn-export primary" onclick="exportToPDF()">
            <i class="fas fa-file-pdf"></i>
            Export PDF
        </button>
        <button class="btn-export" onclick="syncToPayroll()">
            <i class="fas fa-sync"></i>
            Sync to Payroll
        </button>
    </div>

    <!-- Summary Table -->
    {% if summary %}
    <div class="summary-table">
        <table class="table">
            <thead>
                <tr>
                    <th>OT Type</th>
                    <th>Count</th>
                    <th>Hours</th>
                    <th>Rate/Hour</th>
                    <th>Amount</th>
                </tr>
            </thead>
            <tbody>
                {% for ot_type, data in summary.items() %}
                <tr>
                    <td><strong>{{ ot_type }}</strong></td>
                    <td>{{ data.count }}</td>
                    <td>{{ "%.2f"|format(data.hours) }}</td>
                    <td>â‚¹{{ "%.2f"|format(data.rate_per_hour) }}</td>
                    <td>â‚¹{{ "%.2f"|format(data.amount) }}</td>
                </tr>
                {% endfor %}
                <tr class="total-row">
                    <td><strong>Total</strong></td>
                    <td>{{ summary.values()|map(attribute='count')|sum }}</td>
                    <td>{{ "%.2f"|format(total_hours) }}</td>
                    <td>-</td>
                    <td>â‚¹{{ "%.2f"|format(total_amount) }}</td>
                </tr>
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="no-data">
        <div class="no-data-icon">ðŸ“­</div>
        <h4>No OT Data Available</h4>
        <p>No overtime approvals found for the selected month/year.</p>
    </div>
    {% endif %}
</div>

<script>
    function exportToCSV() {
        alert('CSV export functionality to be implemented');
    }
    
    function exportToPDF() {
        alert('PDF export functionality to be implemented');
    }
    
    function syncToPayroll() {
        alert('Payroll sync functionality to be implemented');
    }
</script>
{% endblock %}