{% extends "base.html" %}

{% block title %}Manager OT Approval Dashboard - Nexar{% endblock %}

{% block head %}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center gap-2">
            <img src="{{ url_for('static', filename='img/nexar_icon.png') }}" alt="Nexar Icon" height="28">
            <div>
                <h1 class="h3 mb-1">OT Manager Approval Dashboard</h1>
                <p class="text-muted small mb-0">Approve or reject overtime requests from your team</p>
            </div>
        </div>
        {% if pending_approvals.total > 0 %}
        <div>
            <span class="badge bg-warning text-dark">
                {{ pending_approvals.total }} Pending Request{{ 's' if pending_approvals.total != 1 else '' }}
            </span>
        </div>
        {% endif %}
    </div>

    <!-- Statistics -->
    {% if stats %}
    <div class="stats-container">
        <div class="stat-card">
            <div class="stat-number">{{ stats.pending or 0 }}</div>
            <div class="stat-label">Pending Approvals</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.approved or 0 }}</div>
            <div class="stat-label">Approved</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.rejected or 0 }}</div>
            <div class="stat-label">Rejected</div>
        </div>
    </div>
    {% endif %}

    <!-- Pending Approvals -->
    {% if pending_approvals.items %}
    {% for approval in pending_approvals.items %}
    <div class="approval-card">
        <!-- Card Header -->
        <div class="approval-header">
            <div class="employee-info">
                <div class="avatar-placeholder">
                    {{ approval.ot_request.employee.first_name[0] if approval.ot_request.employee.first_name else 'E' }}
                </div>
                <div class="employee-details">
                    <p class="employee-name">{{ approval.ot_request.employee.first_name }} {{
                        approval.ot_request.employee.last_name }}</p>
                    <p class="employee-meta">ID: {{ approval.ot_request.employee.employee_id or 'N/A' }} | Dept: {{
                        approval.ot_request.employee.department if approval.ot_request.employee.department else 'N/A' }}
                    </p>
                </div>
            </div>
            <div>
                <span class="badge bg-info text-white">Pending Your Approval</span>
            </div>
        </div>

        <!-- Approval Details -->
        <div class="approval-content">
            <div class="info-item">
                <span class="info-label">Hours Requested</span>
                <span class="info-value">{{ approval.ot_request.requested_hours or 0 }} hrs</span>
            </div>
            <div class="info-item">
                <span class="info-label">OT Date</span>
                <span class="info-value">{{ approval.ot_request.ot_date.strftime('%d %b %Y') if
                    approval.ot_request.ot_date else '-' }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">OT Type</span>
                <span class="info-value">{{ approval.ot_request.ot_type.name if approval.ot_request.ot_type else
                    'General' }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Requested On</span>
                <span class="info-value">{{ approval.ot_request.created_at.strftime('%d %b %Y') if
                    approval.ot_request.created_at else '-' }}</span>
            </div>
        </div>

        <!-- Reason -->
        {% if approval.ot_request.reason %}
        <div class="alert alert-info mb-3">
            <strong>Reason:</strong> {{ approval.ot_request.reason }}
        </div>
        {% endif %}

        <!-- Approval Form -->
        <form method="POST" action="{{ url_for('ot_manager_approval') }}" class="action-form">
            <input type="hidden" name="ot_request_id" value="{{ approval.ot_request.id }}">
            <input type="hidden" name="action" id="action_{{ approval.id }}" value="">

            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="comments_{{ approval.id }}" class="form-label small">Comments</label>
                    <textarea class="form-control" id="comments_{{ approval.id }}" name="comments" rows="3"
                        placeholder="Add comments..."></textarea>
                </div>
                <div class="col-md-6">
                    <label for="modified_hours_{{ approval.id }}" class="form-label small">Modified Hours
                        (Optional)</label>
                    <input type="number" class="form-control" id="modified_hours_{{ approval.id }}"
                        name="modified_hours" step="0.5" min="0"
                        placeholder="Leave empty to keep original ({{ approval.ot_request.requested_hours or 0 }} hrs)">
                </div>
            </div>

            <div class="action-buttons">
                <button type="submit" class="btn btn-success btn-sm"
                    onclick="submitAction(event, 'approve', '{{ approval.id }}')">
                    <i class="fas fa-check"></i> Approve
                </button>
                <button type="submit" class="btn btn-danger btn-sm"
                    onclick="submitAction(event, 'reject', '{{ approval.id }}')">
                    <i class="fas fa-times"></i> Reject
                </button>
                {% if approval.ot_request.requested_hours %}
                <button type="button" class="btn btn-warning btn-sm" onclick="toggleModify('{{ approval.id }}')">
                    <i class="fas fa-edit"></i> Modify Hours
                </button>
                {% endif %}
            </div>
        </form>
    </div>
    {% endfor %}

    <!-- Pagination -->
    {% if pending_approvals.pages > 1 %}
    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination">
            {% if pending_approvals.has_prev %}
            <li class="page-item">
                <a class="page-link"
                    href="{{ url_for('ot_manager_approval', page=pending_approvals.prev_num) }}">Previous</a>
            </li>
            {% endif %}

            {% for page_num in pending_approvals.iter_pages(left_edge=1, left_margin=1, right_margin=1, right_edge=1) %}
            {% if page_num %}
            {% if page_num == pending_approvals.page %}
            <li class="page-item active">
                <span class="page-link">{{ page_num }}</span>
            </li>
            {% else %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('ot_manager_approval', page=page_num) }}">{{ page_num }}</a>
            </li>
            {% endif %}
            {% endif %}
            {% endfor %}

            {% if pending_approvals.has_next %}
            <li class="page-item">
                <a class="page-link"
                    href="{{ url_for('ot_manager_approval', page=pending_approvals.next_num) }}">Next</a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}

    {% else %}
    <!-- No Pending Approvals -->
    <div class="approval-card no-requests">
        <div class="no-requests-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <h5 class="text-muted">No Pending Approvals</h5>
        <p class="text-muted small">All overtime requests from your team have been reviewed.</p>
    </div>
    {% endif %}
</div>

<script>
    // Hide loader on page load
    document.addEventListener('DOMContentLoaded', function () {
        const loader = document.getElementById('global-loader');
        if (loader) {
            loader.classList.remove('show');
        }
    });

    // Submit action - sets the hidden field and shows loader
    function submitAction(event, action, approvalId) {
        event.preventDefault();

        // Set the hidden action field
        const actionField = document.getElementById('action_' + approvalId);
        if (actionField) {
            actionField.value = action;
        }

        // Show loader
        const loader = document.getElementById('global-loader');
        if (loader) {
            loader.classList.add('show');
        }

        // Submit the form
        event.target.closest('form').submit();
    }

    // Toggle modify hours input
    function toggleModify(approvalId) {
        const input = document.getElementById('modified_hours_' + approvalId);
        if (input.style.display === 'none') {
            input.style.display = 'block';
            input.focus();
        } else {
            input.style.display = 'none';
        }
    }
</script>
{% endblock %}