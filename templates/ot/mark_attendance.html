{% extends "base.html" %}

{% block title %}Mark OT Attendance - Nexar{% endblock %}

{% block head %}
<style>
    /* Custom Styles for Log & Go Interface */
    .log-and-go-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        padding: 20px;
    }

    @media (max-width: 768px) {
        .log-and-go-container {
            grid-template-columns: 1fr;
        }
    }

    .lg-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        border: 1px solid #e2e8f0;
        overflow: hidden;
    }

    .lg-card-header {
        background: #f8fafc;
        padding: 15px 20px;
        border-bottom: 1px solid #e2e8f0;
        font-weight: 600;
        color: #1e293b;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .lg-card-body {
        padding: 20px;
    }

    .calc-row {
        display: flex;
        justify-content: space-between;
        background: #f0f9ff;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
        margin-bottom: 20px;
        border: 1px solid #bfdbfe;
    }

    .calc-item {
        text-align: center;
    }

    .calc-label {
        font-size: 0.8rem;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .calc-value {
        font-size: 1.2rem;
        font-weight: bold;
        color: #0f172a;
    }

    .log-list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        border-bottom: 1px solid #f1f5f9;
    }

    .log-list-item:last-child {
        border-bottom: none;
    }

    .log-details {
        display: flex;
        flex-direction: column;
    }

    .log-main {
        font-weight: 600;
        color: #334155;
    }

    .log-sub {
        font-size: 0.85rem;
        color: #64748b;
    }

    .log-actions {
        display: flex;
        gap: 8px;
    }

    .badge-draft {
        background: #e2e8f0;
        color: #475569;
        font-size: 0.75rem;
        padding: 2px 8px;
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="header-title">
        <h4>Log OT Attendance</h4>
    </div>
</div>

{% if not has_manager %}
<div class="alert alert-danger mx-3 mt-3 px-3">
    <i class="fas fa-exclamation-triangle me-2"></i>
    <strong>Action Required:</strong> You cannot submit OT requests because no reporting manager is assigned to your
    Employee Profile.
    Please contact your HR Manager to assign a reporting manager.
</div>
{% endif %}

<div class="log-and-go-container">
    <!-- LEFT: Input Form -->
    <div class="lg-card">
        <div class="lg-card-header">
            <span><i class="fas fa-plus-circle"></i> New Entry</span>
            <span id="currentDateDisplay" class="text-muted" style="font-weight: normal; font-size: 0.9rem;"></span>
        </div>
        <div class="lg-card-body">
            <form id="logOtForm">
                <div class="form-group mb-3">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-control" id="ot_date" name="ot_date" value="{{ today }}">
                </div>

                <div class="form-group mb-3">
                    <label class="form-label">OT Type</label>
                    <select class="form-control" id="ot_type_id" name="ot_type_id" required
                        onchange="calculatePreview()">
                        <option value="" data-multiplier="0">-- Select Type --</option>
                        {% for type in ot_types %}
                        <option value="{{ type.id }}" data-multiplier="{{ type.rate_multiplier }}">
                            {{ type.name }} ({{ type.rate_multiplier }}x)
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group mb-3">
                    <label class="form-label">Rate</label>
                    <input type="number" class="form-control" id="rate" name="rate" placeholder="e.g. 1.5"
                        step="0.01" min="0" oninput="calculatePreview()">
                </div>

                <div class="form-group mb-3">
                    <label class="form-label">Quantity (Hours/Units)</label>
                    <input type="number" class="form-control" id="quantity" name="quantity" placeholder="e.g. 2.0"
                        step="0.1" min="0.1" required oninput="calculatePreview()">
                </div>

                <div class="form-group mb-3">
                    <label class="form-label">Notes (Optional)</label>
                    <input type="text" class="form-control" id="notes" name="notes" placeholder="Task description...">
                </div>

                <!-- Live Calculation Preview -->
                <div class="calc-row">
                    <!-- Removed Estimate Rate & Multiplier Display -->
                    <div class="calc-item w-100">
                        <div class="calc-label">Total Amount</div>
                        <div class="calc-value text-primary" id="previewTotal">$0.00</div>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary w-100 py-2">
                    <i class="fas fa-check"></i> Log Entry
                </button>
            </form>
        </div>
    </div>

    <!-- RIGHT: Today's Logs -->
    <div class="lg-card">
        <div class="lg-card-header">
            <span><i class="fas fa-list"></i> Today's Logs</span>
            <span class="badge bg-light text-dark">{{ today }}</span>
        </div>
        <div class="lg-card-body p-0">
            <div id="todayLogsList">
                {% if today_logs %}
                {% for log in today_logs %}
                <div class="log-list-item" id="log-{{ log.id }}">
                    <div class="log-details">
                        <span class="log-main">{{ log.ot_type.name }} â€¢ {{ log.quantity }} Units</span>
                        <span class="log-sub">
                            ${{ log.amount }}
                            {% if log.status == 'Draft' %}<span class="badge-draft">Draft</span>{% endif %}
                            {% if log.status == 'Submitted' %}<span class="badge bg-success"
                                style="font-size: 0.7rem;">Submitted</span>{% endif %}
                        </span>
                    </div>
                    <div class="log-actions">
                        {% if log.status == 'Draft' %}
                        {% if has_manager %}
                        <form action="{{ url_for('submit_ot_attendance', attendance_id=log.id) }}" method="POST"
                            onsubmit="return confirm('Submit this entry?');" style="display:inline;">
                            <button type="submit" class="btn btn-sm btn-outline-success" title="Submit">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </form>
                        {% else %}
                        <button class="btn btn-sm btn-outline-secondary" disabled title="Manager required to submit">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                        {% endif %}
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteEntry({{ log.id }})"
                            title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                        {% elif log.status == 'Submitted' or log.status == 'pending_manager' %}
                        <span class="badge bg-warning text-dark"><i class="fas fa-clock"></i> Pending Manager</span>
                        {% elif log.status == 'manager_approved' %}
                        <span class="badge bg-info text-white"><i class="fas fa-check"></i> Manager Approved</span>
                        {% elif log.status == 'manager_rejected' %}
                        <span class="badge bg-danger text-white"><i class="fas fa-times"></i> Manager Rejected</span>
                        {% elif log.status == 'Approved' or log.status == 'hr_approved' %}
                        <span class="badge bg-success text-white"><i class="fas fa-check-double"></i> Approved</span>
                        {% elif log.status == 'Rejected' or log.status == 'hr_rejected' %}
                        <span class="badge bg-danger text-white"><i class="fas fa-times-circle"></i> Rejected</span>
                        {% else %}
                        <span class="text-muted small"><i class="fas fa-lock"></i> {{ log.status }}</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="text-center p-4 text-muted">
                    <i class="fas fa-clipboard-list fa-2x mb-2" style="opacity: 0.3;"></i>
                    <p>No OT entries for today yet.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Recent History Section -->
<div class="mt-4 px-3">
    <h5 class="mb-3 text-muted">Recent History</h5>
    <div class="lg-card">
        <div class="lg-card-body p-0">
            <table class="table table-hover mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-4">Date</th>
                        <th>Type</th>
                        <th>Qty</th>
                        <th>Amount</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in recent_history %}
                    <tr>
                        <td class="ps-4">{{ log.ot_date }}</td>
                        <td>{{ log.ot_type.name }}</td>
                        <td>{{ log.quantity }}</td>
                        <td>${{ log.amount }}</td>
                        <td>
                            <span
                                class="badge bg-{{ 'secondary' if log.status=='Draft' else 'success' if log.status=='Approved' else 'warning' if log.status=='Submitted' else 'danger' }}">
                                {{ log.status }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const HOURLY_RATE = {{ hourly_rate if hourly_rate else 0 }};

    // Calculate preview values
    // Calculate preview values
    function calculatePreview() {
        // Simplified Logic: Total = Rate * Quantity
        const rate = parseFloat(document.getElementById('rate').value || 0);
        const quantity = parseFloat(document.getElementById('quantity').value || 0);
        
        const totalAmount = rate * quantity;

        document.getElementById('previewTotal').innerText = '$' + totalAmount.toFixed(2);
    }
    
    // Update Rate when Type Changes
    document.getElementById('ot_type_id').addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const multiplier = parseFloat(selectedOption.getAttribute('data-multiplier') || 0);
        
        // Populate Rate input with Multiplier (User can override)
        document.getElementById('rate').value = multiplier.toFixed(2);
        calculatePreview();
    });

    // Handle Form Submission (AJAX)
    document.getElementById('logOtForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const btn = this.querySelector('button[type="submit"]');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging...';

        const formData = {
            ot_date: document.getElementById('ot_date').value,
            ot_type_id: document.getElementById('ot_type_id').value,
            rate: document.getElementById('rate').value,
            quantity: document.getElementById('quantity').value,
            notes: document.getElementById('notes').value
        };

        try {
            const response = await fetch('/api/ot/log-entry', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });

            const result = await response.json();

            if (result.success) {
                // Determine if we should reload nicely or hard reload
                // Since simpler to implement valid reload for now:
                window.location.reload();
            } else {
                alert('Error: ' + result.message);
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while logging OT.');
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    });

    // Handle Delete Entry
    async function deleteEntry(id) {
        if (!confirm('Are you sure you want to delete this draft?')) return;

        try {
            const response = await fetch(`/api/ot/delete-entry/${id}`, {
                method: 'POST'
            });
            const result = await response.json();

            if (result.success) {
                // Remove element from DOM
                const row = document.getElementById(`log-${id}`);
                if (row) row.remove();

                // If list empty, maybe reload or show empty state (optional)
                if (document.querySelectorAll('.log-list-item').length === 0) {
                    window.location.reload();
                }
            } else {
                alert('Error deleting: ' + result.message);
            }
        } catch (e) {
            console.error(e);
            alert('Failed to delete entry');
        }
    }
</script>
{% endblock %}