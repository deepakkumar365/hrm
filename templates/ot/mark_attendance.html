{% extends "base.html" %}

{% block title %}Mark OT Attendance - Nexar{% endblock %}

{% block head %}
<style>
    * {
        font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif !important;
    }

    body {
        background-color: #f5f5f5;
        overflow: hidden;
        height: 100vh;
    }

    .ot-mark-container {
        width: 95%;
        margin: 0.5rem auto;
        padding: 1rem;
        background: white;
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        height: calc(100vh - 60px);
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    /* Header Section */
    .ot-header {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        color: white;
        padding: 1rem;
        border-radius: 6px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .ot-header-title {
        font-size: 1.3rem;
        font-weight: 700;
        margin: 0;
    }

    .ot-header-info {
        display: flex;
        gap: 2rem;
        align-items: center;
        font-size: 0.9rem;
    }

    .ot-header-info-item {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .ot-header-info-label {
        font-weight: 600;
        opacity: 0.9;
    }

    /* Alerts */
    .alerts-section {
        flex-shrink: 0;
    }

    /* Form Content Section */
    .form-content {
        flex: 1;
        overflow-y: auto;
        padding-right: 0.5rem;
    }

    .form-content::-webkit-scrollbar {
        width: 6px;
    }

    .form-content::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    .form-content::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 3px;
    }

    .form-content::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    /* Alerts */
    .alert {
        padding: 0.6rem;
        border-radius: 4px;
        margin-bottom: 0.5rem;
        font-size: 0.8rem;
    }

    .alert-info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }

    .alert-warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
    }

    /* Two Column Form Layout */
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .form-column {
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
    }

    .form-section {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .form-section-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: #2c3e50;
        border-bottom: 2px solid #2c3e50;
        padding-bottom: 0.3rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
    }

    .form-group label {
        font-weight: 500;
        font-size: 0.8rem;
        color: #333;
    }

    .form-control, .form-select {
        font-size: 0.8rem;
        padding: 0.4rem 0.6rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        height: auto;
    }

    .form-control:focus, .form-select:focus {
        outline: none;
        border-color: #2c3e50;
        box-shadow: 0 0 0 2px rgba(44, 62, 80, 0.1);
    }

    .input-switch {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        flex-wrap: wrap;
    }

    .btn-switch {
        padding: 0.3rem 0.8rem;
        border: 1px solid #ccc;
        background: #f8f9fa;
        cursor: pointer;
        border-radius: 4px;
        transition: all 0.2s;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .btn-switch.active {
        background: #2c3e50;
        color: white;
        border-color: #2c3e50;
    }

    .time-input-group {
        display: flex;
        flex-direction: row;
        gap: 1rem;
        align-items: flex-start;
    }

    .hidden {
        display: none;
    }

    .text-muted {
        font-size: 0.7rem;
        color: #666;
    }

    small {
        font-size: 0.7rem;
        color: #666;
    }

    /* Buttons Section */
    .buttons-section {
        text-align: center;
        padding: 1rem;
        border-top: 2px solid #2c3e50;
        background: #f8f9fa;
        border-radius: 4px;
        flex-shrink: 0;
        margin-top: 0.5rem;
    }

    .btn-submit {
        background: #27ae60;
        color: white;
        padding: 0.6rem 2rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 700;
        transition: all 0.2s;
        font-size: 0.85rem;
        margin-right: 1rem;
        box-shadow: 0 2px 4px rgba(39, 174, 96, 0.3);
    }

    .btn-submit:hover {
        background: #229954;
        box-shadow: 0 4px 8px rgba(39, 174, 96, 0.4);
        transform: translateY(-1px);
    }

    .btn-reset {
        background: #7f8c8d;
        color: white;
        padding: 0.6rem 2rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 700;
        transition: all 0.2s;
        font-size: 0.85rem;
        box-shadow: 0 2px 4px rgba(127, 140, 141, 0.3);
    }

    .btn-reset:hover {
        background: #6c7a7d;
        box-shadow: 0 4px 8px rgba(127, 140, 141, 0.4);
        transform: translateY(-1px);
    }

    .btn-reset:disabled {
        background: #9a9a9a;
        cursor: not-allowed;
    }

    .btn-submit:disabled {
        background: #95a5a6;
        cursor: not-allowed;
    }

    /* Time Now Button */
    .btn-now {
        background: #3498db;
        color: white;
        padding: 0.4rem 0.8rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: background 0.2s;
        font-size: 0.75rem;
        white-space: nowrap;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .btn-now:hover {
        background: #2980b9;
    }

    .btn-now:disabled {
        background: #95a5a6;
        cursor: not-allowed;
    }

    /* Time Input with Button Group */
    .time-input-wrapper {
        display: flex;
        flex-direction: row;
        gap: 0.4rem;
        align-items: flex-end;
        flex: 1;
        min-width: 0;
    }

    .time-input-wrapper .form-group {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
    }

    .time-input-wrapper .form-group label {
        font-weight: 500;
        font-size: 0.8rem;
        color: #333;
        margin: 0;
        display: block;
    }

    .time-input-wrapper input[type="time"] {
        width: 100%;
        box-sizing: border-box;
        font-size: 0.8rem;
        padding: 0.4rem 0.6rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        height: 32px;
    }

    .time-input-wrapper input[type="time"]:focus {
        outline: none;
        border-color: #2c3e50;
        box-shadow: 0 0 0 2px rgba(44, 62, 80, 0.1);
    }

    /* Recent OT Records Grid Section */
    .recent-ots-wrapper {
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        height: 35%;
        border-top: 2px solid #e0e0e0;
        padding-top: 1rem;
    }

    .recent-ots-header {
        font-size: 0.95rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 0.8rem;
        flex-shrink: 0;
    }

    .recent-ots {
        flex: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        padding-right: 0.5rem;
    }

    .recent-ots::-webkit-scrollbar {
        width: 6px;
    }

    .recent-ots::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    .recent-ots::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 3px;
    }

    .recent-ots::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    .ot-record-item {
        padding: 0.6rem;
        background: #f9f9f9;
        border-radius: 4px;
        display: grid;
        grid-template-columns: 1.2fr 0.8fr 0.8fr 1.2fr;
        gap: 0.8rem;
        align-items: center;
        border: 1px solid #e0e0e0;
        font-size: 0.8rem;
        transition: background 0.2s;
    }

    .ot-record-item:hover {
        background: #f0f0f0;
    }

    .ot-record-date {
        font-weight: 600;
        color: #2c3e50;
    }

    .ot-record-type {
        color: #666;
        font-size: 0.75rem;
    }

    .ot-record-hours {
        font-weight: 600;
        color: #27ae60;
    }

    .ot-record-status {
        padding: 0.3rem 0.6rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
        text-align: center;
    }

    .status-draft {
        background: #e7f3ff;
        color: #004085;
    }

    .status-submitted {
        background: #fff3cd;
        color: #856404;
    }

    .status-approved {
        background: #d4edda;
        color: #155724;
    }

    .status-rejected {
        background: #f8d7da;
        color: #721c24;
    }

    .ot-record-action {
        display: flex;
        gap: 0.3rem;
        justify-content: flex-end;
    }

    .ot-record-action .btn {
        padding: 0.3rem 0.6rem;
        font-size: 0.75rem;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .ot-record-action .btn-primary {
        background: #3498db;
        color: white;
    }

    .ot-record-action .btn-primary:hover {
        background: #2980b9;
    }

    .ot-record-action .badge {
        background: #27ae60;
        color: white;
        padding: 0.3rem 0.6rem;
        border-radius: 3px;
        font-size: 0.75rem;
    }

    /* No records message */
    .no-records {
        text-align: center;
        color: #999;
        padding: 1rem;
        font-size: 0.8rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="ot-mark-container">
    <!-- Header with Title and Employee Info -->
    <div class="ot-header">
        <div class="ot-header-title">
            <i class="fas fa-hourglass-end"></i> Mark OT Attendance
        </div>
        <div class="ot-header-info">
            <div class="ot-header-info-item">
                <span class="ot-header-info-label">Employee:</span>
                <span>{{ employee.first_name }} {{ employee.last_name }}</span>
            </div>
            <div class="ot-header-info-item">
                <span class="ot-header-info-label">ID:</span>
                <span>{{ employee.employee_id }}</span>
            </div>
            <div class="ot-header-info-item">
                <span class="ot-header-info-label">Department:</span>
                <span>{{ employee.department.name if employee.department else 'N/A' }}</span>
            </div>
        </div>
    </div>

    <!-- Alerts Section -->
    <div class="alerts-section">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    {% if category == 'warning' %}
                        <div class="alert alert-warning">
                            {{ message | safe }}
                        </div>
                    {% else %}
                        <div class="alert alert-{{ 'success' if category == 'success' else 'danger' if category == 'danger' else 'info' }}">
                            {{ message }}
                        </div>
                    {% endif %}
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <!-- Form Content Section -->
    <div class="form-content">
        <!-- Mark OT Form -->
        {% if has_ot_types %}
        <form method="POST" id="otForm">
        {% else %}
        <form method="POST" id="otForm" style="opacity: 0.6; pointer-events: none;">
        {% endif %}
            <!-- First Row: Date & Time (Left) | OT Hours Entry (Right) -->
            <div class="form-row">
                <!-- Left Column: Date & Time -->
                <div class="form-column">
                    <div class="form-section">
                        <div class="form-section-title">Date & Time</div>
                        <div class="form-group">
                            <label for="ot_date">OT Date *</label>
                            <input type="date" class="form-control" id="ot_date" name="ot_date" 
                                   value="{{ today }}" required {% if not has_ot_types %}disabled{% endif %}>
                            <small class="text-muted">Select the date you worked overtime</small>
                        </div>
                    </div>
                </div>

                <!-- Right Column: OT Hours Entry -->
                <div class="form-column">
                    <div class="form-section">
                        <div class="form-section-title">OT Hours Entry</div>
                        
                        <div class="input-switch">
                            <button type="button" class="btn-switch active" onclick="switchMode('time')">
                                <i class="fas fa-clock"></i> Time (In/Out)
                            </button>
                            <button type="button" class="btn-switch" onclick="switchMode('hours')">
                                <i class="fas fa-calculator"></i> Direct Hours
                            </button>
                        </div>

                        <!-- Time Input Mode -->
                        <div id="timeMode" class="time-input-group">
                            <div class="time-input-wrapper">
                                <div class="form-group">
                                    <label for="ot_in_time">In Time</label>
                                    <input type="time" class="form-control" id="ot_in_time" name="ot_in_time" 
                                           {% if not has_ot_types %}disabled{% endif %}>
                                </div>
                                <button type="button" class="btn-now" onclick="setCurrentTime('ot_in_time')" 
                                        {% if not has_ot_types %}disabled{% endif %}>
                                    <i class="fas fa-clock"></i> Now
                                </button>
                            </div>
                            <div class="time-input-wrapper">
                                <div class="form-group">
                                    <label for="ot_out_time">Out Time</label>
                                    <input type="time" class="form-control" id="ot_out_time" name="ot_out_time"
                                           {% if not has_ot_types %}disabled{% endif %}>
                                </div>
                                <button type="button" class="btn-now" onclick="setCurrentTime('ot_out_time')" 
                                        {% if not has_ot_types %}disabled{% endif %}>
                                    <i class="fas fa-clock"></i> Now
                                </button>
                            </div>
                        </div>

                        <!-- Hours Input Mode -->
                        <div id="hoursMode" class="hidden">
                            <div class="form-group">
                                <label for="ot_hours">OT Hours *</label>
                                <input type="number" class="form-control" id="ot_hours" name="ot_hours" 
                                       step="0.5" min="0" placeholder="e.g., 2, 2.5, 3"
                                       {% if not has_ot_types %}disabled{% endif %}>
                                <small class="text-muted">Total overtime hours</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Second Row: OT Type (Left) | Additional Information (Right) -->
            <div class="form-row">
                <!-- Left Column: OT Type -->
                <div class="form-column">
                    <div class="form-section">
                        <div class="form-section-title">OT Type</div>
                        <div class="form-group">
                            <label for="ot_type_id">OT Type *</label>
                            <select class="form-control" id="ot_type_id" name="ot_type_id" required 
                                    {% if not has_ot_types %}disabled{% endif %}>
                                <option value="">-- Select OT Type --</option>
                                {% for ot_type in ot_types %}
                                    <option value="{{ ot_type.id }}">
                                        {{ ot_type.name }} ({{ ot_type.rate_multiplier }}x)
                                    </option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Select the type of overtime</small>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Additional Information -->
                <div class="form-column">
                    <div class="form-section">
                        <div class="form-section-title">Additional Information</div>
                        <div class="form-group">
                            <label for="notes">Notes/Reason</label>
                            <textarea class="form-control" id="notes" name="notes" rows="2" 
                                      placeholder="Why was overtime required?" 
                                      {% if not has_ot_types %}disabled{% endif %}></textarea>
                            <small class="text-muted">Optional context for this OT record</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Buttons Section -->
            <div class="buttons-section">
                <button type="submit" class="btn-submit" {% if not has_ot_types %}disabled{% endif %}>
                    <i class="fas fa-save"></i> Save OT Attendance
                </button>
                <button type="reset" class="btn-reset" {% if not has_ot_types %}disabled{% endif %}>
                    <i class="fas fa-redo"></i> Clear Form
                </button>
            </div>
        </form>
    </div>

    <!-- Recent OT Records Grid Section -->
    {% if recent_ots %}
    <div class="recent-ots-wrapper">
        <div class="recent-ots-header">
            <i class="fas fa-history"></i> Your Recent OT Records (Last 10)
        </div>
        <div class="recent-ots">
            {% for ot in recent_ots %}
            <div class="ot-record-item">
                <div>
                    <div class="ot-record-date">{{ ot.ot_date.strftime('%d %b %Y') }}</div>
                    <div class="ot-record-type">{{ ot.ot_type.name if ot.ot_type else 'N/A' }}</div>
                </div>
                <div class="ot-record-hours">{{ ot.ot_hours or 'N/A' }} hrs</div>
                <div>
                    <span class="ot-record-status status-{{ ot.status.lower() }}">{{ ot.status }}</span>
                </div>
                <div class="ot-record-action">
                    {% if ot.status == 'Draft' %}
                    <form method="POST" action="{{ url_for('submit_ot_attendance', attendance_id=ot.id) }}" style="display: inline;">
                        <button type="submit" class="btn btn-primary" title="Submit this OT for manager approval">
                            <i class="fas fa-paper-plane"></i> Submit
                        </button>
                    </form>
                    {% elif ot.status == 'Submitted' %}
                    <span class="badge">Pending</span>
                    {% elif ot.status == 'Approved' %}
                    <span class="badge">Approved</span>
                    {% elif ot.status == 'Rejected' %}
                    <span class="badge">Rejected</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="recent-ots-wrapper">
        <div class="no-records">No OT records found</div>
    </div>
    {% endif %}
</div>

<script>
    // Function to set current time in time input
    function setCurrentTime(fieldId) {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const currentTime = `${hours}:${minutes}`;
        
        document.getElementById(fieldId).value = currentTime;
        console.log(`Set ${fieldId} to ${currentTime}`);
    }

    function switchMode(mode) {
        const timeMode = document.getElementById('timeMode');
        const hoursMode = document.getElementById('hoursMode');
        const buttons = document.querySelectorAll('.btn-switch');
        
        buttons.forEach(btn => btn.classList.remove('active'));
        
        if (mode === 'time') {
            timeMode.classList.remove('hidden');
            hoursMode.classList.add('hidden');
            buttons[0].classList.add('active');
            // Clear hours input
            document.getElementById('ot_hours').value = '';
        } else {
            timeMode.classList.add('hidden');
            hoursMode.classList.remove('hidden');
            buttons[1].classList.add('active');
            // Clear time inputs
            document.getElementById('ot_in_time').value = '';
            document.getElementById('ot_out_time').value = '';
        }
    }

    // Form validation
    document.getElementById('otForm').addEventListener('submit', function(e) {
        const ot_date = document.getElementById('ot_date').value;
        const ot_type_id = document.getElementById('ot_type_id').value;
        const ot_in_time = document.getElementById('ot_in_time').value;
        const ot_out_time = document.getElementById('ot_out_time').value;
        const ot_hours = document.getElementById('ot_hours').value;
        
        if (!ot_date) {
            e.preventDefault();
            alert('Please select an OT date');
            return false;
        }
        
        if (!ot_type_id) {
            e.preventDefault();
            alert('Please select an OT type');
            return false;
        }
        
        // Check if either time or hours is provided
        const hasTime = ot_in_time && ot_out_time;
        const hasHours = ot_hours;
        
        if (!hasTime && !hasHours) {
            e.preventDefault();
            alert('Please provide either OT hours or OT in/out times');
            return false;
        }
        
        // If time mode, validate times
        if (hasTime && !hasHours) {
            if (ot_out_time <= ot_in_time) {
                e.preventDefault();
                alert('OT Out Time must be after OT In Time');
                return false;
            }
        }
    });
</script>
{% endblock %}