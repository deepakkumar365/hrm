{% extends "base.html" %}

{% block title %}Mark OT Attendance - Nexar{% endblock %}

{% block head %}
<style>
    * {
        font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
        margin: 0;
        padding: 0;
    }

    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        overflow-x: hidden;
        position: relative;
    }

    /* Animated Background */
    body::before {
        content: '';
        position: fixed;
        width: 400px;
        height: 400px;
        background: radial-gradient(circle, rgba(102, 126, 234, 0.1) 0%, transparent 70%);
        border-radius: 50%;
        top: -50px;
        left: -100px;
        animation: float1 6s ease-in-out infinite;
        pointer-events: none;
    }

    body::after {
        content: '';
        position: fixed;
        width: 400px;
        height: 400px;
        background: radial-gradient(circle, rgba(118, 75, 162, 0.1) 0%, transparent 70%);
        border-radius: 50%;
        bottom: -100px;
        right: -50px;
        animation: float2 8s ease-in-out infinite;
        pointer-events: none;
    }

    @keyframes float1 {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(30px); }
    }

    @keyframes float2 {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-30px); }
    }

    .ot-container {
        position: relative;
        z-index: 1;
        max-width: 1200px;
        margin: 0 auto;
        padding: 0.8rem 1rem;
        height: 100vh;
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
        overflow: hidden;
    }

    /* Header Section */
    .header-section {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 0.4rem 1rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        animation: slideDown 0.6s ease-out;
        flex-shrink: 0;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .header-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.6rem;
        align-items: center;
    }

    .header-title {
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }

    .header-title i {
        font-size: 1.2rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .header-title h1 {
        font-size: 1rem;
        color: #2c3e50;
        font-weight: 700;
        letter-spacing: -0.3px;
    }

    .header-info {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.4rem;
    }

    .info-item {
        display: flex;
        flex-direction: column;
        gap: 0.1rem;
    }

    .info-label {
        font-size: 0.55rem;
        font-weight: 600;
        color: #999;
        text-transform: uppercase;
        letter-spacing: 0.2px;
    }

    .info-value {
        font-size: 0.7rem;
        font-weight: 600;
        color: #2c3e50;
    }

    /* Alerts */
    .alerts-section {
        animation: slideDown 0.6s ease-out 0.1s both;
        flex-shrink: 0;
        max-height: 80px;
        overflow-y: auto;
    }

    .alert {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 6px;
        padding: 0.4rem 0.8rem;
        margin-bottom: 0.2rem;
        border-left: 2px solid;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        animation: slideIn 0.4s ease-out;
        font-size: 0.7rem;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(-30px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .alert-success {
        border-left-color: #27ae60;
        color: #27ae60;
    }

    .alert-info {
        border-left-color: #3498db;
        color: #3498db;
    }

    .alert-warning {
        border-left-color: #f39c12;
        color: #f39c12;
    }

    .alert-danger {
        border-left-color: #e74c3c;
        color: #e74c3c;
    }

    .alert i {
        font-size: 1rem;
        flex-shrink: 0;
    }

    /* Main Content Grid */
    .content-wrapper {
        display: grid;
        grid-template-columns: 1.2fr 1.1fr;
        gap: 0.6rem;
        animation: slideDown 0.6s ease-out 0.2s both;
        flex: 1;
        overflow: hidden;
    }

    @media (max-width: 1024px) {
        .content-wrapper {
            grid-template-columns: 1fr;
        }

        .header-content {
            grid-template-columns: 1fr;
        }

        .header-info {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    /* Form Card */
    .form-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 0.8rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.5);
        overflow-y: auto;
    }

    .form-title {
        font-size: 0.95rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 0.6rem;
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }

    .form-title i {
        color: #667eea;
        font-size: 1rem;
    }

    .form-section {
        margin-bottom: 0.6rem;
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
    }

    .section-label {
        font-size: 0.6rem;
        font-weight: 600;
        color: #667eea;
        text-transform: uppercase;
        letter-spacing: 0.2px;
        display: flex;
        align-items: center;
        gap: 0.2rem;
    }

    .section-label::before {
        content: '';
        width: 4px;
        height: 4px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 50%;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
    }

    .form-group label {
        font-weight: 600;
        font-size: 0.75rem;
        color: #2c3e50;
        display: flex;
        align-items: center;
        gap: 0.2rem;
    }

    .required {
        color: #e74c3c;
        font-weight: bold;
    }

    .form-control, .form-select {
        padding: 0.4rem 0.6rem;
        border: 1.5px solid #e8eef5;
        border-radius: 6px;
        font-size: 0.75rem;
        background: #f8f9fb;
        color: #2c3e50;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-family: inherit;
    }

    .form-control:focus, .form-select:focus {
        outline: none;
        border-color: #667eea;
        background: #fff;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        transform: translateY(-2px);
    }

    .form-control:hover, .form-select:hover {
        border-color: #667eea;
        background: #fff;
    }

    .form-help {
        font-size: 0.6rem;
        color: #999;
        margin-top: 0.1rem;
    }

    /* Mode Switcher */
    .mode-switcher {
        display: flex;
        gap: 0.3rem;
        background: #f0f4ff;
        padding: 0.3rem;
        border-radius: 6px;
        margin-bottom: 0.5rem;
    }

    .switch-btn {
        flex: 1;
        padding: 0.3rem 0.4rem;
        border: 1.5px solid transparent;
        background: transparent;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.65rem;
        color: #999;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.2rem;
    }

    .switch-btn.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .switch-btn:hover {
        color: #667eea;
    }

    /* Time Input Group */
    .time-input-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.4rem;
        margin-bottom: 0.5rem;
    }

    .time-input-wrapper {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
    }

    .time-input-wrapper input[type="time"] {
        padding: 0.35rem 0.5rem;
        border: 1.5px solid #e8eef5;
        border-radius: 6px;
        font-size: 0.7rem;
        background: #f8f9fb;
        color: #2c3e50;
        transition: all 0.3s ease;
    }

    .time-input-wrapper input[type="time"]:focus {
        outline: none;
        border-color: #667eea;
        background: #fff;
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
    }

    .btn-time-now {
        padding: 0.3rem 0.6rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.65rem;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.2rem;
        margin-top: 0.4rem;
    }

    .btn-time-now:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .btn-time-now:active {
        transform: translateY(0);
    }

    .btn-time-now:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Buttons */
    .button-group {
        display: flex;
        gap: 0.4rem;
        margin-top: 0.6rem;
        justify-content: center;
    }

    .btn-primary {
        flex: 1;
        padding: 0.5rem 0.8rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.7rem;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.3rem;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .btn-primary:active {
        transform: translateY(0);
    }

    .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .btn-secondary {
        flex: 1;
        padding: 0.5rem 0.8rem;
        background: transparent;
        color: #667eea;
        border: 1.5px solid #667eea;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.7rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.3rem;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .btn-secondary:hover {
        background: #f0f4ff;
        transform: translateY(-2px);
    }

    .btn-secondary:active {
        transform: translateY(0);
    }

    .btn-secondary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    /* Timeline Card */
    .timeline-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 0.8rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.5);
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .timeline-title {
        font-size: 0.95rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 0.6rem;
        display: flex;
        align-items: center;
        gap: 0.4rem;
        flex-shrink: 0;
    }

    .timeline-title i {
        color: #764ba2;
        font-size: 1rem;
    }

    .timeline-list {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        overflow-y: auto;
        padding-right: 0.2rem;
        flex: 1;
    }

    .timeline-list::-webkit-scrollbar {
        width: 5px;
    }

    .timeline-list::-webkit-scrollbar-track {
        background: #f0f0f0;
        border-radius: 10px;
    }

    .timeline-list::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 10px;
    }

    .timeline-item {
        background: linear-gradient(135deg, #f8f9fb 0%, #f0f4ff 100%);
        padding: 0.6rem;
        border-radius: 6px;
        border-left: 2px solid #667eea;
        transition: all 0.3s ease;
        animation: slideIn 0.4s ease-out;
    }

    .timeline-item:hover {
        transform: translateX(2px);
        box-shadow: 0 2px 6px rgba(102, 126, 234, 0.1);
        border-left-color: #764ba2;
    }

    .timeline-time {
        font-weight: 700;
        color: #2c3e50;
        font-size: 0.75rem;
        margin-bottom: 0.2rem;
    }

    .timeline-activity {
        font-size: 0.65rem;
        color: #667eea;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.2px;
    }

    .timeline-zone {
        font-size: 0.6rem;
        color: #999;
        margin-top: 0.2rem;
    }

    .no-activity {
        text-align: center;
        padding: 1rem;
        color: #999;
        font-size: 0.75rem;
    }

    .records-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 1.2rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.5);
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .records-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 0.8rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-shrink: 0;
    }

    .records-title i {
        color: #764ba2;
        font-size: 1.2rem;
    }

    .records-list {
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
        overflow-y: auto;
        padding-right: 0.3rem;
        flex: 1;
    }

    .records-list::-webkit-scrollbar {
        width: 6px;
    }

    .records-list::-webkit-scrollbar-track {
        background: #f0f0f0;
        border-radius: 10px;
    }

    .records-list::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 10px;
    }

    .record-item {
        background: linear-gradient(135deg, #f8f9fb 0%, #f0f4ff 100%);
        padding: 0.8rem;
        border-radius: 8px;
        border-left: 3px solid #667eea;
        transition: all 0.3s ease;
        animation: slideIn 0.4s ease-out;
    }

    .record-item:hover {
        transform: translateX(3px);
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
        border-left-color: #764ba2;
    }

    .record-date {
        font-weight: 700;
        color: #2c3e50;
        font-size: 0.85rem;
        margin-bottom: 0.3rem;
    }

    .record-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 0.5rem;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .record-type {
        font-size: 0.65rem;
        color: #667eea;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.2px;
    }

    .record-hours {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.2rem 0.6rem;
        border-radius: 12px;
        font-weight: 700;
        font-size: 0.7rem;
    }

    .status-badge {
        padding: 0.2rem 0.6rem;
        border-radius: 12px;
        font-size: 0.65rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .status-draft {
        background: #e3f2fd;
        color: #1976d2;
    }

    .status-submitted {
        background: #fff3e0;
        color: #f57c00;
    }

    .status-approved {
        background: #e8f5e9;
        color: #388e3c;
    }

    .status-rejected {
        background: #ffebee;
        color: #d32f2f;
    }

    .no-records {
        text-align: center;
        padding: 2rem;
        color: #999;
        font-style: italic;
    }

    .record-submit-btn {
        padding: 0.4rem 0.8rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.75rem;
        transition: all 0.3s ease;
    }

    .record-submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .record-submit-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    /* Accessibility */
    .hidden {
        display: none;
    }

    @media (max-width: 768px) {
        .ot-container {
            padding: 1rem;
        }

        .header-section {
            padding: 1.5rem;
        }

        .header-content {
            gap: 1rem;
        }

        .header-title h1 {
            font-size: 1.5rem;
        }

        .header-info {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .form-card, .records-card {
            padding: 1.5rem;
        }

        .button-group {
            flex-direction: column;
        }

        .time-input-group {
            grid-template-columns: 1fr;
        }
    }

    /* Loading Animation */
    @keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.5;
        }
    }

    .loading {
        animation: pulse 1.5s ease-in-out infinite;
    }
</style>
{% endblock %}

{% block content %}
<div class="ot-container">
    <!-- Header Section -->
    <div class="header-section">
        <div class="header-content">
            <div class="header-title">
                <i class="fas fa-bolt"></i>
                <h1>Mark OT Attendance</h1>
            </div>
            <div class="header-info">
                <div class="info-item">
                    <span class="info-label">Employee</span>
                    <span class="info-value">{{ employee.first_name }} {{ employee.last_name }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Employee ID</span>
                    <span class="info-value">{{ employee.employee_id }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Department</span>
                    <span class="info-value">{{ employee.department.name if employee.department else 'N/A' }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Alerts Section -->
    <div class="alerts-section">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'success' if category == 'success' else 'danger' if category == 'danger' else 'warning' if category == 'warning' else 'info' }}">
                        <i class="fas fa-{{ 'check-circle' if category == 'success' else 'times-circle' if category == 'danger' else 'exclamation-circle' if category == 'warning' else 'info-circle' }}"></i>
                        <span>{{ message | safe }}</span>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <!-- Main Content -->
    <div class="content-wrapper">
        <!-- Form Card -->
        <div class="form-card">
            {% if has_ot_types %}
            <form method="POST" id="otForm">
            {% else %}
            <form method="POST" id="otForm" style="opacity: 0.6; pointer-events: none;">
            {% endif %}
                <div class="form-title">
                    <i class="fas fa-edit"></i>
                    Record Overtime
                </div>

                <!-- OT Date Section -->
                <div class="form-section">
                    <div class="section-label">
                        <i class="fas fa-calendar-alt"></i> Date Selection
                    </div>
                    <div class="form-group">
                        <label for="ot_date">OT Date <span class="required">*</span></label>
                        <input type="date" class="form-control" id="ot_date" name="ot_date" 
                               value="{{ today }}" required {% if not has_ot_types %}disabled{% endif %}>
                        <div class="form-help">üìÖ Select the date you worked overtime (cannot be future date)</div>
                    </div>
                </div>

                <!-- Mode Switcher -->
                <div class="form-section">
                    <div class="section-label">
                        <i class="fas fa-sliders-h"></i> Entry Method
                    </div>
                    <div class="mode-switcher">
                        <button type="button" class="switch-btn active" onclick="switchMode('time')">
                            <i class="fas fa-clock"></i> In/Out Time
                        </button>
                        <button type="button" class="switch-btn" onclick="switchMode('hours')">
                            <i class="fas fa-calculator"></i> Direct Hours
                        </button>
                    </div>
                </div>

                <!-- Time Mode -->
                <div id="timeMode" class="form-section">
                    <div class="section-label">
                        <i class="fas fa-hourglass-start"></i> Working Hours
                    </div>
                    <div class="time-input-group">
                        <div class="time-input-wrapper">
                            <label for="ot_in_time">In Time</label>
                            <input type="time" class="form-control" id="ot_in_time" name="ot_in_time" 
                                   {% if not has_ot_types %}disabled{% endif %}>
                        </div>
                        <div class="time-input-wrapper">
                            <label for="ot_out_time">Out Time</label>
                            <input type="time" class="form-control" id="ot_out_time" name="ot_out_time"
                                   {% if not has_ot_types %}disabled{% endif %}>
                        </div>
                    </div>
                    <!-- Timezone Selection -->
                    <div class="form-group" style="margin-bottom: 0.4rem;">
                        <label for="ot_timezone">Timezone <span class="required">*</span></label>
                        <select class="form-control" id="ot_timezone" name="ot_timezone" required
                                {% if not has_ot_types %}disabled{% endif %}>
                            <option value="">-- Select Timezone --</option>
                            <option value="UTC">UTC</option>
                            <option value="Asia/Singapore" selected>Asia/Singapore (SGT - UTC+8)</option>
                            <option value="Asia/Kolkata">Asia/Kolkata (IST - UTC+5:30)</option>
                            <option value="Asia/Bangkok">Asia/Bangkok (ICT - UTC+7)</option>
                            <option value="Asia/Jakarta">Asia/Jakarta (WIB - UTC+7)</option>
                            <option value="Asia/Kuala_Lumpur">Asia/Kuala Lumpur (MYT - UTC+8)</option>
                            <option value="America/New_York">America/New_York (EST - UTC-5)</option>
                            <option value="Europe/London">Europe/London (GMT - UTC+0)</option>
                            <option value="Australia/Sydney">Australia/Sydney (AEDT - UTC+11)</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 0.4rem;">
                        <button type="button" class="btn-time-now" onclick="setCurrentTime('ot_in_time')" 
                                {% if not has_ot_types %}disabled{% endif %}>
                            <i class="fas fa-play-circle"></i> Set In
                        </button>
                        <button type="button" class="btn-time-now" onclick="setCurrentTime('ot_out_time')" 
                                {% if not has_ot_types %}disabled{% endif %}>
                            <i class="fas fa-stop-circle"></i> Set Out
                        </button>
                    </div>
                </div>

                <!-- Hours Mode -->
                <div id="hoursMode" class="form-section hidden">
                    <div class="section-label">
                        <i class="fas fa-hourglass-half"></i> Duration
                    </div>
                    <div class="form-group">
                        <label for="ot_hours">OT Hours <span class="required">*</span></label>
                        <input type="number" class="form-control" id="ot_hours" name="ot_hours" 
                               step="0.5" min="0" placeholder="e.g., 2, 2.5, 3"
                               {% if not has_ot_types %}disabled{% endif %}>
                        <div class="form-help">‚è±Ô∏è Enter total overtime hours worked</div>
                    </div>
                </div>

                <!-- OT Type Section -->
                <div class="form-section">
                    <div class="section-label">
                        <i class="fas fa-tags"></i> Overtime Type
                    </div>
                    <div class="form-group">
                        <label for="ot_type_id">OT Type <span class="required">*</span></label>
                        <select class="form-control" id="ot_type_id" name="ot_type_id" required 
                                {% if not has_ot_types %}disabled{% endif %}>
                            <option value="">-- Select OT Type --</option>
                            {% for ot_type in ot_types %}
                                <option value="{{ ot_type.id }}">
                                    {{ ot_type.name }} ({{ ot_type.rate_multiplier }}x)
                                </option>
                            {% endfor %}
                        </select>
                        <div class="form-help">üè∑Ô∏è Choose the type of overtime work</div>
                    </div>
                </div>

                <!-- Notes Section -->
                <div class="form-section">
                    <div class="section-label">
                        <i class="fas fa-comment-dots"></i> Additional Info
                    </div>
                    <div class="form-group">
                        <label for="notes">Notes/Reason</label>
                        <textarea class="form-control" id="notes" name="notes" rows="2" 
                                  placeholder="Why overtime? What task?"
                                  style="resize: vertical; min-height: 50px; font-size: 0.7rem;"
                                  {% if not has_ot_types %}disabled{% endif %}></textarea>
                        <div class="form-help">üìù Optional context</div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="button-group">
                    <button type="submit" class="btn-primary" {% if not has_ot_types %}disabled{% endif %}>
                        <i class="fas fa-paper-plane"></i> Submit Attendance
                    </button>
                    <button type="reset" class="btn-secondary" {% if not has_ot_types %}disabled{% endif %}>
                        <i class="fas fa-redo-alt"></i> Clear Form
                    </button>
                </div>
            </form>
        </div>

        <!-- Daily Activity Timeline Card -->
        <div class="timeline-card">
            <div class="timeline-title">
                <i class="fas fa-clock"></i>
                Today's Activity
            </div>
            <div class="timeline-list" id="timelineList">
                <!-- Timeline items will be populated by JavaScript -->
                <div class="no-activity" id="noActivityPlaceholder" style="padding: 1rem;">
                    <i class="fas fa-inbox" style="font-size: 1.5rem; opacity: 0.5; margin-bottom: 0.5rem; display: block;"></i>
                    <p>No activity recorded today</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Timezone mapping for display
    const timezoneMap = {
        'UTC': { offset: 0, display: 'UTC' },
        'Asia/Singapore': { offset: 8, display: 'SGT (UTC+8)' },
        'Asia/Kolkata': { offset: 5.5, display: 'IST (UTC+5:30)' },
        'Asia/Bangkok': { offset: 7, display: 'ICT (UTC+7)' },
        'Asia/Jakarta': { offset: 7, display: 'WIB (UTC+7)' },
        'Asia/Kuala_Lumpur': { offset: 8, display: 'MYT (UTC+8)' },
        'America/New_York': { offset: -5, display: 'EST (UTC-5)' },
        'Europe/London': { offset: 0, display: 'GMT (UTC+0)' },
        'Australia/Sydney': { offset: 11, display: 'AEDT (UTC+11)' }
    };

    // Populate timeline with today's attendance data
    function populateTimeline() {
        const timelineList = document.getElementById('timelineList');
        const noActivityPlaceholder = document.getElementById('noActivityPlaceholder');
        
        // Get attendance data from backend (if available)
        const attendanceData = {{ attendance_data | tojson | safe if attendance_data else '[]' }};
        
        if (attendanceData && attendanceData.length > 0) {
            noActivityPlaceholder.style.display = 'none';
            timelineList.innerHTML = '';
            
            attendanceData.forEach(record => {
                const item = createTimelineItem(record);
                timelineList.appendChild(item);
            });
        } else {
            // Show sample data if no actual data
            noActivityPlaceholder.style.display = 'block';
        }
    }

    // Create a timeline item element
    function createTimelineItem(record) {
        const item = document.createElement('div');
        item.className = 'timeline-item';
        
        const selectedTimezone = document.getElementById('ot_timezone').value || 'Asia/Singapore';
        const tzInfo = timezoneMap[selectedTimezone] || timezoneMap['Asia/Singapore'];
        
        item.innerHTML = `
            <div class="timeline-time">${record.time || record.activity_time}</div>
            <div class="timeline-activity">${record.activity || record.activity_type}</div>
            <div class="timeline-zone">${tzInfo.display}</div>
        `;
        
        return item;
    }

    // Update timezone display in all timeline items
    function updateTimezoneDisplay() {
        const selectedTimezone = document.getElementById('ot_timezone').value || 'Asia/Singapore';
        const tzInfo = timezoneMap[selectedTimezone] || timezoneMap['Asia/Singapore'];
        
        const timelineItems = document.querySelectorAll('.timeline-item .timeline-zone');
        timelineItems.forEach(zone => {
            zone.textContent = tzInfo.display;
        });
    }

    // Prevent future dates
    const dateInput = document.getElementById('ot_date');
    const today = new Date().toISOString().split('T')[0];
    dateInput.max = today;

    // Set current time in time input with animation
    function setCurrentTime(fieldId) {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const currentTime = `${hours}:${minutes}`;
        
        const field = document.getElementById(fieldId);
        field.style.animation = 'none';
        setTimeout(() => {
            field.value = currentTime;
            field.style.animation = 'pulse 0.6s ease-out';
        }, 10);
        
        console.log(`Set ${fieldId} to ${currentTime} in timezone: ${document.getElementById('ot_timezone').value}`);
    }

    // Switch between time and hours mode
    function switchMode(mode) {
        const timeMode = document.getElementById('timeMode');
        const hoursMode = document.getElementById('hoursMode');
        const buttons = document.querySelectorAll('.switch-btn');
        
        buttons.forEach(btn => btn.classList.remove('active'));
        
        if (mode === 'time') {
            timeMode.classList.remove('hidden');
            hoursMode.classList.add('hidden');
            buttons[0].classList.add('active');
            document.getElementById('ot_hours').value = '';
        } else {
            timeMode.classList.add('hidden');
            hoursMode.classList.remove('hidden');
            buttons[1].classList.add('active');
            document.getElementById('ot_in_time').value = '';
            document.getElementById('ot_out_time').value = '';
        }
    }

    // Listen for timezone changes
    document.getElementById('ot_timezone').addEventListener('change', updateTimezoneDisplay);

    // Form validation with animations
    document.getElementById('otForm').addEventListener('submit', function(e) {
        const ot_date = document.getElementById('ot_date').value;
        const ot_type_id = document.getElementById('ot_type_id').value;
        const ot_in_time = document.getElementById('ot_in_time').value;
        const ot_out_time = document.getElementById('ot_out_time').value;
        const ot_hours = document.getElementById('ot_hours').value;
        
        if (!ot_date) {
            e.preventDefault();
            showErrorMessage('Please select an OT date');
            return false;
        }

        // Validate date is not in future
        const selectedDate = new Date(ot_date);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (selectedDate > today) {
            e.preventDefault();
            showErrorMessage('Future dates are not allowed. Please select today or an earlier date.');
            return false;
        }
        
        if (!ot_type_id) {
            e.preventDefault();
            showErrorMessage('Please select an OT type');
            return false;
        }
        
        const hasTime = ot_in_time && ot_out_time;
        const hasHours = ot_hours;
        
        if (!hasTime && !hasHours) {
            e.preventDefault();
            showErrorMessage('Please provide either OT hours or OT in/out times');
            return false;
        }
        
        if (hasTime && !hasHours) {
            if (ot_out_time <= ot_in_time) {
                e.preventDefault();
                showErrorMessage('Out Time must be after In Time');
                return false;
            }
        }
    });

    function showErrorMessage(message) {
        const alertsSection = document.querySelector('.alerts-section');
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger';
        alert.innerHTML = `<i class="fas fa-exclamation-circle"></i><span>${message}</span>`;
        alertsSection.insertBefore(alert, alertsSection.firstChild);
        
        setTimeout(() => {
            alert.style.animation = 'slideIn 0.4s ease-out reverse';
            setTimeout(() => alert.remove(), 400);
        }, 4000);
    }

    // Add ripple effect to buttons
    document.querySelectorAll('.btn-primary, .btn-secondary, .btn-time-now, .record-submit-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            const ripple = document.createElement('span');
            const rect = this.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = e.clientX - rect.left - size / 2;
            const y = e.clientY - rect.top - size / 2;
            
            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = x + 'px';
            ripple.style.top = y + 'px';
        });
    });

    // Initialize page on load
    document.addEventListener('DOMContentLoaded', function() {
        populateTimeline();
        updateTimezoneDisplay();
    });

    // Ensure timezone is set with time values
    document.getElementById('ot_in_time').addEventListener('change', function() {
        const timezone = document.getElementById('ot_timezone').value;
        console.log(`In Time set: ${this.value} [${timezone}]`);
    });

    document.getElementById('ot_out_time').addEventListener('change', function() {
        const timezone = document.getElementById('ot_timezone').value;
        console.log(`Out Time set: ${this.value} [${timezone}]`);
    });
</script>
{% endblock %}