{% extends "base.html" %}

{% block title %}Mark OT Attendance - Nexar{% endblock %}

{% block head %}
<style>
    * {
        font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
        margin: 0;
        padding: 0;
    }

    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        overflow-x: hidden;
        position: relative;
    }

    /* Animated Background */
    body::before {
        content: '';
        position: fixed;
        width: 400px;
        height: 400px;
        background: radial-gradient(circle, rgba(102, 126, 234, 0.1) 0%, transparent 70%);
        border-radius: 50%;
        top: -50px;
        left: -100px;
        animation: float1 6s ease-in-out infinite;
        pointer-events: none;
    }

    body::after {
        content: '';
        position: fixed;
        width: 400px;
        height: 400px;
        background: radial-gradient(circle, rgba(118, 75, 162, 0.1) 0%, transparent 70%);
        border-radius: 50%;
        bottom: -100px;
        right: -50px;
        animation: float2 8s ease-in-out infinite;
        pointer-events: none;
    }

    @keyframes float1 {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(30px); }
    }

    @keyframes float2 {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-30px); }
    }

    .ot-container {
        position: relative;
        z-index: 1;
        max-width: 1200px;
        margin: 0 auto;
        padding: 0.8rem 1rem;
        height: 100vh;
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
        overflow: hidden;
    }

    /* Header Section */
    .header-section {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 0.4rem 1rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        animation: slideDown 0.6s ease-out;
        flex-shrink: 0;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .header-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.6rem;
        align-items: center;
    }

    .header-title {
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }

    .header-title i {
        font-size: 1.2rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .header-title h1 {
        font-size: 1rem;
        color: #2c3e50;
        font-weight: 700;
        letter-spacing: -0.3px;
    }

    .header-info {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.4rem;
    }

    .info-item {
        display: flex;
        flex-direction: column;
        gap: 0.1rem;
    }

    .info-label {
        font-size: 0.55rem;
        font-weight: 600;
        color: #999;
        text-transform: uppercase;
        letter-spacing: 0.2px;
    }

    .info-value {
        font-size: 0.7rem;
        font-weight: 600;
        color: #2c3e50;
    }

    /* Live Clock in Header */
    .header-clock {
        grid-column: 1 / -1;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.4rem 0.6rem;
        border-radius: 6px;
        text-align: center;
        margin-top: 0.2rem;
    }

    .header-clock-label {
        font-size: 0.55rem;
        font-weight: 600;
        text-transform: uppercase;
        opacity: 0.9;
        margin-bottom: 0.1rem;
    }

    .header-clock-time {
        font-size: 1.1rem;
        font-weight: 700;
        font-family: 'Courier New', monospace;
        letter-spacing: 0.1rem;
    }

    /* Alerts */
    .alerts-section {
        animation: slideDown 0.6s ease-out 0.1s both;
        flex-shrink: 0;
        max-height: 80px;
        overflow-y: auto;
    }

    .alert {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 6px;
        padding: 0.4rem 0.8rem;
        margin-bottom: 0.2rem;
        border-left: 2px solid;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        animation: slideIn 0.4s ease-out;
        font-size: 0.7rem;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(-30px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .alert-success {
        border-left-color: #27ae60;
        color: #27ae60;
    }

    .alert-info {
        border-left-color: #3498db;
        color: #3498db;
    }

    .alert-warning {
        border-left-color: #f39c12;
        color: #f39c12;
    }

    .alert-danger {
        border-left-color: #e74c3c;
        color: #e74c3c;
    }

    .alert i {
        font-size: 1rem;
        flex-shrink: 0;
    }

    /* Main Content Grid */
    .content-wrapper {
        display: grid;
        grid-template-columns: 1.2fr 1.1fr;
        gap: 0.6rem;
        animation: slideDown 0.6s ease-out 0.2s both;
        flex: 1;
        overflow: hidden;
    }

    /* Right sidebar for stacking cards */
    .right-sidebar {
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
        overflow-y: auto;
        overflow-x: hidden;
    }

    @media (max-width: 1024px) {
        .content-wrapper {
            grid-template-columns: 1fr;
        }

        .header-content {
            grid-template-columns: 1fr;
        }

        .header-info {
            grid-template-columns: repeat(2, 1fr);
        }

        .time-input-group {
            grid-template-columns: 1fr;
            align-items: stretch;
        }

        .time-button-wrapper {
            flex-direction: row;
            gap: 0.3rem;
        }

        .form-section-row {
            grid-template-columns: 1fr;
        }
    }

    /* Form Card */
    .form-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 0.8rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.5);
        overflow-y: auto;
        flex: 1;
    }

    .form-title {
        font-size: 0.95rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 0.6rem;
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }

    .form-title i {
        color: #667eea;
        font-size: 1rem;
    }

    .form-section {
        margin-bottom: 0.6rem;
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
    }

    /* Two-column layout for OT Type and Notes */
    .form-section-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
        margin-bottom: 0.6rem;
    }

    .form-section-row .form-section {
        margin-bottom: 0;
    }

    .section-label {
        font-size: 0.6rem;
        font-weight: 600;
        color: #667eea;
        text-transform: uppercase;
        letter-spacing: 0.2px;
        display: flex;
        align-items: center;
        gap: 0.2rem;
    }

    .section-label::before {
        content: '';
        width: 4px;
        height: 4px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 50%;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
    }

    .form-group label {
        font-weight: 600;
        font-size: 0.75rem;
        color: #2c3e50;
        display: flex;
        align-items: center;
        gap: 0.2rem;
    }

    .required {
        color: #e74c3c;
        font-weight: bold;
    }

    .form-control, .form-select {
        padding: 0.4rem 0.6rem;
        border: 1.5px solid #e8eef5;
        border-radius: 6px;
        font-size: 0.75rem;
        background: #f8f9fb;
        color: #2c3e50;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-family: inherit;
    }

    .form-control:focus, .form-select:focus {
        outline: none;
        border-color: #667eea;
        background: #fff;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        transform: translateY(-2px);
    }

    .form-control:hover, .form-select:hover {
        border-color: #667eea;
        background: #fff;
    }

    .form-help {
        font-size: 0.6rem;
        color: #999;
        margin-top: 0.1rem;
    }

    /* Mode Switcher */
    .mode-switcher {
        display: flex;
        gap: 0.3rem;
        background: #f0f4ff;
        padding: 0.3rem;
        border-radius: 6px;
        margin-bottom: 0.5rem;
    }

    .switch-btn {
        flex: 1;
        padding: 0.3rem 0.4rem;
        border: 1.5px solid transparent;
        background: transparent;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.65rem;
        color: #999;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.2rem;
    }

    .switch-btn.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .switch-btn:hover {
        color: #667eea;
    }

    /* Time Input Group */
    .time-input-group {
        display: grid;
        grid-template-columns: 0.8fr 0.7fr 0.2fr 0.7fr 0.2fr;
        gap: 0.3rem;
        margin-bottom: 0.5rem;
        align-items: flex-end;
    }

    .time-input-wrapper {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
    }

    .time-button-wrapper {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
        height: 100%;
        justify-content: flex-end;
    }

    .time-input-wrapper input[type="time"] {
        padding: 0.35rem 0.5rem;
        border: 1.5px solid #e8eef5;
        border-radius: 6px;
        font-size: 0.7rem;
        background: #f8f9fb;
        color: #2c3e50;
        transition: all 0.3s ease;
    }

    .time-input-wrapper input[type="time"]:focus {
        outline: none;
        border-color: #667eea;
        background: #fff;
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
    }

    .btn-time-now {
        padding: 0.3rem 0.4rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.6rem;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.1rem;
        margin: 0;
        white-space: nowrap;
    }

    .btn-time-now:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .btn-time-now:active {
        transform: translateY(0);
    }

    .btn-time-now:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Buttons */
    .button-group {
        display: flex;
        gap: 0.4rem;
        margin-top: 0.6rem;
        justify-content: center;
    }

    .btn-primary {
        flex: 1;
        padding: 0.5rem 0.8rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.7rem;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.3rem;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .btn-primary:active {
        transform: translateY(0);
    }

    .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .btn-secondary {
        flex: 1;
        padding: 0.5rem 0.8rem;
        background: transparent;
        color: #667eea;
        border: 1.5px solid #667eea;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.7rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.3rem;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .btn-secondary:hover {
        background: #f0f4ff;
        transform: translateY(-2px);
    }

    .btn-secondary:active {
        transform: translateY(0);
    }

    .btn-secondary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    /* Timeline Card */
    .timeline-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 0.8rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.5);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        flex: 1;
    }

    .timeline-title {
        font-size: 0.95rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 0.6rem;
        display: flex;
        align-items: center;
        gap: 0.4rem;
        flex-shrink: 0;
    }

    .timeline-title i {
        color: #764ba2;
        font-size: 1rem;
    }

    .timeline-list {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        overflow-y: auto;
        padding-right: 0.2rem;
        flex: 1;
    }

    .timeline-list::-webkit-scrollbar {
        width: 5px;
    }

    .timeline-list::-webkit-scrollbar-track {
        background: #f0f0f0;
        border-radius: 10px;
    }

    .timeline-list::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 10px;
    }

    .timeline-item {
        background: linear-gradient(135deg, #f8f9fb 0%, #f0f4ff 100%);
        padding: 0.6rem;
        border-radius: 6px;
        border-left: 2px solid #667eea;
        transition: all 0.3s ease;
        animation: slideIn 0.4s ease-out;
    }

    .timeline-item:hover {
        transform: translateX(2px);
        box-shadow: 0 2px 6px rgba(102, 126, 234, 0.1);
        border-left-color: #764ba2;
    }

    .timeline-time {
        font-weight: 700;
        color: #2c3e50;
        font-size: 0.75rem;
        margin-bottom: 0.2rem;
    }

    .timeline-activity {
        font-size: 0.65rem;
        color: #667eea;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.2px;
    }

    .timeline-zone {
        font-size: 0.6rem;
        color: #999;
        margin-top: 0.2rem;
    }

    .no-activity {
        text-align: center;
        padding: 1rem;
        color: #999;
        font-size: 0.75rem;
    }

    .records-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 1.2rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.5);
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .records-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 0.8rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-shrink: 0;
    }

    .records-title i {
        color: #764ba2;
        font-size: 1.2rem;
    }

    .records-list {
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
        overflow-y: auto;
        padding-right: 0.3rem;
        flex: 1;
    }

    .records-list::-webkit-scrollbar {
        width: 6px;
    }

    .records-list::-webkit-scrollbar-track {
        background: #f0f0f0;
        border-radius: 10px;
    }

    .records-list::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 10px;
    }

    .record-item {
        background: linear-gradient(135deg, #f8f9fb 0%, #f0f4ff 100%);
        padding: 0.8rem;
        border-radius: 8px;
        border-left: 3px solid #667eea;
        transition: all 0.3s ease;
        animation: slideIn 0.4s ease-out;
    }

    .record-item:hover {
        transform: translateX(3px);
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
        border-left-color: #764ba2;
    }

    .record-date {
        font-weight: 700;
        color: #2c3e50;
        font-size: 0.85rem;
        margin-bottom: 0.3rem;
    }

    .record-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 0.5rem;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .record-type {
        font-size: 0.65rem;
        color: #667eea;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.2px;
    }

    .record-hours {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.2rem 0.6rem;
        border-radius: 12px;
        font-weight: 700;
        font-size: 0.7rem;
    }

    .status-badge {
        padding: 0.2rem 0.6rem;
        border-radius: 12px;
        font-size: 0.65rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .status-draft {
        background: #e3f2fd;
        color: #1976d2;
    }

    .status-submitted {
        background: #fff3e0;
        color: #f57c00;
    }

    .status-approved {
        background: #e8f5e9;
        color: #388e3c;
    }

    .status-rejected {
        background: #ffebee;
        color: #d32f2f;
    }

    .no-records {
        text-align: center;
        padding: 2rem;
        color: #999;
        font-style: italic;
    }

    .record-submit-btn {
        padding: 0.4rem 0.8rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.75rem;
        transition: all 0.3s ease;
    }

    .record-submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .record-submit-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .record-delete-btn {
        padding: 0.35rem 0.6rem;
        background: linear-gradient(135deg, #ff6b6b 0%, #d32f2f 100%);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.7rem;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }

    .record-delete-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(211, 47, 47, 0.3);
    }

    .record-delete-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    /* Accessibility */
    .hidden {
        display: none;
    }

    @media (max-width: 768px) {
        .ot-container {
            padding: 1rem;
        }

        .header-section {
            padding: 1.5rem;
        }

        .header-content {
            gap: 1rem;
        }

        .header-title h1 {
            font-size: 1.5rem;
        }

        .header-info {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .form-card, .records-card {
            padding: 1.5rem;
        }

        .button-group {
            flex-direction: column;
        }

        .time-input-group {
            grid-template-columns: 1fr;
        }
    }

    /* Loading Animation */
    @keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.5;
        }
    }

    .loading {
        animation: pulse 1.5s ease-in-out infinite;
    }
</style>
{% endblock %}

{% block content %}
<div class="ot-container">
    <!-- Header Section -->
    <div class="header-section">
        <div class="header-content">
            <div class="header-title">
                <i class="fas fa-bolt"></i>
                <h1>Mark OT Attendance</h1>
            </div>
            <div class="header-info">
                <div class="info-item">
                    <span class="info-label">Employee</span>
                    <span class="info-value">{{ employee.first_name }} {{ employee.last_name }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Employee ID</span>
                    <span class="info-value">{{ employee.employee_id }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Department</span>
                    <span class="info-value">{{ employee.department if employee.department else 'N/A' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Company Timezone</span>
                    <span class="info-value">{{ company_timezone }}</span>
                </div>
                <div class="header-clock">
                    <div class="header-clock-label">Current Time in <span id="clockTimezone">Your Timezone</span></div>
                    <div class="header-clock-time" id="liveClock">--:-- --</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alerts Section -->
    <div class="alerts-section">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'success' if category == 'success' else 'danger' if category == 'danger' else 'warning' if category == 'warning' else 'info' }}">
                        <i class="fas fa-{{ 'check-circle' if category == 'success' else 'times-circle' if category == 'danger' else 'exclamation-circle' if category == 'warning' else 'info-circle' }}"></i>
                        <span>{{ message | safe }}</span>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <!-- Main Content -->
    <div class="content-wrapper">
        <!-- Form Card -->
        <div class="form-card">
            {% if has_ot_types %}
            <form method="POST" id="otForm">
            {% else %}
            <form method="POST" id="otForm" style="opacity: 0.6; pointer-events: none;">
            {% endif %}
                <div class="form-title">
                    <i class="fas fa-edit"></i>
                    Record Overtime
                </div>

                <!-- OT Date & Working Hours Section -->
                <div class="form-section">
                    <div class="section-label">
                        <i class="fas fa-calendar-alt"></i> Date Selection & Working Hours
                    </div>
                    <div class="time-input-group">
                        <div class="time-input-wrapper">
                            <label for="ot_date">OT Date <span class="required">*</span></label>
                            <input type="date" class="form-control" id="ot_date" name="ot_date" 
                                   value="{{ today }}" required {% if not has_ot_types %}disabled{% endif %}>
                        </div>
                        <div class="time-input-wrapper">
                            <label for="ot_in_time">In Time</label>
                            <input type="time" class="form-control" id="ot_in_time" name="ot_in_time" 
                                   {% if not has_ot_types %}disabled{% endif %}>
                        </div>
                        <div class="time-button-wrapper">
                            <button type="button" class="btn-time-now" onclick="setCurrentTime('ot_in_time')" 
                                    {% if not has_ot_types %}disabled{% endif %}>
                                <i class="fas fa-play-circle"></i> Set In
                            </button>
                        </div>
                        <div class="time-input-wrapper">
                            <label for="ot_out_time">Out Time</label>
                            <input type="time" class="form-control" id="ot_out_time" name="ot_out_time"
                                   {% if not has_ot_types %}disabled{% endif %}>
                        </div>
                        <div class="time-button-wrapper">
                            <button type="button" class="btn-time-now" onclick="setCurrentTime('ot_out_time')" 
                                    {% if not has_ot_types %}disabled{% endif %}>
                                <i class="fas fa-stop-circle"></i> Set Out
                            </button>
                        </div>
                    </div>
                    <div class="form-help">üìÖ Select the date and times you worked overtime (cannot be future date)</div>
                </div>

                <!-- Time Mode (Hidden) -->
                <div id="timeMode" class="form-section" style="display: none;"></div>

                <!-- Hours Mode -->
                <div id="hoursMode" class="form-section hidden">
                    <div class="section-label">
                        <i class="fas fa-hourglass-half"></i> Duration
                    </div>
                    <div class="form-group">
                        <label for="ot_hours">OT Hours <span class="required">*</span></label>
                        <input type="number" class="form-control" id="ot_hours" name="ot_hours" 
                               step="0.5" min="0" placeholder="e.g., 2, 2.5, 3"
                               {% if not has_ot_types %}disabled{% endif %}>
                        <div class="form-help">‚è±Ô∏è Enter total overtime hours worked</div>
                    </div>
                </div>

                <!-- OT Type & Notes - Two Column Row -->
                <div class="form-section-row">
                    <!-- OT Type Section -->
                    <div class="form-section">
                        <div class="section-label">
                            <i class="fas fa-tags"></i> OT Type
                        </div>
                        <div class="form-group">
                            <label for="ot_type_id">Select Type <span class="required">*</span></label>
                            <select class="form-control" id="ot_type_id" name="ot_type_id" required 
                                    {% if not has_ot_types %}disabled{% endif %}>
                                <option value="">-- Select --</option>
                                {% for ot_type in ot_types %}
                                    <option value="{{ ot_type.id }}">
                                        {{ ot_type.name }} ({{ ot_type.rate_multiplier }}x)
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Notes Section -->
                    <div class="form-section">
                        <div class="section-label">
                            <i class="fas fa-comment-dots"></i> Notes/Reason
                        </div>
                        <div class="form-group">
                            <label for="notes">Additional Info</label>
                            <textarea class="form-control" id="notes" name="notes" rows="1" 
                                      placeholder="Why overtime? What task?"
                                      style="resize: none; min-height: 36px; font-size: 0.7rem;"
                                      {% if not has_ot_types %}disabled{% endif %}></textarea>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="button-group">
                    <button type="button" class="btn-secondary" onclick="saveDraft()" id="saveDraftBtn"
                            style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none;"
                            title="Save Set In time as draft. You can update Set Out time later!"
                            {% if not has_ot_types %}disabled{% endif %}>
                        <i class="fas fa-save"></i> Save Draft
                    </button>
                    <button type="submit" class="btn-primary" {% if not has_ot_types %}disabled{% endif %}>
                        <i class="fas fa-paper-plane"></i> Submit Attendance
                    </button>
                    <button type="reset" class="btn-secondary" {% if not has_ot_types %}disabled{% endif %}>
                        <i class="fas fa-redo-alt"></i> Clear Form
                    </button>
                </div>
            </form>
        </div>

        <!-- Right Sidebar (Recent OT Records) -->
        <div class="right-sidebar">
            <!-- Recent OT Records Card -->
            <div class="timeline-card">
                <div class="timeline-title">
                    <i class="fas fa-file-invoice"></i>
                    Recent OT Records
                </div>
                <div class="timeline-list" id="recentOtsList">
                    {% if recent_ots %}
                        {% for ot in recent_ots %}
                        <div class="ot-record-item" style="padding: 0.8rem; border-bottom: 1px solid #e8eef5; display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 0.8rem; color: #2c3e50;">
                                    {{ ot.ot_date.strftime('%d %b %Y') if ot.ot_date else 'N/A' }}
                                </div>
                                <div style="font-size: 0.7rem; color: #999; margin-top: 0.2rem;">
                                    {{ ot.ot_hours or 0 }} hrs - {{ ot.ot_type.name if ot.ot_type else 'General' }}
                                </div>
                                <div style="font-size: 0.65rem; color: #999; margin-top: 0.2rem;">
                                    {% if ot.status == 'Draft' %}
                                        <span style="background: #fef3c7; color: #92400e; padding: 0.2rem 0.6rem; border-radius: 12px; font-weight: 600;">Draft</span>
                                    {% elif ot.status == 'Submitted' %}
                                        <span style="background: #dbeafe; color: #1e40af; padding: 0.2rem 0.6rem; border-radius: 12px; font-weight: 600;">Submitted</span>
                                    {% elif ot.status == 'Approved' %}
                                        <span style="background: #d1fae5; color: #065f46; padding: 0.2rem 0.6rem; border-radius: 12px; font-weight: 600;">Approved</span>
                                    {% elif ot.status == 'Rejected' %}
                                        <span style="background: #fee2e2; color: #7f1d1d; padding: 0.2rem 0.6rem; border-radius: 12px; font-weight: 600;">Rejected</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.4rem;">
                                {% if ot.status == 'Draft' %}
                                    <button type="button" class="btn btn-sm btn-success" 
                                            onclick="submitOT({{ ot.id }}, '{{ ot.ot_date.strftime('%d %b %Y') if ot.ot_date else 'N/A' }}')"
                                            style="padding: 0.35rem 0.6rem; font-size: 0.7rem;">
                                        <i class="fas fa-paper-plane"></i> Submit
                                    </button>
                                    <button type="button" class="record-delete-btn" 
                                            onclick="deleteDraftOT({{ ot.id }}, '{{ ot.ot_date.strftime('%d %b %Y') if ot.ot_date else 'N/A' }}')"
                                            title="Delete this draft record">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                    <div class="no-activity" style="padding: 1rem; text-align: center;">
                        <i class="fas fa-inbox" style="font-size: 1.5rem; opacity: 0.5; margin-bottom: 0.5rem; display: block;"></i>
                        <p style="font-size: 0.8rem; color: #999;">No OT records yet</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Set company timezone from backend
    const companyTimezone = '{{ company_timezone }}' || 'Asia/Singapore';
    
    // Submit OT Attendance with proper error handling
    function submitOT(attendanceId, recordDate) {
        if (!confirm(`Submit OT record for ${recordDate} to your reporting manager for approval?`)) {
            return;
        }
        
        // Show loading spinner
        const submitBtn = event.target;
        const originalText = submitBtn.textContent;
        const originalDisabled = submitBtn.disabled;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
        
        // Use Fetch API with timeout handling
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
        
        fetch(`/ot/submit/${attendanceId}`, {
            method: 'POST',
            credentials: 'same-origin',
            signal: controller.signal,
            headers: {
                'Accept': 'text/html'
            },
            redirect: 'follow'  // Important: Follow redirect responses
        })
        .then(response => {
            clearTimeout(timeoutId);
            
            // After following redirect, reload page to show flash messages
            // The backend will redirect to /ot/mark with flash message
            if (response.ok) {
                // Small delay to ensure database commit is complete
                setTimeout(() => {
                    window.location.href = '/ot/mark';
                }, 500);
                return;
            }
            
            // Handle errors
            return response.text().then(text => {
                throw new Error(`Server error: ${response.status} - ${response.statusText}`);
            });
        })
        .catch(error => {
            clearTimeout(timeoutId);
            console.error('Error submitting OT:', error);
            
            // Restore button
            submitBtn.disabled = originalDisabled;
            submitBtn.textContent = originalText;
            
            // Show error to user
            if (error.name === 'AbortError') {
                alert('‚ùå Request timed out. The server took too long to respond. Please try again.');
            } else {
                alert(`‚ùå Error submitting OT:\n\n${error.message}\n\nPlease check the browser console for details.`);
            }
        });
    }

    /**
     * Delete draft OT record with confirmation
     */
    function deleteDraftOT(attendanceId, recordDate) {
        if (!confirm(`Are you sure you want to delete the draft OT record for ${recordDate}? This action cannot be undone.`)) {
            return;
        }
        
        // Show loading spinner
        const deleteBtn = event.target;
        const originalText = deleteBtn.innerHTML;
        const originalDisabled = deleteBtn.disabled;
        deleteBtn.disabled = true;
        deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
        
        // Use Fetch API with timeout handling
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
        
        fetch(`/api/ot/delete-draft/${attendanceId}`, {
            method: 'POST',
            credentials: 'same-origin',
            signal: controller.signal,
            headers: {
                'Accept': 'application/json'
            }
        })
        .then(response => {
            clearTimeout(timeoutId);
            
            if (response.ok) {
                return response.json().then(data => {
                    // Show success message
                    const alertsSection = document.querySelector('.alerts-section');
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-success';
                    alert.innerHTML = `<i class="fas fa-check-circle"></i><span>Draft record deleted successfully</span>`;
                    alertsSection.insertBefore(alert, alertsSection.firstChild);
                    
                    // Remove the record item from DOM
                    const recordItem = deleteBtn.closest('.ot-record-item');
                    if (recordItem) {
                        recordItem.style.animation = 'slideIn 0.4s ease-out reverse';
                        setTimeout(() => recordItem.remove(), 400);
                    }
                    
                    // Auto-dismiss alert after 3 seconds
                    setTimeout(() => {
                        alert.style.animation = 'slideIn 0.4s ease-out reverse';
                        setTimeout(() => alert.remove(), 400);
                    }, 3000);
                });
            }
            
            // Handle errors
            return response.json().then(data => {
                throw new Error(data.message || 'Failed to delete record');
            }).catch(err => {
                throw new Error(`Server error: ${response.status}`);
            });
        })
        .catch(error => {
            clearTimeout(timeoutId);
            console.error('Error deleting draft OT:', error);
            
            // Restore button
            deleteBtn.disabled = originalDisabled;
            deleteBtn.innerHTML = originalText;
            
            // Show error to user
            if (error.name === 'AbortError') {
                alert('‚ùå Request timed out. The server took too long to respond. Please try again.');
            } else {
                alert(`‚ùå Error deleting draft record:\n\n${error.message}\n\nPlease check the browser console for details.`);
            }
        });
    }

    // Timezone mapping with IANA identifiers and display names
    const timezoneMap = {
        'UTC': { iana: 'UTC', display: 'UTC', label: 'UTC' },
        'Asia/Singapore': { iana: 'Asia/Singapore', display: 'SGT (UTC+8)', label: 'Singapore (SGT)' },
        'Asia/Kolkata': { iana: 'Asia/Kolkata', display: 'IST (UTC+5:30)', label: 'India - Kolkata (IST)' },
        'Asia/Bangkok': { iana: 'Asia/Bangkok', display: 'ICT (UTC+7)', label: 'Bangkok (ICT)' },
        'Asia/Jakarta': { iana: 'Asia/Jakarta', display: 'WIB (UTC+7)', label: 'Jakarta (WIB)' },
        'Asia/Kuala_Lumpur': { iana: 'Asia/Kuala_Lumpur', display: 'MYT (UTC+8)', label: 'Malaysia (MYT)' },
        'America/New_York': { iana: 'America/New_York', display: 'EST (UTC-5)', label: 'New York (EST)' },
        'Europe/London': { iana: 'Europe/London', display: 'GMT (UTC+0)', label: 'London (GMT)' },
        'Australia/Sydney': { iana: 'Australia/Sydney', display: 'AEDT (UTC+11)', label: 'Sydney (AEDT)' }
    };

    /**
     * Get current time in a specific timezone
     * Uses Intl API for accurate timezone handling
     */
    function getTimeInTimezone(timezone) {
        try {
            const now = new Date();
            const formatter = new Intl.DateTimeFormat('en-US', {
                timeZone: timezone,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            
            const parts = formatter.formatToParts(now);
            const timeObj = {};
            
            parts.forEach(part => {
                if (part.type !== 'literal') {
                    timeObj[part.type] = part.value;
                }
            });
            
            return {
                hours: timeObj.hour || '00',
                minutes: timeObj.minute || '00',
                seconds: timeObj.second || '00',
                formatted12: new Intl.DateTimeFormat('en-US', {
                    timeZone: timezone,
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                }).format(now)
            };
        } catch (e) {
            console.error(`Error getting time for timezone ${timezone}:`, e);
            return {
                hours: '00',
                minutes: '00',
                seconds: '00',
                formatted12: '--:-- --'
            };
        }
    }

    // [REMOVED] Today's Activity functions removed - section was removed from UI
    // populateTimeline(), createTimelineItem(), updateTimezoneDisplay() - no longer used

    // Prevent future dates
    const dateInput = document.getElementById('ot_date');
    const today = new Date().toISOString().split('T')[0];
    dateInput.max = today;

    /**
     * Update the live clock display
     */
    function updateLiveClock() {
        const timezone = companyTimezone || 'Asia/Singapore';
        const tzInfo = timezoneMap[timezone];
        
        if (!tzInfo) return;
        
        const timeInfo = getTimeInTimezone(timezone);
        const clockElement = document.getElementById('liveClock');
        const tzNameElement = document.getElementById('clockTimezone');
        
        if (clockElement) {
            clockElement.textContent = timeInfo.formatted12;
        }
        if (tzNameElement) {
            tzNameElement.textContent = tzInfo.label;
        }
    }

    /**
     * Set current time in time input with timezone conversion
     */
    function setCurrentTime(fieldId) {
        const timezone = companyTimezone || 'Asia/Singapore';
        const timeInfo = getTimeInTimezone(timezone);
        const currentTime = `${timeInfo.hours}:${timeInfo.minutes}`;
        
        const field = document.getElementById(fieldId);
        field.style.animation = 'none';
        setTimeout(() => {
            field.value = currentTime;
            field.style.animation = 'pulse 0.6s ease-out';
        }, 10);
        
        console.log(`‚úÖ Set ${fieldId} to ${currentTime} (${timeInfo.formatted12}) in ${timezone}`);
    }

    // Switch between time and hours mode
    function switchMode(mode) {
        const timeMode = document.getElementById('timeMode');
        const hoursMode = document.getElementById('hoursMode');
        const buttons = document.querySelectorAll('.switch-btn');
        
        buttons.forEach(btn => btn.classList.remove('active'));
        
        if (mode === 'time') {
            timeMode.classList.remove('hidden');
            hoursMode.classList.add('hidden');
            buttons[0].classList.add('active');
            document.getElementById('ot_hours').value = '';
        } else {
            timeMode.classList.add('hidden');
            hoursMode.classList.remove('hidden');
            buttons[1].classList.add('active');
            document.getElementById('ot_in_time').value = '';
            document.getElementById('ot_out_time').value = '';
        }
    }

    // Form validation with animations
    document.getElementById('otForm').addEventListener('submit', function(e) {
        const ot_date = document.getElementById('ot_date').value;
        const ot_type_id = document.getElementById('ot_type_id').value;
        const ot_in_time = document.getElementById('ot_in_time').value;
        const ot_out_time = document.getElementById('ot_out_time').value;
        const ot_hours = document.getElementById('ot_hours').value;
        
        if (!ot_date) {
            e.preventDefault();
            showErrorMessage('Please select an OT date');
            return false;
        }

        // Validate date is not in future
        const selectedDate = new Date(ot_date);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (selectedDate > today) {
            e.preventDefault();
            showErrorMessage('Future dates are not allowed. Please select today or an earlier date.');
            return false;
        }
        
        if (!ot_type_id) {
            e.preventDefault();
            showErrorMessage('Please select an OT type');
            return false;
        }
        
        const hasTime = ot_in_time && ot_out_time;
        const hasHours = ot_hours;
        
        if (!hasTime && !hasHours) {
            e.preventDefault();
            showErrorMessage('Please provide either OT hours or OT in/out times');
            return false;
        }
        
        if (hasTime && !hasHours) {
            if (ot_out_time <= ot_in_time) {
                e.preventDefault();
                showErrorMessage('Out Time must be after In Time');
                return false;
            }
        }
    });

    function showErrorMessage(message) {
        const alertsSection = document.querySelector('.alerts-section');
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger';
        alert.innerHTML = `<i class="fas fa-exclamation-circle"></i><span>${message}</span>`;
        alertsSection.insertBefore(alert, alertsSection.firstChild);
        
        setTimeout(() => {
            alert.style.animation = 'slideIn 0.4s ease-out reverse';
            setTimeout(() => alert.remove(), 400);
        }, 4000);
    }

    // Add ripple effect to buttons
    document.querySelectorAll('.btn-primary, .btn-secondary, .btn-time-now, .record-submit-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            const ripple = document.createElement('span');
            const rect = this.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = e.clientX - rect.left - size / 2;
            const y = e.clientY - rect.top - size / 2;
            
            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = x + 'px';
            ripple.style.top = y + 'px';
        });
    });

    // ============ SAVE DRAFT FUNCTION ============
    /**
     * Save OT attendance as draft with Set In time only.
     * Allows user to update Set Out time later without losing data.
     */
    async function saveDraft() {
        const otDate = document.getElementById('ot_date').value;
        const otInTime = document.getElementById('ot_in_time').value;
        const otTypeId = document.getElementById('ot_type_id').value;
        const notes = document.getElementById('notes').value;
        
        // Validate required fields for draft
        if (!otDate) {
            showErrorMessage('Please select an OT date');
            return;
        }
        
        if (!otInTime) {
            showErrorMessage('Please set the In Time');
            return;
        }
        
        // Optional: OT type can be added later, but let's require it
        if (!otTypeId) {
            showErrorMessage('Please select an OT type');
            return;
        }
        
        // Validate date is not in future
        // Parse date string as local date (YYYY-MM-DD format)
        const [year, month, day] = otDate.split('-').map(Number);
        const selectedDate = new Date(year, month - 1, day);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (selectedDate > today) {
            showErrorMessage('Future dates are not allowed.');
            return;
        }
        
        // Show loading state
        const saveDraftBtn = document.getElementById('saveDraftBtn');
        const originalText = saveDraftBtn.innerHTML;
        saveDraftBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        saveDraftBtn.disabled = true;
        
        try {
            const response = await fetch('/api/ot/save-draft', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    ot_date: otDate,
                    ot_in_time: otInTime,
                    ot_type_id: otTypeId,
                    notes: notes
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Show success message
                const alertsSection = document.querySelector('.alerts-section');
                const alert = document.createElement('div');
                alert.className = 'alert alert-success';
                alert.innerHTML = `<i class="fas fa-check-circle"></i><span>${data.message}</span>`;
                alertsSection.insertBefore(alert, alertsSection.firstChild);
                
                console.log('[DRAFT SAVED]', data);
                
                // Hide success message after 3 seconds
                setTimeout(() => {
                    alert.style.animation = 'slideIn 0.4s ease-out reverse';
                    setTimeout(() => alert.remove(), 400);
                }, 3000);
            } else {
                showErrorMessage(data.message || 'Failed to save draft');
            }
        } catch (error) {
            console.error('Error saving draft:', error);
            showErrorMessage('Error saving draft: ' + error.message);
        } finally {
            // Restore button state
            saveDraftBtn.innerHTML = originalText;
            saveDraftBtn.disabled = false;
        }
    }
    
    // ============ LOAD DRAFT FUNCTION ============
    /**
     * Load OT draft from database and populate the form.
     * Called when user changes the OT date.
     */
    async function loadDraft(otDate) {
        if (!otDate) return;
        
        try {
            const response = await fetch(`/api/ot/get-draft?ot_date=${otDate}`);
            const data = await response.json();
            
            if (data.success) {
                console.log('[DRAFT LOADED]', data);
                
                // Populate form fields from draft
                if (data.ot_in_time) {
                    document.getElementById('ot_in_time').value = data.ot_in_time;
                    console.log(`[OK] Loaded Set In: ${data.ot_in_time}`);
                }
                
                if (data.ot_out_time) {
                    document.getElementById('ot_out_time').value = data.ot_out_time;
                    console.log(`[OK] Loaded Set Out: ${data.ot_out_time}`);
                    // Switch to time mode if we have times
                    switchMode('time');
                }
                
                if (data.ot_hours) {
                    document.getElementById('ot_hours').value = data.ot_hours;
                    console.log(`[OK] Loaded OT Hours: ${data.ot_hours}`);
                    switchMode('hours');
                }
                
                if (data.ot_type_id) {
                    document.getElementById('ot_type_id').value = data.ot_type_id;
                    console.log(`[OK] Loaded OT Type ID: ${data.ot_type_id}`);
                }
                
                if (data.notes) {
                    document.getElementById('notes').value = data.notes;
                    console.log(`[OK] Loaded Notes: ${data.notes}`);
                }
                
                // Show info message
                const alertsSection = document.querySelector('.alerts-section');
                const alert = document.createElement('div');
                alert.className = 'alert alert-info';
                alert.innerHTML = `<i class="fas fa-info-circle"></i><span>Draft loaded for ${otDate}. You can now add Set Out time and submit.</span>`;
                alertsSection.insertBefore(alert, alertsSection.firstChild);
                
                // Auto-hide info message
                setTimeout(() => {
                    alert.style.animation = 'slideIn 0.4s ease-out reverse';
                    setTimeout(() => alert.remove(), 400);
                }, 4000);
            }
        } catch (error) {
            console.log('No draft found for this date (this is normal):', error.message);
        }
    }

    // Initialize page on load
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize displays
        updateLiveClock();
        
        // Load draft for today's date if it exists
        const todayDate = document.getElementById('ot_date').value;
        if (todayDate) {
            loadDraft(todayDate);
        }
        
        // Start live clock update (every second)
        const clockInterval = setInterval(updateLiveClock, 1000);
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            clearInterval(clockInterval);
        });
        
        // Load draft when OT date changes
        document.getElementById('ot_date').addEventListener('change', function() {
            loadDraft(this.value);
        });
    });

    // Log time changes with company timezone
    document.getElementById('ot_in_time').addEventListener('change', function() {
        console.log(`[OK] In Time set: ${this.value} [${companyTimezone}]`);
    });

    document.getElementById('ot_out_time').addEventListener('change', function() {
        console.log(`[OK] Out Time set: ${this.value} [${companyTimezone}]`);
    });
</script>
{% endblock %}