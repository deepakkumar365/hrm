{% extends "base.html" %}

{% block title %}My Documents - Nexar{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/documents.css') }}">
{% endblock %}

{% block content %}
<div class="documents-page">

    <!-- Header -->
    <div class="documents-header-row">
        <div class="documents-title">
            <h1>My Documents</h1>
            <p>Access and manage your important employment records</p>
        </div>
    </div>

    {% set has_docs = offer_letters or appraisal_letters or salary_slips or other_documents %}

    {% if has_docs %}
    <!-- Filter & Search Bar -->
    <div class="filters-bar">
        <div class="search-wrapper">
            <i class="fas fa-search"></i>
            <input type="text" class="doc-search-input" id="docSearch" placeholder="Search documents...">
        </div>

        <div class="filter-pills" id="docFilters">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="offer">Offer Letters</button>
            <button class="filter-btn" data-filter="appraisal">Appraisals</button>
            <button class="filter-btn" data-filter="salary">Salary Slips</button>
            <button class="filter-btn" data-filter="other">Other</button>
        </div>

        <div class="view-toggles">
            <button class="toggle-btn active" id="btnGrid" title="Grid View"><i class="fas fa-th-large"></i></button>
            <button class="toggle-btn" id="btnList" title="List View"><i class="fas fa-list"></i></button>
        </div>
    </div>

    <!-- Empty State (Global: Search Results) -->
    <div class="empty-state-doc" id="globalEmptyState" style="display: none;">
        <i class="far fa-folder-open" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
        <h3>No documents found</h3>
        <p>Try adjusting your search or filters.</p>
    </div>

    <!-- GRID VIEW -->
    <div class="documents-grid" id="docGrid">

        <!-- Loop: Offer Letters -->
        {% for doc in offer_letters %}
        <div class="doc-card" data-type="offer" data-name="{{ doc.description or 'Offer Letter' }}">
            <div class="doc-card-icon type-offer">
                <i class="fas fa-file-contract"></i>
            </div>
            <div class="doc-card-info">
                <div class="doc-card-title">{{ doc.description or 'Offer Letter' }}</div>
                <div class="doc-card-meta">
                    <span>Offer Letter</span>
                    <span>{{ doc.issue_date.strftime('%d %b %Y') if doc.issue_date else '-' }}</span>
                </div>
            </div>
            <div class="doc-card-actions">
                <a href="{{ url_for('download_document', document_id=doc.id) }}" class="btn-download-card">
                    <i class="fas fa-download"></i> <span>Download</span>
                </a>
            </div>
        </div>
        {% endfor %}

        <!-- Loop: Appraisal Letters -->
        {% for doc in appraisal_letters %}
        <div class="doc-card" data-type="appraisal" data-name="{{ doc.description or 'Appraisal Letter' }}">
            <div class="doc-card-icon type-appraisal">
                <i class="fas fa-award"></i>
            </div>
            <div class="doc-card-info">
                <div class="doc-card-title">{{ doc.description or 'Appraisal Letter' }}</div>
                <div class="doc-card-meta">
                    <span>Appraisal</span>
                    <span>{{ doc.issue_date.strftime('%d %b %Y') if doc.issue_date else '-' }}</span>
                </div>
            </div>
            <div class="doc-card-actions">
                <a href="{{ url_for('download_document', document_id=doc.id) }}" class="btn-download-card">
                    <i class="fas fa-download"></i> <span>Download</span>
                </a>
            </div>
        </div>
        {% endfor %}

        <!-- Loop: Salary Slips -->
        {% for doc in salary_slips %}
        <div class="doc-card" data-type="salary"
            data-name="{{ doc.description or 'Salary Slip' }} {{ doc.year }} {{ doc.month }}">
            <div class="doc-card-icon type-salary">
                <i class="fas fa-file-invoice-dollar"></i>
            </div>
            <div class="doc-card-info">
                <div class="doc-card-title">
                    {{ doc.description or 'Salary Slip' }}
                    {% if doc.month and doc.year %}
                    {{ ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov',
                    'Dec'][doc.month] }} {{ doc.year }}
                    {% endif %}
                </div>
                <div class="doc-card-meta">
                    <span>Salary Slip</span>
                    <span>{{ doc.year }}</span>
                </div>
            </div>
            <div class="doc-card-actions">
                <a href="{{ url_for('download_document', document_id=doc.id) }}" class="btn-download-card">
                    <i class="fas fa-download"></i> <span>Download</span>
                </a>
            </div>
        </div>
        {% endfor %}

        <!-- Loop: Other Documents -->
        {% for doc in other_documents %}
        <div class="doc-card" data-type="other" data-name="{{ doc.description or 'Document' }}">
            <div class="doc-card-icon type-other">
                <i class="fas fa-file-alt"></i>
            </div>
            <div class="doc-card-info">
                <div class="doc-card-title">{{ doc.description or doc.document_type }}</div>
                <div class="doc-card-meta">
                    <span>{{ doc.document_type }}</span>
                    <span>{{ doc.issue_date.strftime('%d %b %Y') if doc.issue_date else '-' }}</span>
                </div>
            </div>
            <div class="doc-card-actions">
                <a href="{{ url_for('download_document', document_id=doc.id) }}" class="btn-download-card">
                    <i class="fas fa-download"></i> <span>Download</span>
                </a>
            </div>
        </div>
        {% endfor %}

    </div>

    <!-- LIST VIEW -->
    <div class="documents-list" id="docList">
        <div class="table-responsive">
            <table class="doc-table">
                <thead>
                    <tr>
                        <th>Document Name</th>
                        <th>Type</th>
                        <th>Date</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="docListBody">
                    <!-- Loop: Offer Letters -->
                    {% for doc in offer_letters %}
                    <tr data-type="offer" data-name="{{ doc.description or 'Offer Letter' }}">
                        <td>
                            <div style="display: flex; align-items: center;">
                                <div class="list-icon type-offer"><i class="fas fa-file-contract"></i></div>
                                <span>{{ doc.description or 'Offer Letter' }}</span>
                            </div>
                        </td>
                        <td>Offer Letter</td>
                        <td>{{ doc.issue_date.strftime('%d %b %Y') if doc.issue_date else '-' }}</td>
                        <td>
                            <a href="{{ url_for('download_document', document_id=doc.id) }}" class="btn-icon-action"
                                title="Download">
                                <i class="fas fa-download"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}

                    <!-- Loop: Appraisal Letters -->
                    {% for doc in appraisal_letters %}
                    <tr data-type="appraisal" data-name="{{ doc.description or 'Appraisal Letter' }}">
                        <td>
                            <div style="display: flex; align-items: center;">
                                <div class="list-icon type-appraisal"><i class="fas fa-award"></i></div>
                                <span>{{ doc.description or 'Appraisal Letter' }}</span>
                            </div>
                        </td>
                        <td>Appraisal</td>
                        <td>{{ doc.issue_date.strftime('%d %b %Y') if doc.issue_date else '-' }}</td>
                        <td>
                            <a href="{{ url_for('download_document', document_id=doc.id) }}" class="btn-icon-action"
                                title="Download">
                                <i class="fas fa-download"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}

                    <!-- Loop: Salary Slips -->
                    {% for doc in salary_slips %}
                    <tr data-type="salary"
                        data-name="{{ doc.description or 'Salary Slip' }} {{ doc.year }} {{ doc.month }}">
                        <td>
                            <div style="display: flex; align-items: center;">
                                <div class="list-icon type-salary"><i class="fas fa-file-invoice-dollar"></i></div>
                                <span>
                                    {{ doc.description or 'Salary Slip' }}
                                    {% if doc.month and doc.year %}
                                    - {{ ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct',
                                    'Nov', 'Dec'][doc.month] }} {{ doc.year }}
                                    {% endif %}
                                </span>
                            </div>
                        </td>
                        <td>Salary Slip</td>
                        <td>{{ doc.year }}</td>
                        <td>
                            <a href="{{ url_for('download_document', document_id=doc.id) }}" class="btn-icon-action"
                                title="Download">
                                <i class="fas fa-download"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}

                    <!-- Loop: Other Documents -->
                    {% for doc in other_documents %}
                    <tr data-type="other" data-name="{{ doc.description or 'Document' }}">
                        <td>
                            <div style="display: flex; align-items: center;">
                                <div class="list-icon type-other"><i class="fas fa-file-alt"></i></div>
                                <span>{{ doc.description or doc.document_type }}</span>
                            </div>
                        </td>
                        <td>{{ doc.document_type }}</td>
                        <td>{{ doc.issue_date.strftime('%d %b %Y') if doc.issue_date else '-' }}</td>
                        <td>
                            <a href="{{ url_for('download_document', document_id=doc.id) }}" class="btn-icon-action"
                                title="Download">
                                <i class="fas fa-download"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {% else %}
    <!-- Empty State Hero (No Documents Yet) -->
    <div class="empty-state-hero">
        <i class="far fa-folder-open"></i>
        <h3>You haven't received any documents yet</h3>
        <p>Once HR uploads your offer letters, appraisals, or salary slips, they will appear here safely.</p>
    </div>
    {% endif %}

</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const searchInput = document.getElementById('docSearch');
        const filterBtns = document.querySelectorAll('.filter-btn');
        const btnGrid = document.getElementById('btnGrid');
        const btnList = document.getElementById('btnList');
        const docGrid = document.getElementById('docGrid');
        const docList = document.getElementById('docList');
        const emptyState = document.getElementById('globalEmptyState');

        // View Toggle
        function switchView(view) {
            if (view === 'grid') {
                docGrid.style.display = 'grid'; // Force grid layout style
                docList.style.display = 'none';
                btnGrid.classList.add('active');
                btnList.classList.remove('active');
            } else {
                docGrid.style.display = 'none';
                docList.style.display = 'block';
                btnGrid.classList.remove('active');
                btnList.classList.add('active');
            }
            // Check empty state visibility after switch (though filter handles it mostly)
            filterDocuments();
        }

        btnGrid.addEventListener('click', () => switchView('grid'));
        btnList.addEventListener('click', () => switchView('list'));

        // Filtering Logic
        function filterDocuments() {
            const searchTerm = searchInput.value.toLowerCase();
            const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;

            let visibleCount = 0;

            // Helper to check and toggle visibility
            const checkItem = (item) => {
                const type = item.dataset.type;
                const name = item.dataset.name ? item.dataset.name.toLowerCase() : '';

                const matchesSearch = name.includes(searchTerm);
                const matchesFilter = activeFilter === 'all' || type === activeFilter;

                if (matchesSearch && matchesFilter) {
                    item.style.display = ''; // Reset display
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            };

            // Filter Grid Items
            document.querySelectorAll('.doc-card').forEach(checkItem);

            // Filter List Rows
            document.querySelectorAll('#docListBody tr').forEach(checkItem);

            // Show/Hide Empty State
            if (visibleCount === 0) {
                emptyState.style.display = 'block';
                docGrid.style.display = 'none';
                docList.style.display = 'none';
            } else {
                emptyState.style.display = 'none';
                // Restore logic for current view
                if (btnGrid.classList.contains('active')) {
                    docGrid.style.display = 'grid'; // Restore grid
                    docList.style.display = 'none';
                } else {
                    docGrid.style.display = 'none';
                    docList.style.display = 'block';
                }
            }
        }

        // Search Event
        searchInput.addEventListener('input', filterDocuments);

        // Filter Pills Event
        filterBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                filterBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                filterDocuments();
            });
        });

        // Initialize (Handle mobile forcing in CSS, but here ensures logic runs)
        filterDocuments();
    });
</script>
{% endblock %}