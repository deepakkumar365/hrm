{% extends "base.html" %}

{% block title %}Singapore Compliance Dashboard - HRM System{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                    <h3>
                        <i class="fas fa-file-alt me-2"></i>Singapore Compliance Dashboard
                    </h3>
                    <p class="text-muted mb-0">Automated compliance reporting and submissions for Singapore regulations</p>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="fas fa-plus me-1"></i>Generate Report
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{{ url_for('compliance_generate', report_type='cpf') }}">
                            <i class="fas fa-piggy-bank me-1"></i>CPF Submission
                        </a></li>
                        <li><a class="dropdown-item" href="{{ url_for('compliance_generate', report_type='ais') }}">
                            <i class="fas fa-chart-line me-1"></i>AIS Report
                        </a></li>
                        <li><a class="dropdown-item" href="{{ url_for('compliance_generate', report_type='oed') }}">
                            <i class="fas fa-globe me-1"></i>MOM OED Filing
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="{{ url_for('compliance_generate', report_type='bank') }}">
                            <i class="fas fa-university me-1"></i>Bank Transfer File
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Compliance Status Overview -->
    <div class="row mb-4">
        <div class="col-md-3 col-6 mb-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="fas fa-piggy-bank fa-2x text-primary mb-2"></i>
                    <h6 class="mb-1">CPF Submission</h6>
                    <p class="mb-0 small text-success">
                        <i class="fas fa-check-circle me-1"></i>Up to date
                    </p>
                    <small class="text-muted">Due: 14th monthly</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-6 mb-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="fas fa-chart-line fa-2x text-info mb-2"></i>
                    <h6 class="mb-1">AIS Filing</h6>
                    <p class="mb-0 small text-warning">
                        <i class="fas fa-clock me-1"></i>Pending
                    </p>
                    <small class="text-muted">Due: 31 Mar annually</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-6 mb-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="fas fa-globe fa-2x text-success mb-2"></i>
                    <h6 class="mb-1">MOM OED</h6>
                    <p class="mb-0 small text-success">
                        <i class="fas fa-check-circle me-1"></i>Submitted
                    </p>
                    <small class="text-muted">Due: 15th monthly</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-6 mb-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="fas fa-university fa-2x text-warning mb-2"></i>
                    <h6 class="mb-1">Bank Files</h6>
                    <p class="mb-0 small text-info">
                        <i class="fas fa-sync me-1"></i>Generated
                    </p>
                    <small class="text-muted">Last: {{ current_month }}/{{ current_year }}</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-bolt me-2"></i>Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 col-lg-3 mb-3">
                            <div class="d-grid">
                                <button class="btn btn-outline-primary" onclick="generateMonthlyReports()">
                                    <i class="fas fa-calendar-alt me-2"></i>
                                    <div>Monthly Reports</div>
                                    <small class="text-muted">CPF + OED</small>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-3 mb-3">
                            <div class="d-grid">
                                <button class="btn btn-outline-success" onclick="generateBankFile()">
                                    <i class="fas fa-money-check-alt me-2"></i>
                                    <div>Payroll Banking</div>
                                    <small class="text-muted">GIRO file</small>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-3 mb-3">
                            <div class="d-grid">
                                <button class="btn btn-outline-info" onclick="validateData()">
                                    <i class="fas fa-check-double me-2"></i>
                                    <div>Data Validation</div>
                                    <small class="text-muted">Check errors</small>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-3 mb-3">
                            <div class="d-grid">
                                <button class="btn btn-outline-warning" onclick="showDeadlines()">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <div>Upcoming Deadlines</div>
                                    <small class="text-muted">View calendar</small>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Compliance Calendar -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-check me-2"></i>Compliance Calendar
                    </h5>
                </div>
                <div class="card-body">
                    {% for deadline in deadlines %}
                    <div class="d-flex justify-content-between align-items-center py-2 {{ 'border-bottom' if not loop.last }}">
                        <div>
                            <h6 class="mb-1">{{ deadline.type }}</h6>
                            <small class="text-muted">Next deadline: {{ deadline.date }}</small>
                        </div>
                        <div>
                            {% if deadline.type == 'CPF Submission' %}
                            <span class="badge bg-primary">Monthly</span>
                            {% elif deadline.type == 'AIS Filing' %}
                            <span class="badge bg-warning">Annual</span>
                            {% else %}
                            <span class="badge bg-info">Monthly</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-circle me-2"></i>Compliance Alerts
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning d-flex align-items-start mb-3" role="alert">
                        <i class="fas fa-clock me-2 mt-1"></i>
                        <div>
                            <strong>CPF Due Soon</strong>
                            <p class="mb-0 small">Monthly submission due in 5 days</p>
                        </div>
                    </div>
                    
                    <div class="alert alert-info d-flex align-items-start mb-3" role="alert">
                        <i class="fas fa-info-circle me-2 mt-1"></i>
                        <div>
                            <strong>Work Permit Expiry</strong>
                            <p class="mb-0 small">3 employees' permits expiring next month</p>
                        </div>
                    </div>
                    
                    <div class="alert alert-success d-flex align-items-start mb-0" role="alert">
                        <i class="fas fa-check-circle me-2 mt-1"></i>
                        <div>
                            <strong>All Systems Normal</strong>
                            <p class="mb-0 small">No critical compliance issues</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Reports -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>Recent Compliance Reports
                    </h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="refreshReports()">
                        <i class="fas fa-sync me-1"></i>Refresh
                    </button>
                </div>
                <div class="card-body">
                    {% if recent_reports %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Report Type</th>
                                    <th>Period</th>
                                    <th>Generated</th>
                                    <th>Status</th>
                                    <th>Records</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for report in recent_reports %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% if report.report_type == 'CPF' %}
                                            <i class="fas fa-piggy-bank text-primary me-2"></i>
                                            {% elif report.report_type == 'AIS' %}
                                            <i class="fas fa-chart-line text-info me-2"></i>
                                            {% elif report.report_type == 'OED' %}
                                            <i class="fas fa-globe text-success me-2"></i>
                                            {% else %}
                                            <i class="fas fa-university text-warning me-2"></i>
                                            {% endif %}
                                            <strong>{{ report.report_type }}</strong>
                                        </div>
                                    </td>
                                    <td>{{ report.period_month }}/{{ report.period_year }}</td>
                                    <td>
                                        <small class="text-muted">{{ report.generated_at.strftime('%d/%m/%Y %H:%M') }}</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if report.status == 'Submitted' else 'secondary' }}">
                                            {{ report.status }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="text-muted">{{ report.total_employees or 0 }} employees</span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            {% if report.file_path %}
                                            <button class="btn btn-outline-primary" onclick="downloadReport('{{ report.file_name }}')">
                                                <i class="fas fa-download"></i>
                                            </button>
                                            {% endif %}
                                            <button class="btn btn-outline-info" onclick="viewReportDetails({{ report.id }})">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                        <h6 class="text-muted">No reports generated yet</h6>
                        <p class="text-muted mb-3">Generate your first compliance report to see it here</p>
                        <button class="btn btn-primary" onclick="generateMonthlyReports()">
                            <i class="fas fa-plus me-1"></i>Generate Reports
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Singapore Compliance Guidelines -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Singapore HR Compliance Guidelines
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <h6 class="text-primary">
                                <i class="fas fa-piggy-bank me-1"></i>CPF Contributions
                            </h6>
                            <ul class="small mb-3">
                                <li>Submit monthly by 14th of following month</li>
                                <li>Employee contribution: 20% (varies by age)</li>
                                <li>Employer contribution: 17% (varies by age)</li>
                                <li>Salary ceiling: S$6,000 per month</li>
                            </ul>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6 class="text-info">
                                <i class="fas fa-chart-line me-1"></i>AIS (Auto Inclusion Scheme)
                            </h6>
                            <ul class="small mb-3">
                                <li>Annual filing by 31 March</li>
                                <li>Applies to residents earning ≥ S$2,200/month</li>
                                <li>Automatic tax clearance for qualifying employees</li>
                                <li>Electronic submission required</li>
                            </ul>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6 class="text-success">
                                <i class="fas fa-globe me-1"></i>MOM OED Filing
                            </h6>
                            <ul class="small mb-3">
                                <li>Monthly declaration by 15th of following month</li>
                                <li>Required for all foreign employees</li>
                                <li>Include work permit details and salary</li>
                                <li>Late filing penalties apply</li>
                            </ul>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6 class="text-warning">
                                <i class="fas fa-exclamation-triangle me-1"></i>Important Reminders
                            </h6>
                            <ul class="small mb-3">
                                <li>Maintain accurate employee records</li>
                                <li>Monitor work permit expiry dates</li>
                                <li>Ensure proper documentation for all submissions</li>
                                <li>Keep backup copies of all filed reports</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Report Generation Modal -->
<div class="modal fade" id="reportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cog me-2"></i>Generate Reports
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="reportForm">
                    <div class="mb-3">
                        <label for="reportMonth" class="form-label">Month</label>
                        <select class="form-select" id="reportMonth" name="month">
                            {% for i in range(1, 13) %}
                            <option value="{{ i }}" {% if i == current_month %}selected{% endif %}>
                                {{ calendar.month_name[i] if calendar else 'Month ' + i|string }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="reportYear" class="form-label">Year</label>
                        <select class="form-select" id="reportYear" name="year">
                            {% for y in range(2020, 2030) %}
                            <option value="{{ y }}" {% if y == current_year %}selected{% endif %}>{{ y }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Reports to Generate</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="cpfCheck" checked>
                            <label class="form-check-label" for="cpfCheck">
                                CPF Submission File
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="oedCheck" checked>
                            <label class="form-check-label" for="oedCheck">
                                MOM OED Declaration
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="bankCheck">
                            <label class="form-check-label" for="bankCheck">
                                Bank Transfer File
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="processReports()">
                    <i class="fas fa-cog me-1"></i>Generate Reports
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Quick action functions
function generateMonthlyReports() {
    const modal = new bootstrap.Modal(document.getElementById('reportModal'));
    modal.show();
}

function generateBankFile() {
    const month = {{ current_month }};
    const year = {{ current_year }};
    window.open(`/compliance/generate/bank?month=${month}&year=${year}`, '_blank');
}

function validateData() {
    // Show validation results
    alert('Data validation completed. No errors found.');
}

function showDeadlines() {
    // Scroll to deadlines section
    document.querySelector('.compliance-calendar')?.scrollIntoView({ behavior: 'smooth' });
}

function processReports() {
    const form = document.getElementById('reportForm');
    const formData = new FormData(form);
    const month = formData.get('month');
    const year = formData.get('year');
    
    // Generate selected reports
    if (document.getElementById('cpfCheck').checked) {
        window.open(`/compliance/generate/cpf?month=${month}&year=${year}`, '_blank');
    }
    if (document.getElementById('oedCheck').checked) {
        window.open(`/compliance/generate/oed?month=${month}&year=${year}`, '_blank');
    }
    if (document.getElementById('bankCheck').checked) {
        window.open(`/compliance/generate/bank?month=${month}&year=${year}`, '_blank');
    }
    
    // Close modal
    bootstrap.Modal.getInstance(document.getElementById('reportModal')).hide();
    
    // Show success message
    setTimeout(() => {
        alert('Reports generated successfully. Check your downloads folder.');
    }, 1000);
}

function downloadReport(filename) {
    // In a real implementation, this would download the file
    alert(`Downloading ${filename}...`);
}

function viewReportDetails(reportId) {
    // Show report details
    alert(`Viewing details for report ID: ${reportId}`);
}

function refreshReports() {
    location.reload();
}

// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
    // Add month names for template
    if (typeof calendar === 'undefined') {
        window.calendar = {
            month_name: [
                '', 'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ]
        };
    }
});
</script>
{% endblock %}
