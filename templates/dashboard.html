{% extends "base.html" %}

{% block title %}Dashboard - Noltrion{% endblock %}

{% block content %}
<div class="dashboard-wrapper">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-4">
            <div>
                <h1 class="dashboard-title">{{ current_user.first_name or 'Team Member' }}!</h1>
            </div>
            <div class="d-flex gap-3">
                <a href="{{ url_for('attendance_mark') }}" class="btn btn-primary">
                    <i class="fas fa-clock"></i>
                    Mark Attendance
                </a>
                <a href="{{ url_for('leave_request') }}" class="btn btn-outline-primary">
                    <i class="fas fa-plane-departure"></i>
                    Request Leave
                </a>
            </div>
        </div>
    </div>

    <!-- Key Metrics Grid -->
    <div class="dashboard-grid mb-8">
        <!-- Attendance Rate -->
        <div class="col-span-3">
            <div class="stat-card">
                <div class="stat-card-icon primary">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <div class="stat-card-value">{{ stats.attendance_rate if stats.attendance_rate is defined else stats.attendance_percentage if stats.attendance_percentage is defined else '95' }}%</div>
                <div class="stat-card-label">Attendance Rate</div>
                <div class="stat-card-change positive">
                    <i class="fas fa-arrow-up"></i>
                    +2.5% from last month
                </div>
            </div>
        </div>

        <!-- Leave Balance -->
        <div class="col-span-3">
            <div class="stat-card">
                <div class="stat-card-icon success">
                    <i class="fas fa-leaf"></i>
                </div>
                <div class="stat-card-value">{{ stats.leave_balance if stats.leave_balance is defined else '12' }}</div>
                <div class="stat-card-label">Days Leave Balance</div>
                <div class="stat-card-change">
                    <i class="fas fa-info-circle"></i>
                    {{ stats.leave_balance_text if stats.leave_balance_text is defined else 'Annual leave remaining' }}
                </div>
            </div>
        </div>

        <!-- This Month Leaves -->
        <div class="col-span-3">
            <div class="stat-card">
                <div class="stat-card-icon warning">
                    <i class="fas fa-calendar-times"></i>
                </div>
                <div class="stat-card-value">{{ stats.leaves_taken_month if stats.leaves_taken_month is defined else '2' }}</div>
                <div class="stat-card-label">Leaves This Month</div>
                <div class="stat-card-change">
                    <i class="fas fa-calendar"></i>
                    {{ stats.upcoming_leaves if stats.upcoming_leaves is defined else '1' }} upcoming
                </div>
            </div>
        </div>

        <!-- Working Hours -->
        <div class="col-span-3">
            <div class="stat-card">
                <div class="stat-card-icon primary">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-card-value">{{ stats.working_hours if stats.working_hours is defined else '8.5' }}h</div>
                <div class="stat-card-label">Avg. Daily Hours</div>
                <div class="stat-card-change positive">
                    <i class="fas fa-arrow-up"></i>
                    On track this week
                </div>
            </div>
        </div>
    </div>

    <!-- Charts and Analytics -->
    <div class="dashboard-grid">
        <!-- Attendance Trend Chart -->
        <div class="col-span-8">
            <div class="chart-card">
                <div class="chart-card-header">
                    <div>
                        <h3 class="chart-card-title">Attendance Trend</h3>
                        <p class="text-muted mb-0">Monthly attendance percentage over the last 6 months</p>
                    </div>
                    <div class="badge bg-success">{{ stats.attendance_rate if stats.attendance_rate is defined else '95' }}% This Month</div>
                </div>
                <div class="chart-container">
                    <canvas id="attendanceTrendChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Leave Summary -->
        <div class="col-span-4">
            <div class="chart-card">
                <div class="chart-card-header">
                    <h3 class="chart-card-title">Leave Summary</h3>
                    <p class="text-muted mb-0">Annual leave breakdown</p>
                </div>
                <div class="chart-container">
                    <canvas id="leaveSummaryChart"></canvas>
                </div>
                <div class="mt-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted">Used</span>
                        <span class="fw-semibold">{{ stats.leave_used if stats.leave_used is defined else '8' }} days</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted">Remaining</span>
                        <span class="fw-semibold">{{ stats.leave_balance if stats.leave_balance is defined else '12' }} days</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted">Total Allocation</span>
                        <span class="fw-semibold">{{ stats.leave_total if stats.leave_total is defined else '20' }} days</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity and Quick Actions -->
    <div class="dashboard-grid">
        <!-- Recent Activity -->
        <div class="col-span-8">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Recent Activity</h3>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center gap-3 mb-3">
                        <div class="stat-card-icon success" style="width: 40px; height: 40px; font-size: 1rem;">
                            <i class="fas fa-check"></i>
                        </div>
                        <div>
                            <div class="fw-semibold">Attendance marked for today</div>
                            <div class="text-muted small">{{ moment().strftime('%I:%M %p') if moment else '9:15 AM' }} - On time</div>
                        </div>
                    </div>
                    <div class="d-flex align-items-center gap-3 mb-3">
                        <div class="stat-card-icon primary" style="width: 40px; height: 40px; font-size: 1rem;">
                            <i class="fas fa-plane-departure"></i>
                        </div>
                        <div>
                            <div class="fw-semibold">Leave request approved</div>
                            <div class="text-muted small">Annual Leave - Dec 25-26, 2024</div>
                        </div>
                    </div>
                    <div class="d-flex align-items-center gap-3">
                        <div class="stat-card-icon warning" style="width: 40px; height: 40px; font-size: 1rem;">
                            <i class="fas fa-bell"></i>
                        </div>
                        <div>
                            <div class="fw-semibold">Reminder: Team meeting</div>
                            <div class="text-muted small">Tomorrow at 2:00 PM - Conference Room A</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="col-span-4">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Quick Actions</h3>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-3">
                        <a href="{{ url_for('attendance_list') }}" class="btn btn-outline-primary d-flex align-items-center gap-2">
                            <i class="fas fa-list"></i>
                            View Attendance Records
                        </a>
                        <a href="{{ url_for('leave_list') }}" class="btn btn-outline-primary d-flex align-items-center gap-2">
                            <i class="fas fa-calendar-alt"></i>
                            My Leave Requests
                        </a>
                        {% if hasattr(current_user, 'employee_profile') and current_user.employee_profile %}
                        <a href="{{ url_for('profile') }}" class="btn btn-outline-primary d-flex align-items-center gap-2">
                            <i class="fas fa-user"></i>
                            Update Profile
                        </a>
                        {% endif %}
                        {% if current_user.role in ['Super Admin', 'Admin', 'Manager'] %}
                        <a href="{{ url_for('employee_list') }}" class="btn btn-outline-secondary d-flex align-items-center gap-2">
                            <i class="fas fa-users"></i>
                            Manage Employees
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upcoming Events -->
    <div class="dashboard-grid">
        <div class="col-span-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="card-title">Upcoming Events & Reminders</h3>
                        <a href="#" class="btn btn-sm btn-outline-primary">View Calendar</a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-4">
                            <div class="d-flex align-items-center gap-3">
                                <div class="stat-card-icon primary" style="width: 48px; height: 48px;">
                                    <i class="fas fa-calendar"></i>
                                </div>
                                <div>
                                    <div class="fw-semibold">Next Leave Day</div>
                                    <div class="text-muted">{{ stats.next_leave_date if stats.next_leave_date is defined else 'December 25, 2024' }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-center gap-3">
                                <div class="stat-card-icon warning" style="width: 48px; height: 48px;">
                                    <i class="fas fa-birthday-cake"></i>
                                </div>
                                <div>
                                    <div class="fw-semibold">Team Birthday</div>
                                    <div class="text-muted">Sarah's birthday - Dec 22</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-center gap-3">
                                <div class="stat-card-icon success" style="width: 48px; height: 48px;">
                                    <i class="fas fa-trophy"></i>
                                </div>
                                <div>
                                    <div class="fw-semibold">Company Event</div>
                                    <div class="text-muted">Year-end celebration - Dec 30</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Attendance Trend Chart
    const attendanceCtx = document.getElementById('attendanceTrendChart');
    if (attendanceCtx) {
        const attendanceLabels = {{ stats.attendance_labels|tojson(indent=0) if stats is defined and stats.attendance_labels is defined else ['Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']|tojson(indent=0) }};
        const attendanceData = {{ stats.attendance_data|tojson(indent=0) if stats is defined and stats.attendance_data is defined else [92, 95, 88, 94, 97, 95]|tojson(indent=0) }};

        new Chart(attendanceCtx, {
            type: 'line',
            data: {
                labels: attendanceLabels,
                datasets: [{
                    label: 'Attendance %',
                    data: attendanceData,
                    tension: 0.4,
                    fill: true,
                    backgroundColor: 'rgba(45, 106, 79, 0.1)',
                    borderColor: 'var(--primary-green)',
                    borderWidth: 3,
                    pointBackgroundColor: 'var(--primary-green)',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 6,
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'var(--white)',
                        titleColor: 'var(--grey-800)',
                        bodyColor: 'var(--grey-700)',
                        borderColor: 'var(--grey-200)',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: false,
                        callbacks: {
                            label: function(context) {
                                return `${context.parsed.y}% attendance`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            stepSize: 20,
                            callback: function(value) {
                                return value + '%';
                            },
                            color: 'var(--grey-500)',
                            font: {
                                family: 'Inter',
                                size: 12
                            }
                        },
                        grid: {
                            color: 'var(--grey-200)',
                            drawBorder: false
                        }
                    },
                    x: {
                        ticks: {
                            color: 'var(--grey-500)',
                            font: {
                                family: 'Inter',
                                size: 12
                            }
                        },
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }

    // Leave Summary Doughnut Chart
    const leaveCtx = document.getElementById('leaveSummaryChart');
    if (leaveCtx) {
        const leaveUsed = {{ stats.leave_used if stats.leave_used is defined else 8 }};
        const leaveBalance = {{ stats.leave_balance if stats.leave_balance is defined else 12 }};

        new Chart(leaveCtx, {
            type: 'doughnut',
            data: {
                labels: ['Used', 'Remaining'],
                datasets: [{
                    data: [leaveUsed, leaveBalance],
                    backgroundColor: [
                        'var(--primary-green)',
                        'var(--success-green)'
                    ],
                    borderWidth: 0,
                    cutout: '70%'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            pointStyle: 'circle',
                            padding: 20,
                            font: {
                                family: 'Inter',
                                size: 12
                            },
                            color: 'var(--grey-700)'
                        }
                    },
                    tooltip: {
                        backgroundColor: 'var(--white)',
                        titleColor: 'var(--grey-800)',
                        bodyColor: 'var(--grey-700)',
                        borderColor: 'var(--grey-200)',
                        borderWidth: 1,
                        cornerRadius: 8,
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.parsed} days`;
                            }
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}