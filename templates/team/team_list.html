{% extends "base.html" %}

{% block title %}My Team - Nexar{% endblock %}

{% block content %}
<div class="dashboard-wrapper">
    <!-- Header -->
    <div class="dashboard-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-4">
            <div>
                <h1 class="dashboard-title">My Team</h1>
                {% if is_manager_view %}
                <p class="dashboard-subtitle">Your direct reports and team members</p>
                {% else %}
                <p class="dashboard-subtitle">Connect and collaborate with your team members</p>
                {% endif %}
            </div>
            <div class="team-stats-mini">
                <div class="team-stat-badge">
                    <i class="fas fa-users"></i>
                    <span>{{ team_members|length if team_members else 0 }} {% if is_manager_view %}Direct Reports{% else %}Members{% endif %}</span>
                </div>
            </div>
        </div>
    </div>

    {% if team_members %}
    <!-- Team Members Cards - Enhanced Design -->
    <div class="team-grid">
        {% for member in team_members %}
        <div class="team-member-card">
            <div class="team-card-header">
                <!-- Profile Photo -->
                <div class="team-member-avatar">
                    {% if member.photo %}
                    <img src="{{ url_for('static', filename='uploads/photos/' + member.photo) }}" 
                         alt="{{ member.first_name }}" 
                         class="avatar-image">
                    {% else %}
                    <div class="avatar-placeholder">
                        {{ member.first_name[0] }}{{ member.last_name[0] if member.last_name else '' }}
                    </div>
                    {% endif %}
                    <div class="avatar-status-indicator"></div>
                </div>
            </div>

            <div class="team-card-body">
                <!-- Employee ID -->
                <div class="team-member-id">
                    <code>{{ member.employee_id }}</code>
                </div>
                
                <!-- Name -->
                <h3 class="team-member-name">{{ member.first_name }} {{ member.last_name }}</h3>
                
                <!-- Designation -->
                <div class="team-member-role">
                    <i class="fas fa-briefcase"></i>
                    <span>{{ member.designation.name if member.designation else '-' }}</span>
                </div>

                <!-- Department -->
                {% if member.department %}
                <div class="team-member-info">
                    <i class="fas fa-building"></i>
                    <span>{{ member.department }}</span>
                </div>
                {% endif %}

                <!-- Location -->
                {% if member.location %}
                <div class="team-member-info">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>{{ member.location }}</span>
                </div>
                {% endif %}
            </div>

            <div class="team-card-footer">
                <!-- Contact Information -->
                <div class="team-contact-actions">
                    {% if member.email %}
                    <a href="mailto:{{ member.email }}" class="team-contact-btn" title="Send Email">
                        <i class="fas fa-envelope"></i>
                    </a>
                    {% endif %}

                    {% if member.phone %}
                    <a href="tel:{{ member.phone }}" class="team-contact-btn" title="Call">
                        <i class="fas fa-phone"></i>
                    </a>
                    {% endif %}

                    <button class="team-contact-btn" title="View Profile" onclick="showMemberDetails('{{ member.id }}')">
                        <i class="fas fa-user"></i>
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <!-- Empty State -->
    <div class="empty-state-container">
        <div class="empty-state-icon">
            <i class="fas fa-users"></i>
        </div>
        <h3 class="empty-state-title">No Team Members Found</h3>
        {% if is_manager_view %}
        <p class="empty-state-text">You don't have any direct reports assigned yet. Contact HR to assign team members.</p>
        {% else %}
        <p class="empty-state-text">You don't have any colleagues reporting to the same manager yet.</p>
        {% endif %}
        <a href="{{ url_for('dashboard') }}" class="btn btn-primary">
            <i class="fas fa-home"></i>
            Back to Dashboard
        </a>
    </div>
    {% endif %}
</div>

<!-- Member Profile Modal -->
<div id="memberModal" class="modal fade" tabindex="-1" aria-labelledby="memberModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content member-profile-modal">
            <div class="modal-header member-modal-header">
                <div class="d-flex align-items-center gap-3 w-100">
                    <img id="memberPhoto" src="" alt="" class="member-modal-avatar">
                    <div>
                        <h5 id="memberModalLabel" class="mb-1 member-name-title"></h5>
                        <p id="memberDesignation" class="mb-0 member-designation-title"></p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body member-modal-body" id="memberModalBody">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            <div class="modal-footer member-modal-footer">
                <a id="memberEmailBtn" href="#" class="btn btn-outline-primary btn-sm" title="Send Email">
                    <i class="fas fa-envelope me-2"></i>Email
                </a>
                <a id="memberPhoneBtn" href="#" class="btn btn-outline-primary btn-sm" title="Call">
                    <i class="fas fa-phone me-2"></i>Call
                </a>
                <button type="button" class="btn btn-outline-secondary btn-sm close-modal-btn" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
// Store modal instance globally to ensure proper cleanup
let memberModalInstance = null;

function showMemberDetails(memberId) {
    // Close any existing modal instance first
    if (memberModalInstance) {
        memberModalInstance.hide();
        memberModalInstance = null;
    }
    
    const memberModalElement = document.getElementById('memberModal');
    const modalBody = document.getElementById('memberModalBody');
    
    // Show loading state
    modalBody.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
    
    // Create new modal instance
    memberModalInstance = new bootstrap.Modal(memberModalElement, {
        backdrop: 'static',
        keyboard: true,
        focus: true
    });
    
    // Fetch member profile data
    fetch(`/team/member/${memberId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to load profile');
            }
            return response.json();
        })
        .then(data => {
            // Update modal header
            document.getElementById('memberModalLabel').textContent = `${data.first_name} ${data.last_name}`;
            document.getElementById('memberDesignation').textContent = data.designation;
            
            // Update photo
            const photoUrl = data.photo_url ? `{{ url_for('static', filename='') }}${data.photo_url}` : '';
            const photoImg = document.getElementById('memberPhoto');
            if (photoUrl && data.photo_url) {
                photoImg.src = photoUrl;
                photoImg.style.display = 'block';
            } else {
                const firstLetter = data.first_name ? data.first_name[0].toUpperCase() : 'E';
                photoImg.innerHTML = `<div class="avatar-placeholder">${firstLetter}</div>`;
                photoImg.style.display = 'block';
            }
            
            // Build profile HTML
            let profileHTML = `
                <div class="member-profile-content">
                    <!-- Quick Info Section -->
                    <div class="profile-section mb-4">
                        <h6 class="section-title"><i class="fas fa-id-card me-2 text-primary"></i>Personal Information</h6>
                        <div class="info-grid">
                            <div class="info-item">
                                <label class="info-label">Employee ID</label>
                                <div class="info-value"><code>${data.employee_id}</code></div>
                            </div>
                            <div class="info-item">
                                <label class="info-label">Gender</label>
                                <div class="info-value">${data.gender}</div>
                            </div>
                            <div class="info-item">
                                <label class="info-label">Date of Birth</label>
                                <div class="info-value">${data.date_of_birth}</div>
                            </div>
                            <div class="info-item">
                                <label class="info-label">Nationality</label>
                                <div class="info-value">${data.nationality}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Contact Information Section -->
                    <div class="profile-section mb-4">
                        <h6 class="section-title"><i class="fas fa-phone me-2 text-success"></i>Contact Information</h6>
                        <div class="info-grid">
                            <div class="info-item">
                                <label class="info-label">Email</label>
                                <div class="info-value">${data.email_display}</div>
                            </div>
                            <div class="info-item">
                                <label class="info-label">Phone</label>
                                <div class="info-value">${data.phone_display}</div>
                            </div>
                            <div class="info-item col-12">
                                <label class="info-label">Address</label>
                                <div class="info-value">${data.address}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Employment Information Section -->
                    <div class="profile-section mb-4">
                        <h6 class="section-title"><i class="fas fa-briefcase me-2 text-warning"></i>Employment Details</h6>
                        <div class="info-grid">
                            <div class="info-item">
                                <label class="info-label">Designation</label>
                                <div class="info-value"><span class="badge bg-primary">${data.designation}</span></div>
                            </div>
                            <div class="info-item">
                                <label class="info-label">Department</label>
                                <div class="info-value">${data.department}</div>
                            </div>
                            <div class="info-item">
                                <label class="info-label">Employment Type</label>
                                <div class="info-value">${data.employment_type}</div>
                            </div>
                            <div class="info-item">
                                <label class="info-label">Location</label>
                                <div class="info-value">${data.location}</div>
                            </div>
                            <div class="info-item">
                                <label class="info-label">Hire Date</label>
                                <div class="info-value">${data.hire_date}</div>
                            </div>
                            <div class="info-item">
                                <label class="info-label">Reporting Manager</label>
                                <div class="info-value">${data.manager_name}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Status Badge -->
                    <div class="profile-section">
                        <h6 class="section-title"><i class="fas fa-heartbeat me-2 text-danger"></i>Status</h6>
                        ${data.is_active ? '<span class="badge bg-success p-2"><i class="fas fa-check-circle me-1"></i>Active Employee</span>' : '<span class="badge bg-danger p-2"><i class="fas fa-times-circle me-1"></i>Inactive</span>'}
                    </div>
                </div>
            `;
            
            modalBody.innerHTML = profileHTML;
            
            // Update contact buttons
            document.getElementById('memberEmailBtn').href = data.email ? `mailto:${data.email}` : '#';
            document.getElementById('memberEmailBtn').style.display = data.email ? 'inline-block' : 'none';
            
            document.getElementById('memberPhoneBtn').href = data.phone ? `tel:${data.phone}` : '#';
            document.getElementById('memberPhoneBtn').style.display = data.phone ? 'inline-block' : 'none';
            
            // Show modal
            memberModalInstance.show();
        })
        .catch(error => {
            console.error('Error loading member profile:', error);
            modalBody.innerHTML = `<div class="alert alert-danger" role="alert"><i class="fas fa-exclamation-circle me-2"></i>Error loading profile. Please try again.</div>`;
            memberModalInstance.show();
        });
}

// Clean up modal instance when it's hidden
document.addEventListener('DOMContentLoaded', function() {
    const memberModalElement = document.getElementById('memberModal');
    memberModalElement.addEventListener('hidden.bs.modal', function() {
        memberModalInstance = null;
        // Enable scrolling on body
        document.body.style.overflow = '';
    });
});
</script>{% endblock %}