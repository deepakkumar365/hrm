{% extends "base.html" %}

{% block title %}Attendance - Clock In/Out{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/attendance.css') }}">
{% endblock %}

{% block content %}
<div class="attendance-page">



    <!-- Top Row: Dashboard -->
    <div class="attendance-dashboard-row">

        <!-- col-1: Identity & Time -->
        <div class="dashboard-panel identity-panel">
            <div class="greeting-container">
                <h1 class="greeting-text" id="greeting-title">
                    <span id="greeting-icon">ðŸŒ™</span>
                    <span id="greeting-msg">Good Evening!</span>
                </h1>
                <div class="date-text">{{ company_local_date_str }}</div>

                <div class="status-pill {{ 'completed' if today_attendance and today_attendance.clock_out else '' }}">
                    {% if today_attendance and today_attendance.clock_out %}
                    <i class="fas fa-check-circle"></i> Day Completed
                    {% else %}
                    Day Completed
                    {% endif %}
                </div>
            </div>

            <div class="clock-container">
                <div class="big-clock" id="live-big-clock">00:00:00</div>
                <div class="timezone-label">{{ company_timezone }}</div>
            </div>
        </div>

        <!-- col-2: Action Center -->
        <div class="dashboard-panel action-panel">
            <form id="attendanceForm" method="POST" action="{{ url_for('attendance_mark') }}">
                <input type="hidden" name="latitude" id="lat">
                <input type="hidden" name="longitude" id="lng">
                <input type="hidden" name="action" id="action-input">

                {% if not today_attendance or not today_attendance.clock_in %}
                <!-- State: Not Clocked In -->
                <div class="btn-circle-container">
                    <div class="btn-circle-outer"></div>
                    <button type="button" class="btn-circle btn-clock-in" onclick="submitAction('clock_in', this)">
                        <span class="main-label">CLOCK IN</span>
                        <span class="sub-label">Start your day</span>
                    </button>
                </div>
                {% elif today_attendance and not today_attendance.clock_out %}
                <!-- State: Working / On Break -->
                <div class="btn-circle-container">
                    <div class="btn-circle-outer"></div>
                    <button type="button" class="btn-circle btn-clock-out" onclick="submitAction('clock_out', this)">
                        <span class="main-label">CLOCK OUT</span>
                        <span class="sub-label">End your shift</span>
                    </button>
                </div>

                <div class="secondary-action">
                    {% if not today_attendance.break_start %}
                    <button type="button" class="btn-pill" onclick="submitAction('break_end', this)">Resume
                        Work</button>
                    {% endif %}
                </div>
                <!-- Extra Action: Register OT -->
                <div class="secondary-action" style="margin-top: 10px;">
                    <a href="{{ url_for('mark_ot_attendance') }}" class="btn-pill"
                        style="text-decoration: none; color: inherit; display: inline-block;">
                        Register OT
                    </a>
                </div>
                {% else %}
                <!-- State: Day Completed -->
                <div class="completion-message">
                    <h2>You're done for today!</h2>
                    <p>Great work. See you tomorrow.</p>
                </div>
                <div class="secondary-action" style="margin-top: 15px;">
                    <a href="{{ url_for('mark_ot_attendance') }}" class="btn-pill"
                        style="text-decoration: none; color: inherit; display: inline-block;">
                        Register OT
                    </a>
                </div>
                {% endif %}
            </form>
        </div>

        <!-- col-3: Stats -->
        <div class="dashboard-panel stats-panel">
            <div class="stats-card-vertical">
                <div class="stat-item">
                    <span class="val" style="color: #0d9488;">{{ "%.2f"|format(today_attendance.regular_hours or 0.0)
                        }}</span>
                    <span class="lbl">Regular</span>
                </div>
                <div class="stat-item">
                    {% if today_attendance and today_attendance.overtime_approved %}
                    <span class="val" style="color: #16a34a;">{{ "%.2f"|format(today_attendance.overtime_hours or 0.0)
                        }}</span>
                    {% else %}
                    <span class="val" style="color: #16a34a;">0.00</span>
                    {% endif %}
                    <span class="lbl">Approved OT</span>
                </div>
                <div class="stat-item">
                    {% if today_attendance and not today_attendance.overtime_approved %}
                    <span class="val" style="color: #f59e0b;">{{ "%.2f"|format(today_attendance.overtime_hours or 0.0)
                        }}</span>
                    {% else %}
                    <span class="val" style="color: #f59e0b;">0.00</span>
                    {% endif %}
                    <span class="lbl">Pending OT</span>
                </div>
                <div class="stat-item">
                    <span class="val" style="color: #1e3a8a; font-weight: 800;">{{
                        "%.2f"|format(today_attendance.total_hours or 0.0) }}</span>
                    <span class="lbl">Total</span>
                </div>
            </div>
        </div>

        <!-- col-4: Activity -->
        <div class="dashboard-panel activity-panel">
            {% if today_attendance %}
            <div class="timeline-compact">
                {% if today_attendance.clock_in %}
                <div class="timeline-row">
                    <div class="t-dot active"></div>
                    <div class="t-time">{{ today_attendance.clock_in_display or '-' }}</div>
                    <div class="t-title">Clock In</div>
                </div>
                {% endif %}

                {% if today_attendance.break_start %}
                <div class="timeline-row">
                    <div class="t-dot"></div>
                    <div class="t-time">{{ today_attendance.break_start_display or '-' }}</div>
                    <div class="t-title">Break Start</div>
                </div>
                {% endif %}

                {% if today_attendance.break_end %}
                <div class="timeline-row">
                    <div class="t-dot"></div>
                    <div class="t-time">{{ today_attendance.break_end_display or '-' }}</div>
                    <div class="t-title">Break End</div>
                </div>
                {% endif %}

                {% if today_attendance.clock_out %}
                <div class="timeline-row">
                    <div class="t-dot"></div>
                    <div class="t-time">{{ today_attendance.clock_out_display or '-' }}</div>
                    <div class="t-title">Clock Out</div>
                </div>
                {% endif %}
            </div>
            {% else %}
            <div class="no-activity">
                <p>No activity yet.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Last Week History Section -->
    <div class="history-section">
        <div class="history-title">
            <i class="fas fa-history"></i> Last Week's Attendance
        </div>

        {% if recent_records %}
        <table class="history-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>In</th>
                    <th>Out</th>
                    <th>Hours</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for record in recent_records %}
                <tr>
                    <td data-label="Date">{{ record.date.strftime('%d %b, %a') }}</td>
                    <td data-label="In">{{ record.clock_in_display or '-' }}</td>
                    <td data-label="Out">{{ record.clock_out_display or '-' }}</td>
                    <td data-label="Hours">{{ "%.1f"|format(record.total_hours or 0.0) }}h</td>
                    <td data-label="Status">
                        <span
                            class="status-badge {{ 'status-present' if record.status == 'Present' else 'status-absent' }}">
                            {{ record.status }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <i class="far fa-calendar-times"></i>
            <p>No records found for the last 7 days.</p>
        </div>
        {% endif %}
    </div>

    <!-- FAB -->
    <button class="fab">
        <i class="fas fa-ellipsis-h"></i>
    </button>

    {% endblock %}

    {% block scripts %}
    <script>
        function updateClock() {
            const now = new Date();
            const hrs = String(now.getHours()).padStart(2, '0');
            const mins = String(now.getMinutes()).padStart(2, '0');
            const secs = String(now.getSeconds()).padStart(2, '0');
            const el = document.getElementById('live-big-clock');
            if (el) el.textContent = hrs + ':' + mins + ':' + secs;

            // Update Greeting
            const hour = now.getHours();
            const msgEl = document.getElementById('greeting-msg');
            const iconEl = document.getElementById('greeting-icon');

            if (hour < 12) {
                msgEl.textContent = 'Good Morning!';
                iconEl.textContent = 'â˜€ï¸';
            } else if (hour < 17) {
                msgEl.textContent = 'Good Afternoon!';
                iconEl.textContent = 'ðŸŒ¤ï¸';
            } else {
                msgEl.textContent = 'Good Evening!';
                iconEl.textContent = 'ðŸŒ™';
            }
        }

        setInterval(updateClock, 1000);
        updateClock();

        function submitAction(action, btnElement) {
            // Fallback for button element if not passed
            const btn = btnElement || event.currentTarget;

            // Visual feedback
            if (btn && btn.classList.contains('btn-circle')) {
                btn.innerHTML = '<div class="spinner-border text-light" role="status" style="width: 2rem; height: 2rem;"><span class="visually-hidden">Loading...</span></div>';
                btn.disabled = true;
            } else if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            }

            document.getElementById('action-input').value = action;
            const form = document.getElementById('attendanceForm');

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        document.getElementById('lat').value = pos.coords.latitude;
                        document.getElementById('lng').value = pos.coords.longitude;
                        form.submit();
                    },
                    (err) => {
                        console.warn("Geolocation error:", err);
                        // Continue even if location fails
                        form.submit();
                    },
                    { timeout: 3000, enableHighAccuracy: false }
                );
            } else {
                form.submit();
            }
        }
    </script>
    {% endblock %}