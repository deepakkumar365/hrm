{% extends "base.html" %}

{% block title %}Attendance Records - Noltrion{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header with Navigation and Actions -->
    <div class="row mb-2">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                    <!-- Breadcrumb Navigation -->
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-0">
                            <li class="breadcrumb-item">Attendance</li>
                            <li class="breadcrumb-item active" aria-current="page">Records</li>
                        </ol>
                    </nav>
                </div>
                <div class="btn-group gap-2">
                    {% if (current_user.role.name if current_user.role else None) in ['Super Admin', 'Admin', 'Manager'] %}
                    <a href="{{ url_for('attendance_bulk_manage') }}" class="btn btn-outline-primary">
                        <i class="fas fa-users me-1"></i>Bulk Upload
                    </a>
                    {% endif %}
                    <a href="{{ url_for('attendance_mark') }}" class="btn btn-primary">
                        <i class="fas fa-clock me-1"></i>Mark Attendance
                    </a>
                </div>
            </div>
            
            <hr class="mt-0 mb-3">

            <!-- Filter Section -->
            <form method="GET" class="filter-card mb-3" id="attendance_filter_form">
                <div class="card-header">
                    <i class="fas fa-filter me-2"></i>Filters
                </div>
                <div class="card-body">
                    <!-- Filter Row 1: Organization & Department -->
                    <div class="row g-3 mb-3">
                        {% if (current_user.role.name if current_user.role else None) in ['Super Admin', 'Admin', 'HR Manager', 'Manager'] %}
                        <!-- Company Filter -->
                        {% if companies %}
                        <div class="col-md-3">
                            <label class="form-label small mb-2">
                                <i class="fas fa-building me-1" style="color: #6c757d;"></i>Company
                            </label>
                            <select id="company_filter" name="company" class="form-select">
                                <option value="">All Companies</option>
                                {% for company in companies %}
                                <option value="{{ company }}" {% if company == company_filter %}selected{% endif %}>{{ company }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endif %}

                        <!-- Department Filter -->
                        {% if departments %}
                        <div class="col-md-3">
                            <label class="form-label small mb-2">
                                <i class="fas fa-sitemap me-1" style="color: #6c757d;"></i>Department
                            </label>
                            <select id="department_filter" name="department" class="form-select">
                                <option value="">All Departments</option>
                                {% for dept in departments %}
                                <option value="{{ dept }}" {% if dept == department_filter %}selected{% endif %}>{{ dept }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endif %}
                        {% endif %}

                        <!-- Employee Filter -->
                        {% if employees %}
                        <div class="col-md-3">
                            <label class="form-label small mb-2">
                                <i class="fas fa-user me-1" style="color: #6c757d;"></i>Employee
                            </label>
                            <select id="employee_filter" name="employee" class="form-select">
                                <option value="">All Employees</option>
                                {% for emp in employees %}
                                <option value="{{ emp.id }}" {% if emp.id == employee_filter %}selected{% endif %}>
                                    {{ emp.first_name }} {{ emp.last_name }} ({{ emp.employee_id }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Filter Row 2: Date Range -->
                    <div class="row g-3 mb-3">
                        <div class="col-12">
                            <label class="form-label small mb-2">
                                <i class="fas fa-calendar me-1" style="color: #6c757d;"></i>Date Range
                            </label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="date_range" id="date_today" value="today"
                                       {% if date_range_filter == 'today' or not date_range_filter %}checked{% endif %} onchange="handleDateRangeChange('today')">
                                <label class="btn btn-outline-primary" for="date_today">
                                    <i class="fas fa-calendar-day"></i> Today
                                </label>

                                <input type="radio" class="btn-check" name="date_range" id="date_week" value="week"
                                       {% if date_range_filter == 'week' %}checked{% endif %} onchange="handleDateRangeChange('week')">
                                <label class="btn btn-outline-primary" for="date_week">
                                    <i class="fas fa-calendar-week"></i> This Week
                                </label>

                                <input type="radio" class="btn-check" name="date_range" id="date_month" value="month"
                                       {% if date_range_filter == 'month' %}checked{% endif %} onchange="handleDateRangeChange('month')">
                                <label class="btn btn-outline-primary" for="date_month">
                                    <i class="fas fa-calendar-alt"></i> This Month
                                </label>

                                <input type="radio" class="btn-check" name="date_range" id="date_custom" value="custom"
                                       {% if date_range_filter == 'custom' %}checked{% endif %} onchange="handleDateRangeChange('custom')">
                                <label class="btn btn-outline-primary" for="date_custom">
                                    <i class="fas fa-calendar"></i> Custom
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Custom Date Range (Shown only when Custom is selected) -->
                    <div class="row g-3 mb-3" id="custom_date_fields" style="display: {% if date_range_filter == 'custom' %}flex{% else %}none{% endif %};">
                        <div class="col-md-3">
                            <label for="start_date" class="form-label small">From</label>
                            <input type="date" id="start_date" name="start_date" class="form-control"
                                   value="{{ start_date or '' }}">
                        </div>
                        <div class="col-md-3">
                            <label for="end_date" class="form-label small">To</label>
                            <input type="date" id="end_date" name="end_date" class="form-control"
                                   value="{{ end_date or '' }}">
                        </div>
                    </div>

                    <!-- Filter Actions -->
                    <div class="row g-2">
                        <div class="col-auto">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search me-1"></i>Apply Filters
                            </button>
                        </div>
                        <div class="col-auto">
                            <a href="{{ url_for('attendance_list') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-redo me-1"></i>Reset
                            </a>
                        </div>
                    </div>

                    <!-- Active Filters Summary -->
                    {% if date_range_filter or company_filter or department_filter or employee_filter %}
                    <div class="row g-2 mt-3 pt-3 border-top">
                        <div class="col-12">
                            <small class="text-muted d-block mb-2">
                                <i class="fas fa-tag me-1"></i>Active Filters:
                            </small>
                            <div>
                                {% if date_range_filter == 'today' %}
                                <span class="badge bg-light text-dark border">
                                    <i class="fas fa-calendar-day me-1"></i>Today
                                    <button type="button" class="btn-close btn-close-white ms-1 p-0" onclick="clearFilter('date_range')" style="width: auto; opacity: 0.7;"></button>
                                </span>
                                {% elif date_range_filter == 'week' %}
                                <span class="badge bg-light text-dark border">
                                    <i class="fas fa-calendar-week me-1"></i>This Week
                                    <button type="button" class="btn-close btn-close-white ms-1 p-0" onclick="clearFilter('date_range')" style="width: auto; opacity: 0.7;"></button>
                                </span>
                                {% elif date_range_filter == 'month' %}
                                <span class="badge bg-light text-dark border">
                                    <i class="fas fa-calendar-alt me-1"></i>This Month
                                    <button type="button" class="btn-close btn-close-white ms-1 p-0" onclick="clearFilter('date_range')" style="width: auto; opacity: 0.7;"></button>
                                </span>
                                {% elif date_range_filter == 'custom' %}
                                <span class="badge bg-light text-dark border">
                                    <i class="fas fa-calendar me-1"></i>{{ start_date }} to {{ end_date }}
                                    <button type="button" class="btn-close btn-close-white ms-1 p-0" onclick="clearFilter('date_range')" style="width: auto; opacity: 0.7;"></button>
                                </span>
                                {% endif %}
                                
                                {% if company_filter %}
                                <span class="badge bg-light text-dark border">
                                    <i class="fas fa-building me-1"></i>{{ company_filter }}
                                    <button type="button" class="btn-close btn-close-white ms-1 p-0" onclick="clearFilter('company')" style="width: auto; opacity: 0.7;"></button>
                                </span>
                                {% endif %}
                                
                                {% if department_filter %}
                                <span class="badge bg-light text-dark border">
                                    <i class="fas fa-sitemap me-1"></i>{{ department_filter }}
                                    <button type="button" class="btn-close btn-close-white ms-1 p-0" onclick="clearFilter('department')" style="width: auto; opacity: 0.7;"></button>
                                </span>
                                {% endif %}
                                
                                {% if employee_filter %}
                                <span class="badge bg-light text-dark border">
                                    <i class="fas fa-user me-1"></i>{{ employee_filter }}
                                    <button type="button" class="btn-close btn-close-white ms-1 p-0" onclick="clearFilter('employee')" style="width: auto; opacity: 0.7;"></button>
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>

    <!-- Summary Statistics -->
    {% if attendance_records.items and summary %}
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <button class="btn btn-link w-100 text-start card-header text-dark text-decoration-none" type="button" data-bs-toggle="collapse" data-bs-target="#summaryStats">
                    <i class="fas fa-chart-line me-2"></i>Summary Statistics
                    <i class="fas fa-chevron-down float-end"></i>
                </button>
                <div class="collapse show" id="summaryStats">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-2 col-sm-4">
                                <div class="text-center">
                                    <small class="text-muted d-block mb-1">Total Records</small>
                                    <strong class="display-6">{{ summary.total_records }}</strong>
                                </div>
                            </div>
                            <div class="col-md-2 col-sm-4">
                                <div class="text-center">
                                    <small class="text-success d-block mb-1">Present</small>
                                    <strong class="display-6 text-success">{{ summary.present_days }}</strong>
                                </div>
                            </div>
                            <div class="col-md-2 col-sm-4">
                                <div class="text-center">
                                    <small class="text-danger d-block mb-1">Absent</small>
                                    <strong class="display-6 text-danger">{{ summary.absent_days }}</strong>
                                </div>
                            </div>
                            <div class="col-md-2 col-sm-4">
                                <div class="text-center">
                                    <small class="text-warning d-block mb-1">Late</small>
                                    <strong class="display-6 text-warning">{{ summary.late_days }}</strong>
                                </div>
                            </div>
                            <div class="col-md-2 col-sm-4">
                                <div class="text-center">
                                    <small class="text-info d-block mb-1">Total Hours</small>
                                    <strong class="display-6 text-info">{{ "%.1f"|format(summary.total_hours) }}h</strong>
                                </div>
                            </div>
                            <div class="col-md-2 col-sm-4">
                                <div class="text-center">
                                    <small class="text-primary d-block mb-1">Overtime</small>
                                    <strong class="display-6 text-primary">{{ "%.1f"|format(summary.total_overtime) }}h</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Attendance Records Table -->
    <div class="row">
        <div class="col-12">
            {% if attendance_records.items %}
            <div class="card">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 15%;">
                                    <i class="fas fa-calendar me-1"></i>Date
                                </th>
                                <th style="width: 25%;">
                                    <i class="fas fa-user me-1"></i>Employee
                                </th>
                                <th style="width: 12%;">
                                    <i class="fas fa-check-circle me-1"></i>Status
                                </th>
                                <th style="width: 12%;">
                                    <i class="fas fa-sign-in-alt me-1"></i>Clock In
                                </th>
                                <th style="width: 12%;">
                                    <i class="fas fa-sign-out-alt me-1"></i>Clock Out
                                </th>
                                <th style="width: 12%;">
                                    <i class="fas fa-hourglass me-1"></i>Hours
                                </th>
                                <th style="width: 12%;">
                                    <i class="fas fa-clock me-1"></i>OT Hours
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in attendance_records.items %}
                            <tr class="align-middle">
                                <td>
                                    <div class="small">
                                        <strong>{{ record.date.strftime('%d %b %Y') if record.date else '-' }}</strong>
                                        <br>
                                        <span class="text-muted">{{ record.date.strftime('%A') if record.date else '' }}</span>
                                    </div>
                                </td>
                                <td>
                                    {% if (current_user.role.name if current_user.role else None) in ['Super Admin', 'Admin', 'HR Manager', 'Manager'] %}
                                    <div class="d-flex align-items-center gap-2">
                                        {% if record.employee.profile_image_path %}
                                        <img src="{{ url_for('static', filename=record.employee.profile_image_path) }}" alt="{{ record.employee.first_name }}" class="rounded-circle" style="width: 32px; height: 32px; object-fit: cover;">
                                        {% else %}
                                        <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center text-white" style="width: 32px; height: 32px;">
                                            <i class="fas fa-user fa-sm"></i>
                                        </div>
                                        {% endif %}
                                        <div class="small">
                                            <div class="fw-semibold">{{ record.employee.first_name }} {{ record.employee.last_name }}</div>
                                            <div class="text-muted">{{ record.employee.employee_id }}</div>
                                        </div>
                                    </div>
                                    {% else %}
                                    <div class="small fw-semibold">{{ record.employee.first_name }} {{ record.employee.last_name }}</div>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-{{ 'success' if record.status == 'Present' else 'danger' if record.status == 'Absent' else 'warning' if record.status == 'Late' else 'secondary' }}">
                                        <i class="fas fa-{{ 'check-circle' if record.status == 'Present' else 'times-circle' if record.status == 'Absent' else 'clock' if record.status == 'Late' else 'question-circle' }} me-1"></i>
                                        {{ record.status }}
                                    </span>
                                </td>
                                <td class="text-center">
                                    <strong>{{ record.clock_in.strftime('%H:%M') if record.clock_in else '-' }}</strong>
                                </td>
                                <td class="text-center">
                                    <strong>{{ record.clock_out.strftime('%H:%M') if record.clock_out else '-' }}</strong>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-light text-dark">{{ record.total_hours or 0 }}h</span>
                                </td>
                                <td class="text-center">
                                    {% if record.overtime_hours > 0 %}
                                    <span class="badge bg-info">{{ record.overtime_hours }}h</span>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                {% if attendance_records.pages > 1 %}
                <div class="card-footer">
                    <nav aria-label="Page navigation">
                        <ul class="pagination pagination-sm mb-0 justify-content-center">
                            {% if attendance_records.has_prev %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('attendance_list', page=attendance_records.prev_num) }}">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            </li>
                            {% endif %}
                            
                            {% for page_num in attendance_records.iter_pages() %}
                                {% if page_num %}
                                    {% if page_num != attendance_records.page %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('attendance_list', page=page_num) }}">{{ page_num }}</a>
                                    </li>
                                    {% else %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ page_num }}</span>
                                    </li>
                                    {% endif %}
                                {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if attendance_records.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('attendance_list', page=attendance_records.next_num) }}">
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
                {% endif %}
            </div>

            {% else %}
            <!-- Empty State -->
            <div class="card">
                <div class="card-body text-center py-5">
                    <div class="mb-3">
                        <i class="fas fa-calendar-times fa-3x text-muted"></i>
                    </div>
                    <h5 class="text-muted">No Attendance Records Found</h5>
                    <p class="text-muted mb-3">Try adjusting your filters or mark new attendance records</p>
                    <a href="{{ url_for('attendance_mark') }}" class="btn btn-primary">
                        <i class="fas fa-clock me-1"></i>Mark Attendance
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>  <!-- Close container-fluid -->

<style>
/* Filter Card */
.filter-card {
    border: 1px solid #e9ecef;
    border-radius: 0.5rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    margin-bottom: 1rem;
}

.filter-card .card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
    padding: 1rem;
    font-weight: 600;
    color: #495057;
}

.filter-card .card-body {
    padding: 1.5rem;
}

/* Form Labels */
.form-label {
    font-weight: 500;
    color: #495057;
}

/* Date Range Button Group */
.btn-group {
    display: flex;
    gap: 0;
}

.btn-group .btn {
    flex: 1;
    border-radius: 0.375rem;
    border: 1px solid #dee2e6;
    padding: 0.5rem 1rem;
    font-weight: 500;
}

.btn-group .btn-check:checked + .btn-outline-primary {
    background-color: #0d6efd;
    color: white;
    border-color: #0d6efd;
}

.btn-group .btn-outline-primary {
    color: #0d6efd;
}

.btn-group .btn-outline-primary:hover {
    background-color: #f0f7ff;
}

/* Badge Styles */
.badge {
    font-weight: 500;
    padding: 0.5rem 0.75rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

/* Responsive */
@media (max-width: 768px) {
    .filter-card .card-body {
        padding: 1rem;
    }

    .row.g-3 {
        --bs-gutter-y: 1rem;
    }

    .btn-group {
        flex-wrap: wrap;
    }

    .btn-group .btn {
        flex: 0 1 calc(50% - 0.5rem);
    }
}
</style>

<script>
// Handle date range change
function handleDateRangeChange(type) {
    const customDateFields = document.getElementById('custom_date_fields');
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    
    if (type === 'custom') {
        customDateFields.style.display = 'flex';
        startDateInput.focus();
    } else {
        customDateFields.style.display = 'none';
        startDateInput.value = '';
        endDateInput.value = '';
        
        // Auto-submit form when preset range is selected
        setTimeout(() => {
            document.getElementById('attendance_filter_form').submit();
        }, 100);
    }
}

// Clear individual filter
function clearFilter(filterType) {
    const form = document.getElementById('attendance_filter_form');
    
    switch(filterType) {
        case 'date_range':
            document.getElementById('date_today').checked = true;
            document.getElementById('start_date').value = '';
            document.getElementById('end_date').value = '';
            document.getElementById('custom_date_fields').style.display = 'none';
            break;
        case 'company':
            document.getElementById('company_filter').value = '';
            break;
        case 'department':
            document.getElementById('department_filter').value = '';
            break;
        case 'employee':
            document.getElementById('employee_filter').value = '';
            break;
    }
    
    // Submit the form
    setTimeout(() => {
        form.submit();
    }, 100);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    const customDateFields = document.getElementById('custom_date_fields');
    const dateRangeRadios = document.querySelectorAll('input[name="date_range"]');
    
    // Show/hide custom date fields based on selection
    dateRangeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            handleDateRangeChange(this.value);
        });
    });
    
    // Check if custom is selected on page load
    const checkedRadio = document.querySelector('input[name="date_range"]:checked');
    if (checkedRadio && checkedRadio.value === 'custom') {
        customDateFields.style.display = 'flex';
    }

    // Form submission handler for custom dates
    document.getElementById('attendance_filter_form').addEventListener('submit', function(e) {
        const checkedRadio = document.querySelector('input[name="date_range"]:checked');
        
        if (checkedRadio && checkedRadio.value === 'custom') {
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;
            
            if (!startDate || !endDate) {
                e.preventDefault();
                alert('Please enter both start and end dates');
                return false;
            }
        }
    });
});
</script>
{% endblock %}