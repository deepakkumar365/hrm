{% extends "base.html" %}

{% block title %}Attendance History{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/attendance.css') }}">
<style>
    /* Modern Dashboard Styling (Global) */
    :root {
        --primary-color: #0d9488;
        --primary-light: #ccfbf1;
        --primary-hover: #0f766e;
        --text-main: #0f172a;
        --text-secondary: #64748b;
        --radius-md: 0.375rem;
    }

    /* Header Typography */
    .page-title {
        font-weight: 800;
        color: var(--text-main);
        font-size: 1.75rem;
        letter-spacing: -0.02em;
    }

    .page-subtitle {
        color: var(--text-secondary);
        font-size: 0.95rem;
    }

    /* Modern Buttons */
    .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        font-weight: 600;
    }

    .btn-primary:hover {
        background-color: var(--primary-hover);
        border-color: var(--primary-hover);
    }

    /* Toolbar & Filter Styles (Local Override/Addition) */
    .attendance-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        background: var(--bg-card);
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 0;
    }

    .filter-toggle-btn {
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        padding: 0.4rem 0.8rem;
        border-radius: var(--radius-md);
        font-size: 0.875rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
    }

    .filter-toggle-btn:hover,
    .filter-toggle-btn.active {
        background: var(--bg-muted);
        color: var(--primary);
        border-color: var(--primary);
    }

    .header-title {
        color: var(--text-header);
    }

    .filter-section-wrapper {
        background: var(--bg-muted);
        border-bottom: 1px solid var(--border-color);
        overflow: hidden;
        max-height: 0;
        transition: max-height 0.3s ease-out;
    }

    .filter-section-wrapper.open {
        max-height: 200px;
        /* Limits transition height */
        padding: 1rem;
    }

    /* OT Grid Styles */
    .ot-section-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--text-header);
        margin: 1.5rem auto 1rem auto;
        padding-left: 0.5rem;
        border-left: 4px solid var(--primary);
        width: 90%;
    }

    .ot-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 0.75rem;
        width: 90%;
        margin: 0 auto 2rem auto;
    }

    .ot-card {
        background: var(--bg-card);
        border: 1px solid var(--border-default);
        border-radius: var(--radius-md);
        padding: 1rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s;
    }

    .ot-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border-color: var(--primary-light, #cbd5e1);
    }

    .ot-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--border-light);
    }

    .ot-date {
        font-weight: 600;
        color: var(--text-primary);
    }

    .ot-hours {
        background: var(--bg-muted);
        color: var(--primary);
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .ot-allowance-item {
        display: flex;
        justify-content: space-between;
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-bottom: 0.25rem;
    }

    .ot-total {
        margin-top: 0.75rem;
        padding-top: 0.5rem;
        border-top: 1px dotted var(--border-light);
        display: flex;
        justify-content: space-between;
        font-weight: 700;
        color: var(--text-primary);
    }

    /* Mobile adjustments */
    @media (max-width: 768px) {
        .attendance-page-container {
            padding: 0 !important;
        }

        .attendance-toolbar {
            padding: 0.75rem;
        }

        .filter-section-wrapper.open {
            max-height: 400px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid attendance-page-container py-4">
    <div class="attendance-wrapper mx-auto">

        <!-- Toolbar: Search and Filter Button -->
        <!-- Modern Header Section -->
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 page-header">
            <div class="mb-3 mb-md-0">
                <h4 class="page-title mb-1">Attendance History</h4>
                <p class="page-subtitle mb-0">Monitor employee attendance, clock-ins, and overtime</p>
            </div>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-light border text-secondary shadow-sm" data-bs-toggle="modal"
                    data-bs-target="#filterModal">
                    <i class="fas fa-filter me-1"></i>Filter
                    {% if current_filters.status or current_filters.department or current_filters.designation_id or
                    current_filters.employment_type or current_filters.company_id or current_filters.date_range !=
                    'month' or current_filters.employee %}
                    <span class="badge bg-primary ms-1">!</span>
                    {% endif %}
                </button>

                <a href="{{ url_for('attendance_mark') }}" class="btn btn-primary shadow-sm">
                    <i class="fas fa-plus me-1"></i>Mark Attendance
                </a>
                <button type="button" class="btn btn-outline-success shadow-sm" onclick="exportAttendance()">
                    <i class="fas fa-file-export me-1"></i>Export
                </button>
            </div>
        </div>

        <!-- Filter Modal -->
        <div class="modal fade" id="filterModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form method="GET" action="{{ url_for('attendance_list_view') }}">
                        <div class="modal-header">
                            <h5 class="modal-title"><i class="fas fa-filter me-2"></i>Filter Attendance</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Date Range Filter -->
                            <div class="mb-3">
                                <label class="form-label">Date Range</label>
                                <select name="date_range" class="form-select">
                                    <option value="today" {% if current_filters.date_range=='today' %}selected{% endif
                                        %}>Today</option>
                                    <option value="week" {% if current_filters.date_range=='week' %}selected{% endif %}>
                                        This Week</option>
                                    <option value="month" {% if current_filters.date_range=='month' %}selected{% endif
                                        %}>This Month</option>
                                    <option value="last_month" {% if current_filters.date_range=='last_month'
                                        %}selected{% endif %}>Last Month</option>
                                    <option value="custom" {% if current_filters.date_range=='custom' %}selected{% endif
                                        %}>Custom Range</option>
                                </select>
                            </div>

                            <!-- Custom Date Range Inputs (Conditional) -->
                            <div id="customDateRange"
                                class="mb-3 {% if current_filters.date_range != 'custom' %}d-none{% endif %}">
                                <div class="row g-2">
                                    <div class="col-6">
                                        <label class="form-label small">Start Date</label>
                                        <input type="date" name="start_date" class="form-control form-control-sm"
                                            value="{{ current_filters.start_date }}">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small">End Date</label>
                                        <input type="date" name="end_date" class="form-control form-control-sm"
                                            value="{{ current_filters.end_date }}">
                                    </div>
                                </div>
                            </div>

                            <!-- Employee Search (Role based check handled in template if needed, or just show if not empty) -->
                            {% if (current_user.role.name if current_user.role else None) in ['Super Admin', 'Admin',
                            'Manager', 'HR Manager'] %}
                            <div class="mb-3">
                                <label class="form-label">Employee Name / ID</label>
                                <input type="text" name="employee" class="form-control" placeholder="Search..."
                                    value="{{ current_filters.employee }}">
                            </div>
                            {% endif %}

                            <!-- Status Filter -->
                            <div class="mb-3">
                                <label class="form-label">Status</label>
                                <select name="status" class="form-select">
                                    <option value="">All Statuses</option>
                                    {% for option in filter_options.status_options %}
                                    <option value="{{ option.value }}" {% if current_filters.status==option.value
                                        %}selected{% endif %}>
                                        {{ option.label }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Company Filter (for Admins) -->
                            {% if filter_options.companies %}
                            <div class="mb-3">
                                <label class="form-label">Company</label>
                                <select name="company_id" class="form-select">
                                    <option value="">All Companies</option>
                                    {% for comp in filter_options.companies %}
                                    <option value="{{ comp.id }}" {% if current_filters.company_id==comp.id|string
                                        %}selected{% endif %}>
                                        {{ comp.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% endif %}

                            <!-- Department Filter -->
                            <div class="mb-3">
                                <label class="form-label">Department</label>
                                <select name="department" class="form-select">
                                    <option value="">All Departments</option>
                                    {% for dept in filter_options.departments %}
                                    <option value="{{ dept }}" {% if current_filters.department==dept %}selected{% endif
                                        %}>
                                        {{ dept }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Designation Filter -->
                            <div class="mb-3">
                                <label class="form-label">Designation</label>
                                <select name="designation_id" class="form-select">
                                    <option value="">All Designations</option>
                                    {% for desig in filter_options.designations %}
                                    <option value="{{ desig.id }}" {% if current_filters.designation_id==desig.id
                                        %}selected{% endif %}>
                                        {{ desig.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Employment Type Filter -->
                            <div class="mb-3">
                                <label class="form-label">Employment Type</label>
                                <select name="employment_type" class="form-select">
                                    <option value="">All Types</option>
                                    {% for type in filter_options.employment_types %}
                                    <option value="{{ type }}" {% if current_filters.employment_type==type %}selected{%
                                        endif %}>
                                        {{ type }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                        </div>
                        <div class="modal-footer">
                            <a href="{{ url_for('attendance_list_view') }}" class="btn btn-outline-secondary">Reset</a>
                            <button type="submit" class="btn btn-primary">Apply Filters</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!-- Desktop View -->
        <div class="desktop-table table-responsive">
            <table class="table table-compact table-hover">
                <thead>
                    <tr>
                        <th>Employee</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Clock In</th>
                        <th>Clock Out</th>
                        <th>Total</th>
                        <th class="text-center">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in attendance_records.items %}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm me-3">
                                    {% if record.employee.profile_image_path %}
                                    <img src="{{ url_for('static', filename=record.employee.profile_image_path) }}"
                                        class="rounded-circle" width="32" height="32">
                                    {% else %}
                                    <div
                                        class="rounded-circle bg-light d-flex align-items-center justify-content-center">
                                        {{ record.employee.first_name[0] }}
                                    </div>
                                    {% endif %}
                                </div>
                                <span class="fw-bold">{{ record.employee.first_name }} {{ record.employee.last_name
                                    }}</span>
                            </div>
                        </td>
                        <td>{{ record.date.strftime('%d %b %Y') }}</td>
                        <td>
                            <span class="status-pill bg-{{ record.status.lower() if record.status else 'pending' }}">
                                {{ record.status or 'Pending' }}
                            </span>
                            {% if record.sub_status %}
                            <div class="small text-muted mt-1">{{ record.sub_status }}</div>
                            {% endif %}
                        </td>
                        <td>{{ record.clock_in_display.strftime('%H:%M') if record.clock_in_display else '-' }}</td>
                        <td>{{ record.clock_out_display.strftime('%H:%M') if record.clock_out_display else '-' }}
                        </td>
                        <td><span class="badge bg-light text-dark fw-bold border">{{
                                "%.1f"|format(record.total_hours or 0) }}h</span></td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-secondary border-0" title="View">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if ot_summaries_map %}
        <h5 class="ot-section-title">Overtime Details</h5>
        <div class="ot-grid">
            {% for record in attendance_records.items %}
            {% set ot_key = (record.employee_id, record.date) %}
            {% if ot_key in ot_summaries_map %}
            {% set ot = ot_summaries_map[ot_key] %}
            <div class="ot-card">
                <div class="ot-card-header">
                    <span class="ot-date">{{ record.date.strftime('%d %b %Y') }}</span>
                    <span class="ot-hours">{{ "%.1f"|format(ot.ot_hours or 0) }}h OT</span>
                </div>

                <div class="ot-body">
                    {% if ot.total_allowances > 0 %}
                    {% if ot.kd_and_claim > 0 %}<div class="ot-allowance-item"><span>KD/Claim</span><span>${{
                            "%.2f"|format(ot.kd_and_claim) }}</span></div>{% endif %}
                    {% if ot.trips > 0 %}<div class="ot-allowance-item"><span>Trips</span><span>${{
                            "%.2f"|format(ot.trips) }}</span></div>{% endif %}
                    {% if ot.sinpost > 0 %}<div class="ot-allowance-item"><span>Sinpost</span><span>${{
                            "%.2f"|format(ot.sinpost) }}</span></div>{% endif %}
                    {% if ot.sandstone > 0 %}<div class="ot-allowance-item"><span>Sandstone</span><span>${{
                            "%.2f"|format(ot.sandstone) }}</span></div>{% endif %}
                    {% if ot.spx > 0 %}<div class="ot-allowance-item"><span>SPX</span><span>${{ "%.2f"|format(ot.spx)
                            }}</span></div>{% endif %}
                    {% if ot.psle > 0 %}<div class="ot-allowance-item"><span>PSLE</span><span>${{ "%.2f"|format(ot.psle)
                            }}</span></div>{% endif %}
                    {% if ot.night > 0 %}<div class="ot-allowance-item"><span>Night</span><span>${{
                            "%.2f"|format(ot.night) }}</span></div>{% endif %}
                    {% if ot.ph > 0 %}<div class="ot-allowance-item"><span>PH</span><span>${{ "%.2f"|format(ot.ph)
                            }}</span></div>{% endif %}
                    {% if ot.sun > 0 %}<div class="ot-allowance-item"><span>Sun</span><span>${{ "%.2f"|format(ot.sun)
                            }}</span></div>{% endif %}

                    <div class="ot-allowance-item text-muted"><em>Total Allow.</em><em>${{
                            "%.2f"|format(ot.total_allowances) }}</em></div>
                    {% else %}
                    <div class="text-center text-muted small py-2">No extra allowances</div>
                    {% endif %}

                    <div class="ot-total">
                        <span>Total Amount</span>
                        <span class="text-success">${{ "%.2f"|format(ot.total_amount) }}</span>
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
        {% endif %}


    </div>

    <!-- Items Per Page & Pagination -->
    <div class="d-flex justify-content-between align-items-center mt-4">
        <div class="d-flex align-items-center">
            <label class="me-2 text-muted small">Items per page:</label>
            <select class="form-select form-select-sm shadow-sm border-0" style="width: auto;"
                onchange="changePerPage(this.value)">
                <option value="20" {% if per_page==20 %}selected{% endif %}>20</option>
                <option value="50" {% if per_page==50 %}selected{% endif %}>50</option>
                <option value="100" {% if per_page==100 %}selected{% endif %}>100</option>
                <option value="200" {% if per_page==200 %}selected{% endif %}>200</option>
            </select>
        </div>

        {% if attendance_records.pages > 1 %}
        <nav class="mt-4">
            <ul class="pagination justify-content-center">
                {% for page_num in attendance_records.iter_pages() %}
                {% if page_num %}
                <li class="page-item {{ 'active' if page_num == attendance_records.page }}">
                    <a class="page-link shadow-none"
                        href="{{ url_for('attendance_list_view', page=page_num, date_range=current_filters.date_range, start_date=current_filters.start_date, end_date=current_filters.end_date, employee=current_filters.employee, status=current_filters.status, department=current_filters.department, designation_id=current_filters.designation_id, employment_type=current_filters.employment_type, company_id=current_filters.company_id, per_page=per_page) }}">{{
                        page_num }}</a>
                </li>
                {% else %}
                <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
                {% endfor %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>
</div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const dateRangeSelect = document.querySelector('select[name="date_range"]');
        const customDateRange = document.getElementById('customDateRange');

        if (dateRangeSelect && customDateRange) {
            dateRangeSelect.addEventListener('change', function () {
                if (this.value === 'custom') {
                    customDateRange.classList.remove('d-none');
                } else {
                    customDateRange.classList.add('d-none');
                }
            });
        }
    });

    function exportAttendance() {
        const urlParams = new URLSearchParams(window.location.search);
        // We don't need page/per_page for export as it exports all
        urlParams.delete('page');
        urlParams.delete('per_page');

        const exportUrl = "{{ url_for('attendance_export') }}?" + urlParams.toString();
        window.location.href = exportUrl;
    }

    function changePerPage(amount) {
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set('per_page', amount);
        urlParams.set('page', 1); // Reset to page 1
        window.location.search = urlParams.toString();
    }

</script>
{% endblock %}