{% extends "base.html" %}

{% block title %}Attendance Calendar{% endblock %}

{% block head %}
{{ super() }}
<!-- FullCalendar CSS -->
<link href="{{ url_for('static', filename='vendors/fullcalendar/main.min.css') }}" rel="stylesheet">{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h3 mb-0 text-gray-800">Attendance Calendar</h1>
                <div class="btn-group">
                    <a href="{{ url_for('attendance_list_view') }}" class="btn btn-outline-primary">
                        <i class="fas fa-list me-1"></i> List View
                    </a>
                    <a href="{{ url_for('attendance_bulk_manage') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-users me-1"></i> Bulk Manage
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Calendar View (70%) -->
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-calendar-alt me-2"></i>Employee Calendar
                    </h6>
                </div>
                <div class="card-body">
                    {% if current_user.role.name in ['Super Admin', 'Admin', 'HR Manager'] %}
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="employeeFilter" class="form-label">Select Employee:</label>
                            <select id="employeeFilter" class="form-control">
                                {% for emp in employees %}
                                <option value="{{ emp.id }}" {% if emp.id==default_employee_id %}selected{% endif %}>
                                    {{ emp.first_name }} {{ emp.last_name }} ({{ emp.employee_id }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    {% endif %}
                    <div id="calendar"></div>
                </div>
            </div>
        </div>

        <!-- Summary Panel (30%) -->
        <div class="col-lg-4 summary-panel">
            <div class="card">
                <div class="card-header"><i class="fas fa-chart-pie me-2"></i>Attendance Summary</div>
                <div class="card-body">
                    <div class="stat-item">
                        <span class="stat-label"><i class="fas fa-check-circle text-success"></i>Present Days</span>
                        <span class="stat-value present">{{ summary.present_days if summary else '0' }}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label"><i class="fas fa-times-circle text-danger"></i>Absent Days</span>
                        <span class="stat-value absent">{{ summary.absent_days if summary else '0' }}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label"><i class="fas fa-plane-departure text-primary"></i>On Leave</span>
                        <span class="stat-value leave">{{ summary.leave_days if summary else '0' }}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label"><i class="fas fa-hourglass-half text-secondary"></i>Total Hours</span>
                        <span class="stat-value hours">{{ "%.1f"|format(summary.total_hours if summary else 0)
                            }}h</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><i class="fas fa-bell me-2"></i>Upcoming Events</div>
                <div class="card-body">
                    <!-- This is a placeholder. You would loop through upcoming events from your backend -->
                    <div class="stat-item">
                        <span class="stat-label"><i class="fas fa-umbrella-beach text-info"></i>Public Holiday</span>
                        <span class="stat-value">Christmas Day</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label"><i class="fas fa-plane text-warning"></i>Approved Leave</span>
                        <span class="stat-value">Dec 26 - Dec 28</span>
                    </div>
                    <div class="text-center text-muted small mt-3">
                        No other upcoming events.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Attendance Detail Modal -->
<div class="modal fade" id="attendanceModal" tabindex="-1" role="dialog" aria-labelledby="attendanceModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="attendanceModalLabel">Attendance Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p><strong>Date:</strong> <span id="modal-date"></span></p>
                <p><strong>Status:</strong> <span id="modal-status"></span></p>
                <div id="modal-details-present">
                    <p><strong>Clock In:</strong> <span id="modal-clock-in"></span></p>
                    <p><strong>Clock Out:</strong> <span id="modal-clock-out"></span></p>
                    <p><strong>Total Hours:</strong> <span id="modal-total-hours"></span></p>
                </div>
                <div id="modal-details-leave">
                    <p><strong>Leave Type:</strong> <span id="modal-leave-type"></span></p>
                </div>
                <p><strong>Remarks:</strong> <span id="modal-remarks"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- FullCalendar JS -->
<script src="{{ url_for('static', filename='vendors/fullcalendar/main.min.js') }}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const calendarEl = document.getElementById('calendar');
        const employeeFilter = document.getElementById('employeeFilter');
        let selectedEmployeeId = employeeFilter ? employeeFilter.value : '{{ default_employee_id }}';

        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth'
            },
            events: function (fetchInfo, successCallback, failureCallback) {
                if (!selectedEmployeeId) {
                    successCallback([]);
                    return;
                }
                const url = `/api/attendance/calendar-data?employee_id=${selectedEmployeeId}&start=${fetchInfo.startStr}&end=${fetchInfo.endStr}`;

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            console.error('Error fetching calendar data:', data.error);
                            failureCallback(data.error);
                            return;
                        }

                        const events = data.map(item => {
                            let eventClass = '';
                            let title = item.status;
                            switch (String(item.status).toLowerCase()) { // Ensure status is a string
                                case 'present': eventClass = 'event-present'; break;
                                case 'absent': eventClass = 'event-absent'; break;
                                case 'leave': eventClass = 'event-leave'; title = item.leave_type || 'Leave'; break;
                                case 'wfh': eventClass = 'event-wfh'; break;
                                case 'half-day': eventClass = 'event-half-day'; break;
                                case 'holiday': eventClass = 'event-holiday'; break;
                                default: eventClass = 'event-present'; title = 'Present'; break; // Default to Present
                            }
                            return {
                                title: title,
                                start: item.date,
                                allDay: true,
                                classNames: [eventClass],
                                extendedProps: item
                            };
                        });
                        successCallback(events);
                    })
                    .catch(error => {
                        console.error('Error fetching events:', error);
                        failureCallback(error);
                    });
            },
            eventClick: function (info) {
                const props = info.event.extendedProps;
                const eventDate = new Date(props.date + 'T00:00:00'); // Avoid timezone issues

                document.getElementById('modal-date').textContent = eventDate.toLocaleDateString('en-CA');
                document.getElementById('modal-status').textContent = props.status;
                document.getElementById('modal-remarks').textContent = props.remarks || 'N/A';

                if (props.status === 'Leave') {
                    document.getElementById('modal-details-present').style.display = 'none';
                    document.getElementById('modal-details-leave').style.display = 'block';
                    document.getElementById('modal-leave-type').textContent = props.leave_type || 'N/A';
                } else {
                    document.getElementById('modal-details-present').style.display = 'block';
                    document.getElementById('modal-details-leave').style.display = 'none';
                    document.getElementById('modal-clock-in').textContent = props.clock_in || 'N/A';
                    document.getElementById('modal-clock-out').textContent = props.clock_out || 'N/A';
                    document.getElementById('modal-total-hours').textContent = props.total_hours || 'N/A';
                }

                $('#attendanceModal').modal('show');
            },
            dayCellDidMount: function (arg) {
                // Grey out weekends
                if (arg.isWeekend) {
                    arg.el.style.backgroundColor = '#f8f9fa';
                }
            }
        });

        calendar.render();

        if (employeeFilter) {
            employeeFilter.addEventListener('change', function () {
                selectedEmployeeId = this.value;
                calendar.refetchEvents();
            });
        }
    });
</script>
{% endblock %}