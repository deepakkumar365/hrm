{% extends "base.html" %}

{% block title %}OT Attendance Report - HR Manager{% endblock %}

{% block head %}
<style>
    .report-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 1.5rem;
    }

    .report-header {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
    }

    .report-header h2 {
        margin: 0 0 1rem 0;
        font-size: 1.8rem;
        font-weight: 700;
    }

    .filter-section {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .filter-row {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: flex-end;
    }

    .filter-group {
        flex: 1;
        min-width: 150px;
    }

    .filter-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #2c3e50;
        font-size: 0.9rem;
    }

    .filter-group input {
        width: 100%;
        padding: 0.6rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.9rem;
    }

    .btn-filter {
        padding: 0.6rem 1.5rem;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
    }

    .btn-filter:hover {
        background: #2980b9;
        transform: translateY(-2px);
    }

    .btn-export {
        padding: 0.6rem 1.5rem;
        background: #27ae60;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
    }

    .btn-export:hover {
        background: #229954;
        transform: translateY(-2px);
    }

    .ot-table {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .ot-table table {
        width: 100%;
        border-collapse: collapse;
    }

    .ot-table th {
        background: #f8f9fa;
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        color: #2c3e50;
        border-bottom: 2px solid #e0e0e0;
    }

    .ot-table td {
        padding: 1rem;
        border-bottom: 1px solid #f0f0f0;
    }

    .ot-table tr:hover {
        background: #f9f9f9;
    }

    .status-badge {
        display: inline-block;
        padding: 0.4rem 0.8rem;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .status-approved {
        background: #d4edda;
        color: #155724;
    }

    .status-pending {
        background: #fff3cd;
        color: #856404;
    }

    .status-rejected {
        background: #f8d7da;
        color: #721c24;
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #95a5a6;
    }

    .summary-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .stat-card {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-left: 4px solid #3498db;
    }

    .stat-card-value {
        font-size: 2rem;
        font-weight: 700;
        color: #2c3e50;
    }

    .stat-card-label {
        font-size: 0.85rem;
        color: #666;
        margin-top: 0.5rem;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="report-container">
    <div class="report-header">
        <h2><i class="fas fa-list-check"></i> OT Attendance Report</h2>
        <p style="margin: 0; opacity: 0.9;">View and manage overtime attendance records</p>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
        <form method="GET" class="filter-row">
            <div class="filter-group" style="flex: 0 0 150px;">
                <label>From Date</label>
                <input type="date" name="date_from" value="{{ date_from }}" required>
            </div>
            <div class="filter-group" style="flex: 0 0 150px;">
                <label>To Date</label>
                <input type="date" name="date_to" value="{{ date_to }}" required>
            </div>
            <button type="submit" class="btn-filter" style="align-self: flex-end;">
                <i class="fas fa-filter"></i> Filter
            </button>
            <button type="button" class="btn-export" style="align-self: flex-end;" onclick="exportToExcel();">
                <i class="fas fa-download"></i> Export Excel
            </button>
        </form>
    </div>

    <!-- Summary Stats -->
    {% if ot_records.items %}
        <div class="summary-stats">
            <div class="stat-card">
                <div class="stat-card-value">{{ ot_records.total }}</div>
                <div class="stat-card-label">Total OT Records</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-value">
                    {% set total_hours = ot_records.items | map(attribute='ot_hours') | map('default', 0) | sum %}
                    {{ "%.1f" | format(total_hours) }}h
                </div>
                <div class="stat-card-label">Total OT Hours</div>
            </div>
        </div>
    {% endif %}

    <!-- OT Attendance Table -->
    {% if ot_records.items %}
        <div class="ot-table">
            <table id="otTable">
                <thead>
                    <tr>
                        <th>Employee</th>
                        <th>OT Date</th>
                        <th>In Time</th>
                        <th>Out Time</th>
                        <th>OT Hours</th>
                        <th>OT Type</th>
                        <th>Status</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in ot_records.items %}
                        <tr>
                            <td><strong>{{ record.employee.name }}</strong></td>
                            <td>{{ record.ot_date.strftime('%d/%m/%Y') }}</td>
                            <td>{{ record.in_time or 'N/A' }}</td>
                            <td>{{ record.out_time or 'N/A' }}</td>
                            <td><strong>{% if record.ot_hours %}{{ "%.2f" | format(record.ot_hours) }}h{% else %}0.00h{% endif %}</strong></td>
                            <td>{{ record.ot_type.name if record.ot_type else 'N/A' }}</td>
                            <td>
                                <span class="status-badge status-approved">Recorded</span>
                            </td>
                            <td>{{ record.notes or '-' }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if ot_records.pages > 1 %}
            <div style="margin-top: 1.5rem; display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;">
                {% if ot_records.has_prev %}
                    <a href="?page=1&date_from={{ date_from }}&date_to={{ date_to }}" class="btn btn-secondary" style="padding: 0.5rem 1rem;">First</a>
                    <a href="?page={{ ot_records.prev_num }}&date_from={{ date_from }}&date_to={{ date_to }}" class="btn btn-secondary" style="padding: 0.5rem 1rem;">Previous</a>
                {% endif %}

                {% for page_num in ot_records.iter_pages() %}
                    {% if page_num %}
                        {% if page_num == ot_records.page %}
                            <span style="padding: 0.5rem 1rem; background: #3498db; color: white; border-radius: 4px;">{{ page_num }}</span>
                        {% else %}
                            <a href="?page={{ page_num }}&date_from={{ date_from }}&date_to={{ date_to }}" class="btn btn-secondary" style="padding: 0.5rem 1rem;">{{ page_num }}</a>
                        {% endif %}
                    {% endif %}
                {% endfor %}

                {% if ot_records.has_next %}
                    <a href="?page={{ ot_records.next_num }}&date_from={{ date_from }}&date_to={{ date_to }}" class="btn btn-secondary" style="padding: 0.5rem 1rem;">Next</a>
                    <a href="?page={{ ot_records.pages }}&date_from={{ date_from }}&date_to={{ date_to }}" class="btn btn-secondary" style="padding: 0.5rem 1rem;">Last</a>
                {% endif %}
            </div>
        {% endif %}
    {% else %}
        <div class="empty-state">
            <i class="fas fa-inbox" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
            <h3 style="color: #2c3e50;">No OT Records Found</h3>
            <p>No overtime records for the selected date range.</p>
        </div>
    {% endif %}

    <div style="margin-top: 2rem; text-align: center;">
        <a href="{{ url_for('hr_manager_dashboard') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
    </div>
</div>

<script>
    function exportToExcel() {
        const table = document.getElementById('otTable');
        if (!table) return;

        let csv = [];
        const rows = table.querySelectorAll('tr');

        rows.forEach(row => {
            const cells = row.querySelectorAll('th, td');
            const cellData = Array.from(cells).map(cell => '"' + cell.innerText.replace(/"/g, '""') + '"');
            csv.push(cellData.join(','));
        });

        const csvContent = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv.join('\n'));
        const link = document.createElement('a');
        link.setAttribute('href', csvContent);
        link.setAttribute('download', 'ot_attendance_' + new Date().toISOString().split('T')[0] + '.csv');
        link.click();
    }
</script>
{% endblock %}