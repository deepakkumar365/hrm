{% extends "base.html" %}

{% block title %}{{ "Edit Employee" if employee else "Add Employee" }} - Noltrion{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-1">
                <div>
                    <h4>
                        <i class="fas fa-user-{{ 'edit' if employee else 'plus' }} me-2"></i>
                        {{ "Edit Employee" if employee else "Add Employee" }}
                    </h4>
                    {% if employee %}
                    <p class="text-muted mb-0">Employee ID: {{ employee.employee_id }}</p>
                    {% endif %}
                </div>
                <a href="{{ url_for('employee_list') }}" class="btn btn-primary">
                    <i class="fas fa-arrow-left me-1"></i>Back to List
                </a>
            </div>

            <!-- Form -->
            <form method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>
                <div class="card">
                    <div class="card-header card-header-green">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>Personal Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="form-grid">
                            <div class="form-grid-item">
                                <label for="employee_id" class="form-label">Employee ID *</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="employee_id" name="employee_id"
                                           value="{{ form_data.get('employee_id') if form_data else (employee.employee_id if employee else '') }}"
                                           placeholder="Auto-generated (select company first)"
                                           {% if not employee %}readonly{% endif %} required>
                                    {% if not employee %}
                                    <span class="input-group-text" id="generateEmployeeIdBtn" style="cursor: pointer; background-color: #f8f9fa;" title="Auto-generated from Company Code + Employee ID">
                                        <i class="fas fa-sync-alt me-1" id="generatingIcon" style="display:none;"></i>
                                        <i class="fas fa-info-circle"></i>
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="form-grid-item">
                                <label for="first_name" class="form-label">First Name *</label>
                                <input type="text" class="form-control" id="first_name" name="first_name"
                                       value="{{ form_data.get('first_name') if form_data else (employee.first_name if employee else '') }}" required>
                            </div>
                            <div class="form-grid-item">
                                <label for="last_name" class="form-label">Last Name *</label>
                                <input type="text" class="form-control" id="last_name" name="last_name"
                                       value="{{ form_data.get('last_name') if form_data else (employee.last_name if employee else '') }}" required>
                            </div>
                            <div class="form-grid-item">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" name="email"
                                       value="{{ form_data.get('email') if form_data else (employee.email if employee else '') }}">
                            </div>
                            <div class="form-grid-item">
                                <label for="phone" class="form-label">Phone</label>
                                <input type="tel" class="form-control" id="phone" name="phone"
                                       value="{{ form_data.get('phone') if form_data else (employee.phone if employee else '') }}">
                            </div>
                            <div class="form-grid-item">
                                <label for="nric" class="form-label">NRIC/Passport *</label>
                                <input type="text" class="form-control" id="nric" name="nric"
                                       value="{{ form_data.get('nric') if form_data else (employee.nric if employee else '') }}"
                                       placeholder="e.g., S1234567D or E12345678"
                                       {% if employee %}readonly{% else %}required{% endif %}>
                            </div>
                            <div class="form-grid-item">
                                <label for="date_of_birth" class="form-label">Date of Birth</label>
                                <input type="date" class="form-control" id="date_of_birth" name="date_of_birth"
                                       value="{{ form_data.get('date_of_birth') if form_data else (employee.date_of_birth.strftime('%Y-%m-%d') if employee and employee.date_of_birth else '') }}"
                                       placeholder="Select from calendar" inputmode="none">
                            </div>
                            <div class="form-grid-item">
                                <label for="gender" class="form-label">Gender</label>
                                <select class="form-select" id="gender" name="gender">
                                    <option value="">Select Gender</option>
                                    <option value="Male" {% if (form_data and form_data.get('gender') == 'Male') or (employee and employee.gender == 'Male' and not form_data) %}selected{% endif %}>Male</option>
                                    <option value="Female" {% if (form_data and form_data.get('gender') == 'Female') or (employee and employee.gender == 'Female' and not form_data) %}selected{% endif %}>Female</option>
                                </select>
                            </div>
                            <div class="form-grid-item">
                                <label for="nationality" class="form-label">Nationality</label>
                                <select class="form-select" id="nationality" name="nationality">
                                    <option value="">Select Nationality</option>
                                    <option value="Singaporean" {% if employee and employee.nationality == 'Singaporean' %}selected{% endif %}>Singaporean</option>
                                    <option value="Malaysian" {% if employee and employee.nationality == 'Malaysian' %}selected{% endif %}>Malaysian</option>
                                    <option value="Indian" {% if employee and employee.nationality == 'Indian' %}selected{% endif %}>Indian</option>
                                    <option value="Chinese" {% if employee and employee.nationality == 'Chinese' %}selected{% endif %}>Chinese</option>
                                    <option value="Filipino" {% if employee and employee.nationality == 'Filipino' %}selected{% endif %}>Filipino</option>
                                    <option value="Indonesian" {% if employee and employee.nationality == 'Indonesian' %}selected{% endif %}>Indonesian</option>
                                    <option value="Other" {% if employee and employee.nationality == 'Other' %}selected{% endif %}>Other</option>
                                </select>
                            </div>
                            <div class="form-grid-item">
                                <label for="postal_code" class="form-label">Postal Code</label>
                                <input type="text" class="form-control" id="postal_code" name="postal_code"
                                       value="{{ form_data.get('postal_code') if form_data else (employee.postal_code if employee else '') }}">
                            </div>
                            <!-- Profile Image Upload -->
                            <div class="form-grid-item half-width">
                                <label for="profile_image" class="form-label">Profile Image</label>
                                <input type="file" class="form-control" id="profile_image" name="profile_image" accept="image/*">
                                {% if employee and employee.profile_image_path %}
                                <div class="mb-3 mt-2">
                                    <p class="text-muted mb-2"><small><i class="fas fa-image me-1"></i>Current Profile Image:</small></p>
                                    <div class="profile-image-container" style="width:120px;height:120px;">
                                        <img src="{{ url_for('static', filename=employee.profile_image_path) }}" alt="Current profile image">
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            <div class="form-grid-item full-width">
                                <label for="address" class="form-label">Address</label>
                                <textarea class="form-control" id="address" name="address" rows="2">{{ form_data.get('address') if form_data else (employee.address if employee else '') }}</textarea>
                            </div>



                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header card-header-green">
                        <h5 class="mb-0">
                            <i class="fas fa-briefcase me-2"></i>Employment Details
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="form-grid">
                            <div class="form-grid-item">
                                <label for="company_id" class="form-label">Company *</label>
                                <select class="form-select" id="company_id" name="company_id" required>
                                    <option value="">Select Company</option>
                                    {% for company in companies %}
                                    <option value="{{ company.id }}" {% if (form_data and form_data.get('company_id') == company.id|string) or (employee and employee.company_id and employee.company_id|string == company.id|string and not form_data) %}selected{% endif %}>
                                        {{ company.name }} ({{ company.code }})
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-grid-item">
                                <label for="designation_id" class="form-label">Designation *</label>
                                <select class="form-select" id="designation_id" name="designation_id" required>
                                    <option value="">Select Designation</option>
                                    {% for designation in designations %}
                                    <option value="{{ designation.id }}" {% if (form_data and form_data.get('designation_id') == designation.id|string) or (employee and employee.designation_id and employee.designation_id|string == designation.id|string and not form_data) %}selected{% endif %}>
                                        {{ designation.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-grid-item">
                                <label for="user_role_id" class="form-label">User Role (System Access) *</label>
                                <select class="form-select" id="user_role_id" name="user_role_id" required>
                                    <option value="">Select User Role</option>
                                    {% for role in user_roles %}
                                    <option value="{{ role.id }}" {% if (form_data and form_data.get('user_role_id') == role.id|string) or (employee and employee.user and employee.user.role_id == role.id and not form_data) %}selected{% endif %}>
                                        {{ role.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-grid-item">
                                <label for="department" class="form-label">Department</label>
                                <select class="form-select" id="department" name="department">
                                    <option value="">Select Department</option>
                                    {% for dept in departments %}
                                    <option value="{{ dept.name }}" {% if (form_data and form_data.get('department') == dept.name) or (employee and employee.department == dept.name and not form_data) %}selected{% endif %}>
                                        {{ dept.name }}
                                        {% if dept.manager %} - ({{ dept.manager.first_name }} {{ dept.manager.last_name }}){% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-grid-item">
                                <label for="manager_id" class="form-label">Reporting Manager</label>
                                <select class="form-select" id="manager_id" name="manager_id">
                                    <option value="">Select Reporting Manager</option>
                                    {% for manager in managers %}
                                    <option value="{{ manager.id }}" {% if (form_data and form_data.get('manager_id') == manager.id|string) or (employee and employee.manager_id and employee.manager_id|string == manager.id|string and not form_data) %}selected{% endif %}>
                                        {{ manager.first_name }} {{ manager.last_name }} - {{ manager.designation.name if manager.designation else '-' }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-grid-item">
                                <div class="form-check mt-2">
                                    <input type="checkbox" class="form-check-input" id="is_manager" name="is_manager" value="1"
                                           {% if (form_data and form_data.get('is_manager')) or (employee and employee.is_manager and not form_data) %}checked{% endif %}>
                                    <label class="form-check-label" for="is_manager">
                                        <i class="fas fa-shield-alt me-1"></i>Can be Reporting Manager
                                    </label>
                                </div>
                            </div>
                            <div class="form-grid-item">
                                <label for="hire_date" class="form-label">Hire Date *</label>
                                <input type="date" class="form-control" id="hire_date" name="hire_date"
                                       value="{{ form_data.get('hire_date') if form_data else (employee.hire_date.strftime('%Y-%m-%d') if employee and employee.hire_date else '') }}"
                                       {% if not employee %}required{% endif %}>
                            </div>
                            <div class="form-grid-item">
                                <label for="employment_type" class="form-label">Employment Type *</label>
                                <select class="form-select" id="employment_type" name="employment_type" required>
                                    <option value="">Select Type</option>
                                    <option value="Full-time" {% if (form_data and form_data.get('employment_type') == 'Full-time') or (employee and employee.employment_type == 'Full-time' and not form_data) %}selected{% endif %}>Full-time</option>
                                    <option value="Part-time" {% if (form_data and form_data.get('employment_type') == 'Part-time') or (employee and employee.employment_type == 'Part-time' and not form_data) %}selected{% endif %}>Part-time</option>
                                    <option value="Contract" {% if (form_data and form_data.get('employment_type') == 'Contract') or (employee and employee.employment_type == 'Contract' and not form_data) %}selected{% endif %}>Contract</option>
                                    <option value="Intern" {% if (form_data and form_data.get('employment_type') == 'Intern') or (employee and employee.employment_type == 'Intern' and not form_data) %}selected{% endif %}>Intern</option>
                                </select>
                            </div>
                            <div class="form-grid-item">
                                <label for="work_permit_type" class="form-label">Work Permit Type *</label>
                                <select class="form-select" id="work_permit_type" name="work_permit_type" required>
                                    <option value="">Select Type</option>
                                    <option value="Citizen" {% if employee and employee.work_permit_type == 'Citizen' %}selected{% endif %}>Singapore Citizen</option>
                                    <option value="PR" {% if employee and employee.work_permit_type == 'PR' %}selected{% endif %}>Permanent Resident</option>
                                    <option value="Work Permit" {% if employee and employee.work_permit_type == 'Work Permit' %}selected{% endif %}>Work Permit</option>
                                    <option value="S Pass" {% if employee and employee.work_permit_type == 'S Pass' %}selected{% endif %}>S Pass</option>
                                    <option value="Employment Pass" {% if employee and employee.work_permit_type == 'Employment Pass' %}selected{% endif %}>Employment Pass</option>
                                </select>
                            </div>
                            <div class="form-grid-item">
                                <label for="work_permit_expiry" class="form-label">Work Permit Expiry</label>
                                <input type="date" class="form-control" id="work_permit_expiry" name="work_permit_expiry"
                                       value="{{ employee.work_permit_expiry.strftime('%Y-%m-%d') if employee and employee.work_permit_expiry else '' }}">
                            </div>
                            <div class="form-grid-item">
                                <label for="work_permit_number" class="form-label">Work Permit Number</label>
                                <input type="text" class="form-control" id="work_permit_number" name="work_permit_number"
                                       value="{{ form_data.get('work_permit_number') if form_data else (employee.work_permit_number if employee else '') }}"
                                       placeholder="e.g., WP123456789">
                            </div>
                            <div class="form-grid-item">
                                <label for="working_hours_id" class="form-label">Working Hours</label>
                                <select class="form-select" id="working_hours_id" name="working_hours_id">
                                    <option value="">Select Working Hours</option>
                                    {% for wh in working_hours %}
                                    <option value="{{ wh.id }}" {% if employee and employee.working_hours_id == wh.id %}selected{% endif %}>
                                        {{ wh.name }} ({{ wh.hours_per_day }}h/day, {{ wh.hours_per_week }}h/week)
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-grid-item">
                                <label for="work_schedule_id" class="form-label">Work Schedule</label>
                                <select class="form-select" id="work_schedule_id" name="work_schedule_id">
                                    <option value="">Select Work Schedule</option>
                                    {% for schedule in work_schedules %}
                                    <option value="{{ schedule.id }}" {% if employee and employee.work_schedule_id == schedule.id %}selected{% endif %}>
                                        {{ schedule.name }} ({{ schedule.start_time.strftime('%H:%M') }}-{{ schedule.end_time.strftime('%H:%M') }})
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header card-header-green">
                        <h5 class="mb-0">
                            <i class="fas fa-dollar-sign me-2"></i>Payroll Configuration
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="form-grid">
                            <div class="form-grid-item">
                                <label for="basic_salary" class="form-label">Basic Salary (SGD) *</label>
                                <input type="number" class="form-control" id="basic_salary" name="basic_salary"
                                       step="0.01" min="0" value="{{ form_data.get('basic_salary') if form_data else (employee.basic_salary if employee else '') }}" required>
                            </div>
                            <div class="form-grid-item">
                                <label for="allowances" class="form-label">Monthly Allowances (SGD)</label>
                                <input type="number" class="form-control" id="allowances" name="allowances"
                                       step="0.01" min="0" value="{{ form_data.get('allowances') if form_data else (employee.allowances if employee else '0') }}">
                            </div>
                            <div class="form-grid-item">
                                <label for="hourly_rate" class="form-label">Hourly Rate (SGD)</label>
                                <input type="number" class="form-control" id="hourly_rate" name="hourly_rate"
                                       step="0.01" min="0" value="{{ form_data.get('hourly_rate') if form_data else (employee.hourly_rate if employee else '') }}">
                            </div>
                            <div class="form-grid-item">
                                <label for="overtime_group_id" class="form-label">Overtime Group</label>
                                <select class="form-select" id="overtime_group_id" name="overtime_group_id">
                                    <option value="">Select Overtime Group</option>
                                    {% if overtime_groups %}
                                        {% for group in overtime_groups %}
                                        <option value="{{ group }}" {% if (form_data and form_data.get('overtime_group_id') == group) or (employee and employee.overtime_group_id == group and not form_data) %}selected{% endif %}>
                                            {{ group }}
                                        </option>
                                        {% endfor %}
                                    {% else %}
                                        <option value="Group 1" {% if employee and employee.overtime_group_id == 'Group 1' %}selected{% endif %}>Group 1</option>
                                        <option value="Group 2" {% if employee and employee.overtime_group_id == 'Group 2' %}selected{% endif %}>Group 2</option>
                                        <option value="Group 3" {% if employee and employee.overtime_group_id == 'Group 3' %}selected{% endif %}>Group 3</option>
                                    {% endif %}
                                </select>
                            </div>
                            <div class="form-grid-item">
                                <label for="cpf_account" class="form-label">CPF Account Number</label>
                                <input type="text" class="form-control" id="cpf_account" name="cpf_account"
                                       value="{{ employee.cpf_account if employee else '' }}">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header card-header-warning">
                        <h5 class="mb-0">
                            <i class="fas fa-calendar-check me-2"></i>Certifications & Pass Renewals
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">
                            <i class="fas fa-info-circle me-2"></i>Important dates for certifications and passes that require periodic renewal. These dates are tracked for renewal management.
                        </p>
                        <div class="form-grid">
                            <div class="form-grid-item">
                                <label for="hazmat_expiry" class="form-label">HAZMAT Expiry Date</label>
                                <input type="date" class="form-control" id="hazmat_expiry" name="hazmat_expiry"
                                       value="{{ form_data.get('hazmat_expiry') if form_data else (employee.hazmat_expiry.strftime('%Y-%m-%d') if employee and employee.hazmat_expiry else '') }}">
                            </div>
                            <div class="form-grid-item">
                                <label for="airport_pass_expiry" class="form-label">Airport Pass Expiry Date</label>
                                <input type="date" class="form-control" id="airport_pass_expiry" name="airport_pass_expiry"
                                       value="{{ form_data.get('airport_pass_expiry') if form_data else (employee.airport_pass_expiry.strftime('%Y-%m-%d') if employee and employee.airport_pass_expiry else '') }}">
                            </div>
                            <div class="form-grid-item">
                                <label for="psa_pass_number" class="form-label">PSA PASS NO</label>
                                <input type="text" class="form-control" id="psa_pass_number" name="psa_pass_number"
                                       value="{{ form_data.get('psa_pass_number') if form_data else (employee.psa_pass_number if employee else '') }}"
                                       placeholder="e.g., PSA123456">
                            </div>
                            <div class="form-grid-item">
                                <label for="psa_pass_expiry" class="form-label">PSA PASS NO Expiry Date</label>
                                <input type="date" class="form-control" id="psa_pass_expiry" name="psa_pass_expiry"
                                       value="{{ form_data.get('psa_pass_expiry') if form_data else (employee.psa_pass_expiry.strftime('%Y-%m-%d') if employee and employee.psa_pass_expiry else '') }}">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submit buttons -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="d-flex gap-2 justify-content-end">
                            <a href="{{ url_for('employee_list') }}" class="btn btn-primary">
                                <i class="fas fa-times me-1"></i>Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>
                                {{ "Update Employee" if employee else "Add Employee" }}
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Form validation
(function() {
    'use strict';
    window.addEventListener('load', function() {
        var forms = document.getElementsByClassName('needs-validation');
        var validation = Array.prototype.filter.call(forms, function(form) {
            form.addEventListener('submit', function(event) {
                if (form.checkValidity() === false) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    }, false);
})();

// Auto-calculate hourly rate from basic salary
document.getElementById('basic_salary').addEventListener('input', function() {
    const basicSalary = parseFloat(this.value) || 0;
    const hourlyRateField = document.getElementById('hourly_rate');

    if (basicSalary > 0 && !hourlyRateField.value) {
        // Assume 22 working days, 8 hours per day
        const hourlyRate = (basicSalary / (22 * 8)).toFixed(2);
        hourlyRateField.value = hourlyRate;
    }
});

// Show/hide work permit expiry based on permit type
document.getElementById('work_permit_type').addEventListener('change', function() {
    const expiryField = document.getElementById('work_permit_expiry');
    const citizenTypes = ['Citizen', 'PR'];

    if (citizenTypes.includes(this.value)) {
        expiryField.disabled = true;
        expiryField.value = '';
    } else {
        expiryField.disabled = false;
    }
});

// Form submission - Show loading state and disable button
document.querySelector('form.needs-validation').addEventListener('submit', function(e) {
    // Don't prevent default, but show loading state
    if (this.checkValidity() !== false) {
        const submitBtn = document.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.disabled = true;
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Processing...';
            
            // In case of error, re-enable after 5 seconds
            setTimeout(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }, 5000);
        }
    }
});
</script>
<script>
// NRIC/Passport blur validation with sample messages
(function() {
  const nricInput = document.getElementById('nric');
  if (!nricInput) return;
  if (nricInput.hasAttribute('readonly')) return;
  const invalidFeedback = nricInput.parentElement.querySelector('.invalid-feedback');
  const sample = 'Sample: NRIC S1234567D; Passport E12345678.';
  function isValid(value) {
    const v = value.trim().toUpperCase();
    const nric = /^[STFG]\d{7}[A-Z]$/.test(v);
    const passport = /^[A-Z]\d{8}$/.test(v);
    return nric || passport;
  }
  function setInvalid(msg) {
    if (invalidFeedback) invalidFeedback.textContent = msg;
    nricInput.classList.add('is-invalid');
    nricInput.classList.remove('is-valid');
  }
  function setValid() {
    nricInput.classList.remove('is-invalid');
    nricInput.classList.add('is-valid');
  }
  nricInput.addEventListener('blur', function() {
    const val = this.value.trim();
    if (!val) {
      setInvalid('NRIC/Passport is required. ' + sample);
      return;
    }
    if (!isValid(val)) {
      setInvalid('Invalid NRIC/Passport format. ' + sample);
      return;
    }
    setValid();
  });
  nricInput.addEventListener('input', function() {
    const val = this.value.trim();
    if (isValid(val)) setValid();
  });
})();
</script>
<script>
// Date of Birth UX & restrictions
(function() {
  const dob = document.getElementById('date_of_birth');
  if (!dob) return;

  // Set allowed date range: 1900-01-01 to today
  const today = new Date();
  const pad = n => String(n).padStart(2, '0');
  const todayStr = `${today.getFullYear()}-${pad(today.getMonth()+1)}-${pad(today.getDate())}`;
  dob.setAttribute('min', '1900-01-01');
  dob.setAttribute('max', todayStr);

  // Helper to clamp value within min/max
  function clampDate() {
    if (!dob.value) return;
    const min = dob.getAttribute('min');
    const max = dob.getAttribute('max');
    if (min && dob.value < min) dob.value = min;
    if (max && dob.value > max) dob.value = max;
  }

  // Open calendar when focusing/clicking the field
  const openPicker = () => { if (typeof dob.showPicker === 'function') try { dob.showPicker(); } catch(_) {} };
  dob.addEventListener('focus', openPicker);
  dob.addEventListener('click', openPicker);

  // Prevent manual typing (allow navigation/edit keys)
  dob.addEventListener('keydown', (e) => {
    const allowed = ['Tab','ArrowLeft','ArrowRight','ArrowUp','ArrowDown','Backspace','Delete','Home','End'];
    if (!allowed.includes(e.key)) e.preventDefault();
  });

  // Enforce range on change/blur
  dob.addEventListener('change', clampDate);
  dob.addEventListener('blur', clampDate);
})();
</script>
<script>
// Auto-generate Employee ID when company is selected
{% if not employee %}
document.addEventListener('DOMContentLoaded', function() {
    const companySelect = document.getElementById('company_id');
    const employeeIdField = document.getElementById('employee_id');
    const generatingIcon = document.getElementById('generatingIcon');
    const infoIcon = generatingIcon.nextElementSibling;

    // Function to generate employee ID
    function generateEmployeeId() {
        const companyId = companySelect.value;

        if (!companyId) {
            employeeIdField.value = '';
            employeeIdField.classList.remove('is-valid', 'is-invalid');
            infoIcon.style.display = 'inline';
            generatingIcon.style.display = 'none';
            return;
        }

        // Show loading state
        generatingIcon.style.display = 'inline';
        infoIcon.style.display = 'none';

        fetch(`/employees/generate-id?company_id=${encodeURIComponent(companyId)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.employee_id) {
                    employeeIdField.value = data.employee_id;
                    employeeIdField.classList.add('is-valid');
                    employeeIdField.classList.remove('is-invalid');

                    // Show loading complete
                    generatingIcon.style.display = 'none';
                    infoIcon.style.display = 'inline';
                } else {
                    employeeIdField.value = '';
                    employeeIdField.classList.add('is-invalid');
                    employeeIdField.classList.remove('is-valid');
                    generatingIcon.style.display = 'none';
                    infoIcon.style.display = 'inline';
                    console.error('Error generating Employee ID:', data.message);
                }
            })
            .catch(error => {
                employeeIdField.value = '';
                employeeIdField.classList.add('is-invalid');
                employeeIdField.classList.remove('is-valid');
                generatingIcon.style.display = 'none';
                infoIcon.style.display = 'inline';
                console.error('Network error:', error);
            });
    }

    // Trigger generation when company changes
    companySelect.addEventListener('change', generateEmployeeId);

    // If company is already selected (e.g., on form re-render), generate ID
    if (companySelect.value) {
        generateEmployeeId();
    }
});
{% endif %}
</script>
{% endblock %}
