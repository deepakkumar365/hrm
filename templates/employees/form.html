{% extends "base.html" %}

{% block title %}{{ "Edit Employee" if employee else "Add Employee" }} - Noltrion{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h3>
                        <i class="fas fa-user-{{ 'edit' if employee else 'plus' }} me-2"></i>
                        {{ "Edit Employee" if employee else "Add Employee" }}
                    </h3>
                    {% if employee %}
                    <p class="text-muted mb-0">Employee ID: {{ employee.employee_id }}</p>
                    {% endif %}
                </div>
                <a href="{{ url_for('employee_list') }}" class="btn btn-primary">
                    <i class="fas fa-arrow-left me-1"></i>Back to List
                </a>
            </div>

            <!-- Form -->
            <form method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>
                <div class="card">
                    <div class="card-header card-header-green">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>Personal Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="employee_id" class="form-label">Employee ID *</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="employee_id" name="employee_id" 
                                           value="{{ form_data.get('employee_id') if form_data else (employee.employee_id if employee else '') }}" 
                                           placeholder="e.g., EMP001" required>
                                    {% if not employee %}
                                    <button type="button" class="btn btn-outline-secondary" id="generateEmployeeIdBtn" title="Auto-generate Employee ID">
                                        <i class="fas fa-magic me-1"></i>Generate
                                    </button>
                                    {% endif %}
                                </div>
                                <div class="invalid-feedback">Please provide an employee ID.</div>
                                <small class="form-text text-muted">Unique identifier for the employee.</small>
                            </div>
                            <div class="col-md-6">
                                <label for="first_name" class="form-label">First Name *</label>
                                <input type="text" class="form-control" id="first_name" name="first_name" 
                                       value="{{ form_data.get('first_name') if form_data else (employee.first_name if employee else '') }}" required>
                                <div class="invalid-feedback">Please provide a first name.</div>
                            </div>
                            <div class="col-md-6">
                                <label for="last_name" class="form-label">Last Name *</label>
                                <input type="text" class="form-control" id="last_name" name="last_name" 
                                       value="{{ form_data.get('last_name') if form_data else (employee.last_name if employee else '') }}" required>
                                <div class="invalid-feedback">Please provide a last name.</div>
                            </div>
                            <div class="col-md-6">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" name="email" 
                                       value="{{ form_data.get('email') if form_data else (employee.email if employee else '') }}">
                                <div class="invalid-feedback">Please provide a valid email.</div>
                            </div>
                            <div class="col-md-6">
                                <label for="phone" class="form-label">Phone</label>
                                <input type="tel" class="form-control" id="phone" name="phone" 
                                       value="{{ form_data.get('phone') if form_data else (employee.phone if employee else '') }}">
                            </div>
                            <div class="col-md-6">
                                <label for="nric" class="form-label">NRIC/Passport *</label>
                                <input type="text" class="form-control" id="nric" name="nric" 
                                       value="{{ form_data.get('nric') if form_data else (employee.nric if employee else '') }}" 
                                       placeholder="e.g., S1234567D or E12345678"
                                       {% if employee %}readonly{% else %}required{% endif %}>
                                <div class="invalid-feedback">Please provide a valid NRIC/Passport. Sample: NRIC S1234567D; Passport E12345678.</div>
                                <small class="form-text text-muted">Sample formats: NRIC S1234567D; Passport E12345678.</small>
                            </div>
                            <div class="col-md-6">
                                <label for="date_of_birth" class="form-label">Date of Birth</label>
                                <input type="date" class="form-control" id="date_of_birth" name="date_of_birth" 
                                       value="{{ form_data.get('date_of_birth') if form_data else (employee.date_of_birth.strftime('%Y-%m-%d') if employee and employee.date_of_birth else '') }}"
                                       placeholder="Select from calendar" inputmode="none">
                            </div>
                            <div class="col-md-6">
                                <label for="gender" class="form-label">Gender</label>
                                <select class="form-select" id="gender" name="gender">
                                    <option value="">Select Gender</option>
                                    <option value="Male" {% if (form_data and form_data.get('gender') == 'Male') or (employee and employee.gender == 'Male' and not form_data) %}selected{% endif %}>Male</option>
                                    <option value="Female" {% if (form_data and form_data.get('gender') == 'Female') or (employee and employee.gender == 'Female' and not form_data) %}selected{% endif %}>Female</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="nationality" class="form-label">Nationality</label>
                                <select class="form-select" id="nationality" name="nationality">
                                    <option value="">Select Nationality</option>
                                    <option value="Singaporean" {% if employee and employee.nationality == 'Singaporean' %}selected{% endif %}>Singaporean</option>
                                    <option value="Malaysian" {% if employee and employee.nationality == 'Malaysian' %}selected{% endif %}>Malaysian</option>
                                    <option value="Indian" {% if employee and employee.nationality == 'Indian' %}selected{% endif %}>Indian</option>
                                    <option value="Chinese" {% if employee and employee.nationality == 'Chinese' %}selected{% endif %}>Chinese</option>
                                    <option value="Filipino" {% if employee and employee.nationality == 'Filipino' %}selected{% endif %}>Filipino</option>
                                    <option value="Indonesian" {% if employee and employee.nationality == 'Indonesian' %}selected{% endif %}>Indonesian</option>
                                    <option value="Other" {% if employee and employee.nationality == 'Other' %}selected{% endif %}>Other</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label for="address" class="form-label">Address</label>
                                <textarea class="form-control" id="address" name="address" rows="2">{{ form_data.get('address') if form_data else (employee.address if employee else '') }}</textarea>
                            </div>
                            <div class="col-md-6">
                                <label for="postal_code" class="form-label">Postal Code</label>
                                <input type="text" class="form-control" id="postal_code" name="postal_code" 
                                       value="{{ form_data.get('postal_code') if form_data else (employee.postal_code if employee else '') }}">
                            </div>

                            <!-- Profile Image Upload -->
                            <div class="col-12">
                                <label for="profile_image" class="form-label">Profile Image</label>
                                <input type="file" class="form-control" id="profile_image" name="profile_image" accept="image/*">
                                <small class="form-text text-muted">Allowed types: png, jpg, jpeg, gif, webp. Max size: 2MB (configurable).</small>
                                {% if employee and employee.profile_image_path %}
                                <div class="mb-3">
                                    <div class="profile-image-container" style="width:120px;height:120px;">
                                        <img src="{{ url_for('static', filename=employee.profile_image_path) }}" alt="Current profile image">
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header card-header-green">
                        <h5 class="mb-0">
                            <i class="fas fa-briefcase me-2"></i>Employment Details
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="company_id" class="form-label">Company *</label>
                                <select class="form-select" id="company_id" name="company_id" required>
                                    <option value="">Select Company</option>
                                    {% for company in companies %}
                                    <option value="{{ company.id }}" {% if (form_data and form_data.get('company_id') == company.id|string) or (employee and employee.company_id and employee.company_id|string == company.id|string and not form_data) %}selected{% endif %}>
                                        {{ company.name }} ({{ company.code }})
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="invalid-feedback">Please select a company.</div>
                                <small class="form-text text-muted">Select the company this employee belongs to.</small>
                            </div>
                            <div class="col-md-6">
                                <label for="position" class="form-label">Position *</label>
                                <select class="form-select" id="position" name="position" required>
                                    <option value="">Select Position</option>
                                    {% for role in roles %}
                                    <option value="{{ role.name }}" {% if (form_data and form_data.get('position') == role.name) or (employee and employee.position == role.name and not form_data) %}selected{% endif %}>
                                        {{ role.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="invalid-feedback">Please select a position.</div>
                                <small class="form-text text-muted">Job title/designation for the employee.</small>
                            </div>
                            <div class="col-md-6">
                                <label for="user_role_id" class="form-label">User Role (System Access) *</label>
                                <select class="form-select" id="user_role_id" name="user_role_id" required>
                                    <option value="">Select User Role</option>
                                    {% for role in user_roles %}
                                    <option value="{{ role.id }}" {% if (form_data and form_data.get('user_role_id') == role.id|string) or (employee and employee.user and employee.user.role_id == role.id and not form_data) %}selected{% endif %}>
                                        {{ role.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="invalid-feedback">Please select a user role.</div>
                                <small class="form-text text-muted">Determines menu access and permissions in the system.</small>
                            </div>
                            <div class="col-md-6">
                                <label for="department" class="form-label">Department</label>
                                <select class="form-select" id="department" name="department">
                                    <option value="">Select Department</option>
                                    {% for dept in departments %}
                                    <option value="{{ dept.name }}" {% if (form_data and form_data.get('department') == dept.name) or (employee and employee.department == dept.name and not form_data) %}selected{% endif %}>
                                        {{ dept.name }}
                                        {% if dept.manager %} - ({{ dept.manager.first_name }} {{ dept.manager.last_name }}){% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="manager_id" class="form-label">Reporting Manager</label>
                                <select class="form-select" id="manager_id" name="manager_id">
                                    <option value="">Select Reporting Manager</option>
                                    {% for manager in managers %}
                                    <option value="{{ manager.id }}" {% if (form_data and form_data.get('manager_id') == manager.id|string) or (employee and employee.manager_id and employee.manager_id|string == manager.id|string and not form_data) %}selected{% endif %}>
                                        {{ manager.first_name }} {{ manager.last_name }} - {{ manager.position }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">Select the direct supervisor/manager for this employee.</small>
                            </div>
                            <div class="col-md-6">
                                <label for="hire_date" class="form-label">Hire Date *</label>
                                <input type="date" class="form-control" id="hire_date" name="hire_date" 
                                       value="{{ form_data.get('hire_date') if form_data else (employee.hire_date.strftime('%Y-%m-%d') if employee and employee.hire_date else '') }}" 
                                       {% if not employee %}required{% endif %}>
                                <div class="invalid-feedback">Please provide a hire date.</div>
                            </div>
                            <div class="col-md-6">
                                <label for="employment_type" class="form-label">Employment Type *</label>
                                <select class="form-select" id="employment_type" name="employment_type" required>
                                    <option value="">Select Type</option>
                                    <option value="Full-time" {% if (form_data and form_data.get('employment_type') == 'Full-time') or (employee and employee.employment_type == 'Full-time' and not form_data) %}selected{% endif %}>Full-time</option>
                                    <option value="Part-time" {% if (form_data and form_data.get('employment_type') == 'Part-time') or (employee and employee.employment_type == 'Part-time' and not form_data) %}selected{% endif %}>Part-time</option>
                                    <option value="Contract" {% if (form_data and form_data.get('employment_type') == 'Contract') or (employee and employee.employment_type == 'Contract' and not form_data) %}selected{% endif %}>Contract</option>
                                    <option value="Intern" {% if (form_data and form_data.get('employment_type') == 'Intern') or (employee and employee.employment_type == 'Intern' and not form_data) %}selected{% endif %}>Intern</option>
                                </select>
                                <div class="invalid-feedback">Please select an employment type.</div>
                            </div>
                            <div class="col-md-6">
                                <label for="work_permit_type" class="form-label">Work Permit Type *</label>
                                <select class="form-select" id="work_permit_type" name="work_permit_type" required>
                                    <option value="">Select Type</option>
                                    <option value="Citizen" {% if employee and employee.work_permit_type == 'Citizen' %}selected{% endif %}>Singapore Citizen</option>
                                    <option value="PR" {% if employee and employee.work_permit_type == 'PR' %}selected{% endif %}>Permanent Resident</option>
                                    <option value="Work Permit" {% if employee and employee.work_permit_type == 'Work Permit' %}selected{% endif %}>Work Permit</option>
                                    <option value="S Pass" {% if employee and employee.work_permit_type == 'S Pass' %}selected{% endif %}>S Pass</option>
                                    <option value="Employment Pass" {% if employee and employee.work_permit_type == 'Employment Pass' %}selected{% endif %}>Employment Pass</option>
                                </select>
                                <div class="invalid-feedback">Please select a work permit type.</div>
                            </div>
                            <div class="col-md-6">
                                <label for="work_permit_expiry" class="form-label">Work Permit Expiry</label>
                                <input type="date" class="form-control" id="work_permit_expiry" name="work_permit_expiry" 
                                       value="{{ employee.work_permit_expiry.strftime('%Y-%m-%d') if employee and employee.work_permit_expiry else '' }}">
                                <small class="form-text text-muted">Leave blank for Citizens/PRs</small>
                            </div>
                            <div class="col-md-6">
                                <label for="working_hours_id" class="form-label">Working Hours</label>
                                <select class="form-select" id="working_hours_id" name="working_hours_id">
                                    <option value="">Select Working Hours</option>
                                    {% for wh in working_hours %}
                                    <option value="{{ wh.id }}" {% if employee and employee.working_hours_id == wh.id %}selected{% endif %}>
                                        {{ wh.name }} ({{ wh.hours_per_day }}h/day, {{ wh.hours_per_week }}h/week)
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="work_schedule_id" class="form-label">Work Schedule</label>
                                <select class="form-select" id="work_schedule_id" name="work_schedule_id">
                                    <option value="">Select Work Schedule</option>
                                    {% for schedule in work_schedules %}
                                    <option value="{{ schedule.id }}" {% if employee and employee.work_schedule_id == schedule.id %}selected{% endif %}>
                                        {{ schedule.name }} ({{ schedule.start_time.strftime('%H:%M') }}-{{ schedule.end_time.strftime('%H:%M') }})
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="manager_id" class="form-label">Manager</label>
                                <select class="form-select" id="manager_id" name="manager_id">
                                    <option value="">Select Manager</option>
                                    {% for manager in managers %}
                                    <option value="{{ manager.id }}" {% if employee and employee.manager_id == manager.id %}selected{% endif %}>
                                        {{ manager.first_name }} {{ manager.last_name }} ({{ manager.position }})
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header card-header-green">
                        <h5 class="mb-0">
                            <i class="fas fa-dollar-sign me-2"></i>Payroll Configuration
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="basic_salary" class="form-label">Basic Salary (SGD) *</label>
                                <input type="number" class="form-control" id="basic_salary" name="basic_salary" 
                                       step="0.01" min="0" value="{{ form_data.get('basic_salary') if form_data else (employee.basic_salary if employee else '') }}" required>
                                <div class="invalid-feedback">Please provide a basic salary.</div>
                            </div>
                            <div class="col-md-6">
                                <label for="allowances" class="form-label">Monthly Allowances (SGD)</label>
                                <input type="number" class="form-control" id="allowances" name="allowances" 
                                       step="0.01" min="0" value="{{ form_data.get('allowances') if form_data else (employee.allowances if employee else '0') }}">
                            </div>
                            <div class="col-md-6">
                                <label for="hourly_rate" class="form-label">Hourly Rate (SGD)</label>
                                <input type="number" class="form-control" id="hourly_rate" name="hourly_rate" 
                                       step="0.01" min="0" value="{{ form_data.get('hourly_rate') if form_data else (employee.hourly_rate if employee else '') }}">
                                <small class="form-text text-muted">For overtime calculations</small>
                            </div>
                            <div class="col-md-6">
                                <label for="cpf_account" class="form-label">CPF Account Number</label>
                                <input type="text" class="form-control" id="cpf_account" name="cpf_account" 
                                       value="{{ employee.cpf_account if employee else '' }}">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submit buttons -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="d-flex gap-2 justify-content-end">
                            <a href="{{ url_for('employee_list') }}" class="btn btn-primary">
                                <i class="fas fa-times me-1"></i>Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>
                                {{ "Update Employee" if employee else "Add Employee" }}
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Form validation
(function() {
    'use strict';
    window.addEventListener('load', function() {
        var forms = document.getElementsByClassName('needs-validation');
        var validation = Array.prototype.filter.call(forms, function(form) {
            form.addEventListener('submit', function(event) {
                if (form.checkValidity() === false) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    }, false);
})();

// Auto-calculate hourly rate from basic salary
document.getElementById('basic_salary').addEventListener('input', function() {
    const basicSalary = parseFloat(this.value) || 0;
    const hourlyRateField = document.getElementById('hourly_rate');
    
    if (basicSalary > 0 && !hourlyRateField.value) {
        // Assume 22 working days, 8 hours per day
        const hourlyRate = (basicSalary / (22 * 8)).toFixed(2);
        hourlyRateField.value = hourlyRate;
    }
});

// Show/hide work permit expiry based on permit type
document.getElementById('work_permit_type').addEventListener('change', function() {
    const expiryField = document.getElementById('work_permit_expiry');
    const citizenTypes = ['Citizen', 'PR'];
    
    if (citizenTypes.includes(this.value)) {
        expiryField.disabled = true;
        expiryField.value = '';
    } else {
        expiryField.disabled = false;
    }
});
</script>
<script>
// NRIC/Passport blur validation with sample messages
(function() {
  const nricInput = document.getElementById('nric');
  if (!nricInput) return;
  if (nricInput.hasAttribute('readonly')) return;
  const invalidFeedback = nricInput.parentElement.querySelector('.invalid-feedback');
  const sample = 'Sample: NRIC S1234567D; Passport E12345678.';
  function isValid(value) {
    const v = value.trim().toUpperCase();
    const nric = /^[STFG]\d{7}[A-Z]$/.test(v);
    const passport = /^[A-Z]\d{8}$/.test(v);
    return nric || passport;
  }
  function setInvalid(msg) {
    if (invalidFeedback) invalidFeedback.textContent = msg;
    nricInput.classList.add('is-invalid');
    nricInput.classList.remove('is-valid');
  }
  function setValid() {
    nricInput.classList.remove('is-invalid');
    nricInput.classList.add('is-valid');
  }
  nricInput.addEventListener('blur', function() {
    const val = this.value.trim();
    if (!val) {
      setInvalid('NRIC/Passport is required. ' + sample);
      return;
    }
    if (!isValid(val)) {
      setInvalid('Invalid NRIC/Passport format. ' + sample);
      return;
    }
    setValid();
  });
  nricInput.addEventListener('input', function() {
    const val = this.value.trim();
    if (isValid(val)) setValid();
  });
})();
</script>
<script>
// Date of Birth UX & restrictions
(function() {
  const dob = document.getElementById('date_of_birth');
  if (!dob) return;

  // Set allowed date range: 1900-01-01 to today
  const today = new Date();
  const pad = n => String(n).padStart(2, '0');
  const todayStr = `${today.getFullYear()}-${pad(today.getMonth()+1)}-${pad(today.getDate())}`;
  dob.setAttribute('min', '1900-01-01');
  dob.setAttribute('max', todayStr);

  // Helper to clamp value within min/max
  function clampDate() {
    if (!dob.value) return;
    const min = dob.getAttribute('min');
    const max = dob.getAttribute('max');
    if (min && dob.value < min) dob.value = min;
    if (max && dob.value > max) dob.value = max;
  }

  // Open calendar when focusing/clicking the field
  const openPicker = () => { if (typeof dob.showPicker === 'function') try { dob.showPicker(); } catch(_) {} };
  dob.addEventListener('focus', openPicker);
  dob.addEventListener('click', openPicker);

  // Prevent manual typing (allow navigation/edit keys)
  dob.addEventListener('keydown', (e) => {
    const allowed = ['Tab','ArrowLeft','ArrowRight','ArrowUp','ArrowDown','Backspace','Delete','Home','End'];
    if (!allowed.includes(e.key)) e.preventDefault();
  });

  // Enforce range on change/blur
  dob.addEventListener('change', clampDate);
  dob.addEventListener('blur', clampDate);
})();
</script>
<script>
// Generate Employee ID functionality
{% if not employee %}
document.getElementById('generateEmployeeIdBtn').addEventListener('click', function() {
    const btn = this;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generating...';
    
    fetch('/employees/generate-id')
        .then(response => response.json())
        .then(data => {
            btn.disabled = false;
            btn.innerHTML = originalText;
            
            if (data.success && data.employee_id) {
                document.getElementById('employee_id').value = data.employee_id;
                
                // Show success feedback
                const inputGroup = document.getElementById('employee_id').parentElement;
                const feedback = document.createElement('div');
                feedback.className = 'valid-feedback d-block';
                feedback.innerHTML = '<i class="fas fa-check-circle me-1"></i>Employee ID generated successfully!';
                inputGroup.appendChild(feedback);
                
                setTimeout(() => {
                    feedback.remove();
                }, 3000);
            } else {
                alert('Error: ' + (data.message || 'Failed to generate Employee ID'));
            }
        })
        .catch(error => {
            btn.disabled = false;
            btn.innerHTML = originalText;
            alert('Network error: Failed to generate Employee ID');
        });
});
{% endif %}
</script>
{% endblock %}
