{% extends "base.html" %}

{% block title %}Employee List - Nexar{% endblock %}

{% block head %}
<style>
    /* Modern Dashboard Styling */
    :root {
        --primary-color: #0d9488;
        --primary-light: #ccfbf1;
        --primary-hover: #0f766e;
        --text-main: #0f172a;
        --text-secondary: #64748b;
        --radius-md: 0.375rem;
    }

    /* Header Typography */
    .page-title {
        font-weight: 800;
        color: var(--text-main);
        font-size: 1.75rem;
        letter-spacing: -0.02em;
    }

    .page-subtitle {
        color: var(--text-secondary);
        font-size: 0.95rem;
    }

    /* Modern Buttons */
    .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        font-weight: 600;
    }

    .btn-primary:hover {
        background-color: var(--primary-hover);
        border-color: var(--primary-hover);
    }

    /* Ensure shadow utilities work if not in base */
    .shadow-sm {
        box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05) !important;
    }
</style>
{% endblock %}

{% block content %}


<div class="container-fluid">
    <!-- Header with search and actions -->
    <div class="row mb-1">
        <div class="col-12">
            <!-- Modern Header Section -->
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 page-header">
                <div class="mb-3 mb-md-0">
                    <h4 class="page-title mb-1">Employees</h4>
                    <p class="page-subtitle mb-0">View and manage company workforce and records</p>
                </div>
                {% if (current_user.role.name if current_user.role else None) in ['Tenant Admin', 'Super Admin',
                'Admin', 'HR Manager', 'HR_MANAGER', 'ADMIN', 'SUPER_ADMIN'] %}
                <div class="d-flex gap-2">
                    <a href="{{ url_for('export_employees') }}" class="btn btn-light border text-secondary shadow-sm">
                        <i class="fas fa-download me-1"></i>Export
                    </a>
                    <a href="{{ url_for('employee_add') }}" class="btn btn-primary shadow-sm">
                        <i class="fas fa-plus me-1"></i>Add Employee
                    </a>
                </div>
                {% endif %}
            </div>

            <!-- Toolbar: Search and Filter Button -->
            <div class="row align-items-center mb-3">
                <div class="col-md-6">
                    <form method="GET" class="d-flex">
                        <!-- Preserve other GET params if needed -->
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0">
                                <i class="fas fa-search text-muted"></i>
                            </span>
                            <input type="text" name="search" class="form-control border-start-0 ps-0"
                                placeholder="Search employees..." value="{{ search }}">
                            <button type="submit" class="btn btn-outline-secondary">Search</button>
                        </div>
                    </form>
                </div>
                <div class="col-md-6 text-md-end mt-2 mt-md-0">
                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal"
                        data-bs-target="#filterModal">
                        <i class="fas fa-filter me-1"></i>Filter
                        {% if current_filters.status != 'active' or current_filters.department or
                        current_filters.designation_id or current_filters.employment_type or current_filters.company_id
                        %}
                        <span class="badge bg-primary ms-1">!</span>
                        {% endif %}
                    </button>
                    {% if (current_user.role.name if current_user.role else None) in ['Tenant Admin', 'Super Admin',
                    'Admin', 'HR Manager', 'HR_MANAGER', 'ADMIN', 'SUPER_ADMIN'] %}
                    <a href="{{ url_for('employee_list') }}" class="btn btn-outline-secondary ms-1"
                        title="Clear Filters">
                        <i class="fas fa-undo"></i>
                    </a>
                    {% endif %}
                </div>
            </div>

            <!-- Filter Modal -->
            <div class="modal fade" id="filterModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form method="GET" action="{{ url_for('employee_list') }}">
                            <div class="modal-header">
                                <h5 class="modal-title"><i class="fas fa-filter me-2"></i>Filter Employees</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <!-- Preserve Search -->
                                <input type="hidden" name="search" value="{{ search }}">

                                <!-- Status Filter -->
                                <div class="mb-3">
                                    <label class="form-label">Status</label>
                                    <select name="status" class="form-select">
                                        {% for option in filter_options.status_options %}
                                        <option value="{{ option.value }}" {% if current_filters.status==option.value
                                            %}selected{% endif %}>
                                            {{ option.label }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <!-- Company Filter (for Admins) -->
                                {% if filter_options.companies %}
                                <div class="mb-3">
                                    <label class="form-label">Company</label>
                                    <select name="company_id" class="form-select">
                                        <option value="">All Companies</option>
                                        {% for comp in filter_options.companies %}
                                        <option value="{{ comp.id }}" {% if current_filters.company_id==comp.id|string
                                            %}selected{% endif %}>
                                            {{ comp.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                {% endif %}

                                <!-- Department Filter -->
                                <div class="mb-3">
                                    <label class="form-label">Department</label>
                                    <select name="department" class="form-select">
                                        <option value="">All Departments</option>
                                        {% for dept in filter_options.departments %}
                                        <option value="{{ dept }}" {% if current_filters.department==dept %}selected{%
                                            endif %}>
                                            {{ dept }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <!-- Designation Filter -->
                                <div class="mb-3">
                                    <label class="form-label">Designation</label>
                                    <select name="designation_id" class="form-select">
                                        <option value="">All Designations</option>
                                        {% for desig in filter_options.designations %}
                                        <option value="{{ desig.id }}" {% if current_filters.designation_id==desig.id
                                            %}selected{% endif %}>
                                            {{ desig.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <!-- Employment Type Filter -->
                                <div class="mb-3">
                                    <label class="form-label">Employment Type</label>
                                    <select name="employment_type" class="form-select">
                                        <option value="">All Types</option>
                                        {% for type in filter_options.employment_types %}
                                        <option value="{{ type }}" {% if current_filters.employment_type==type
                                            %}selected{% endif %}>
                                            {{ type }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>

                            </div>
                            <div class="modal-footer">
                                <a href="{{ url_for('employee_list') }}" class="btn btn-outline-secondary">Reset</a>
                                <button type="submit" class="btn btn-primary">Apply Filters</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Employee cards for mobile, table for desktop -->
    <div class="d-md-none">
        <!-- Mobile cards -->
        {% for employee in employees.items %}
        <div class="card mb-2">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">
                            <a href="{{ url_for('employee_view', employee_id=employee.id) }}"
                                class="text-decoration-none">
                                {{ employee.first_name }} {{ employee.last_name }}
                            </a>
                        </h6>
                        <p class="text-muted small mb-1">{{ employee.employee_id }}</p>
                        {% if (current_user.role.name if current_user.role else None) == 'Super Admin' %}
                        <p class="mb-1">
                            <small><strong>Tenant:</strong> {{ employee.tenant_name }}</small><br>
                            <small><strong>Company:</strong> {{ employee.company_name }}</small>
                        </p>
                        {% endif %}
                        {% if (current_user.role.name if current_user.role else None) in ['Tenant Admin', 'HR Manager']
                        %}
                        <p class="mb-1">
                            <small><strong>Company:</strong> {{ employee.company_name }}</small>
                        </p>
                        {% endif %}
                        <p class="mb-1">{{ employee.designation.name if employee.designation else '-' }}</p>
                        {% if employee.department %}
                        <span class="text-muted">{{ employee.department }}</span>
                        {% endif %}
                        <span class="text-muted">{{ employee.employment_type }}</span>
                    </div>
                    <div class="text-end">
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item"
                                        href="{{ url_for('employee_view', employee_id=employee.id) }}">
                                        <i class="fas fa-eye me-1"></i>View Details
                                    </a></li>
                                {% if (current_user.role.name) in ['Tenant Admin', 'Super Admin','HR Manager',
                                'HR_MANAGER', 'ADMIN', 'SUPER_ADMIN'] %}
                                <li><a class="dropdown-item"
                                        href="{{ url_for('employee_edit', employee_id=employee.id) }}">
                                        <i class="fas fa-edit me-1"></i>Edit
                                    </a></li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="mt-2">
                    <small class="text-muted">
                        <i class="fas fa-envelope me-1"></i>{{ employee.email }}
                    </small>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Desktop table -->
    <div class="d-none d-md-block">
        <div class="table-responsive">
            <table class="table table-compact table-hover mb-0">
                <thead>
                    <tr>
                        <th>
                            <a
                                href="?sort_by=employee_id&sort_order={{ 'desc' if sort_by == 'employee_id' and sort_order == 'asc' else 'asc' }}&search={{ search }}&department={{ current_filters.department }}&status={{ current_filters.status }}&designation_id={{ current_filters.designation_id }}&employment_type={{ current_filters.employment_type }}&company_id={{ current_filters.company_id }}&per_page={{ per_page }}">
                                Employee ID
                                {% if sort_by == 'employee_id' %}
                                <i class="fas fa-sort-{{ 'down' if sort_order == 'desc' else 'up' }}"></i>
                                {% else %}
                                <i class="fas fa-sort"></i>
                                {% endif %}
                            </a>
                        </th>
                        <th>
                            <a
                                href="?sort_by=first_name&sort_order={{ 'desc' if sort_by == 'first_name' and sort_order == 'asc' else 'asc' }}&search={{ search }}&department={{ current_filters.department }}&status={{ current_filters.status }}&designation_id={{ current_filters.designation_id }}&employment_type={{ current_filters.employment_type }}&company_id={{ current_filters.company_id }}&per_page={{ per_page }}">
                                Name
                                {% if sort_by == 'first_name' %}
                                <i class="fas fa-sort-{{ 'down' if sort_order == 'desc' else 'up' }}"></i>
                                {% else %}
                                <i class="fas fa-sort"></i>
                                {% endif %}
                            </a>
                        </th>
                        {% if (current_user.role.name if current_user.role else None) == 'Super Admin' %}
                        <th>
                            <a
                                href="?sort_by=tenant_name&sort_order={{ 'desc' if sort_by == 'tenant_name' and sort_order == 'asc' else 'asc' }}&search={{ search }}&department={{ current_filters.department }}&status={{ current_filters.status }}&designation_id={{ current_filters.designation_id }}&employment_type={{ current_filters.employment_type }}&company_id={{ current_filters.company_id }}&per_page={{ per_page }}">
                                Tenant Name
                                {% if sort_by == 'tenant_name' %}
                                <i class="fas fa-sort-{{ 'down' if sort_order == 'desc' else 'up' }}"></i>
                                {% else %}
                                <i class="fas fa-sort"></i>
                                {% endif %}
                            </a>
                        </th>
                        {% endif %}
                        {% if (current_user.role.name if current_user.role else None) in ['Super Admin', 'Tenant
                        Admin', 'HR Manager'] %}
                        <th>
                            <a
                                href="?sort_by=company_name&sort_order={{ 'desc' if sort_by == 'company_name' and sort_order == 'asc' else 'asc' }}&search={{ search }}&department={{ current_filters.department }}&status={{ current_filters.status }}&designation_id={{ current_filters.designation_id }}&employment_type={{ current_filters.employment_type }}&company_id={{ current_filters.company_id }}&per_page={{ per_page }}">
                                Company Name
                                {% if sort_by == 'company_name' %}
                                <i class="fas fa-sort-{{ 'down' if sort_order == 'desc' else 'up' }}"></i>
                                {% else %}
                                <i class="fas fa-sort"></i>
                                {% endif %}
                            </a>
                        </th>
                        {% endif %}
                        <th>
                            <a
                                href="?sort_by=designation&sort_order={{ 'desc' if sort_by == 'designation' and sort_order == 'asc' else 'asc' }}&search={{ search }}&department={{ current_filters.department }}&status={{ current_filters.status }}&designation_id={{ current_filters.designation_id }}&employment_type={{ current_filters.employment_type }}&company_id={{ current_filters.company_id }}&per_page={{ per_page }}">
                                Designation
                                {% if sort_by == 'designation' %}
                                <i class="fas fa-sort-{{ 'down' if sort_order == 'desc' else 'up' }}"></i>
                                {% else %}
                                <i class="fas fa-sort"></i>
                                {% endif %}
                            </a>
                        </th>
                        <th>
                            <a
                                href="?sort_by=department&sort_order={{ 'desc' if sort_by == 'department' and sort_order == 'asc' else 'asc' }}&search={{ search }}&department={{ current_filters.department }}&status={{ current_filters.status }}&designation_id={{ current_filters.designation_id }}&employment_type={{ current_filters.employment_type }}&company_id={{ current_filters.company_id }}&per_page={{ per_page }}">
                                Department
                                {% if sort_by == 'department' %}
                                <i class="fas fa-sort-{{ 'down' if sort_order == 'desc' else 'up' }}"></i>
                                {% else %}
                                <i class="fas fa-sort"></i>
                                {% endif %}
                            </a>
                        </th>
                        <th>
                            <a
                                href="?sort_by=email&sort_order={{ 'desc' if sort_by == 'email' and sort_order == 'asc' else 'asc' }}&search={{ search }}&department={{ current_filters.department }}&status={{ current_filters.status }}&designation_id={{ current_filters.designation_id }}&employment_type={{ current_filters.employment_type }}&company_id={{ current_filters.company_id }}&per_page={{ per_page }}">
                                Email
                                {% if sort_by == 'email' %}
                                <i class="fas fa-sort-{{ 'down' if sort_order == 'desc' else 'up' }}"></i>
                                {% else %}
                                <i class="fas fa-sort"></i>
                                {% endif %}
                            </a>
                        </th>
                        <th>
                            <a
                                href="?sort_by=employment_type&sort_order={{ 'desc' if sort_by == 'employment_type' and sort_order == 'asc' else 'asc' }}&search={{ search }}&department={{ current_filters.department }}&status={{ current_filters.status }}&designation_id={{ current_filters.designation_id }}&employment_type={{ current_filters.employment_type }}&company_id={{ current_filters.company_id }}&per_page={{ per_page }}">
                                Type
                                {% if sort_by == 'employment_type' %}
                                <i class="fas fa-sort-{{ 'down' if sort_order == 'desc' else 'up' }}"></i>
                                {% else %}
                                <i class="fas fa-sort"></i>
                                {% endif %}
                            </a>
                        </th>
                        <th>
                            <span>
                                Actions
                                <i class="fas fa-sort"></i>
                            </span>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for employee in employees.items %}
                    <tr>
                        <td>{{ employee.employee_id }}</td>
                        <td>
                            <a href="{{ url_for('employee_view', employee_id=employee.id) }}"
                                class="text-decoration-none">
                                {{ employee.first_name }} {{ employee.last_name }}
                            </a>
                        </td>
                        {% if (current_user.role.name if current_user.role else None) == 'Super Admin' %}
                        <td>{{ employee.tenant_name }}</td>
                        {% endif %}
                        {% if (current_user.role.name if current_user.role else None) in ['Super Admin', 'Tenant
                        Admin', 'HR Manager'] %}
                        <td>{{ employee.company_name }}</td>
                        {% endif %}
                        <td>{{ employee.designation.name if employee.designation else '-' }}</td>
                        <td>
                            {% if employee.department %}
                            {{ employee.department }}
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>{{ employee.email }}</td>
                        <td>
                            {{ employee.employment_type }}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a href="{{ url_for('employee_view', employee_id=employee.id) }}"
                                    class="btn btn-outline-primary" title="View">
                                    <i class="fas fa-eye"></i>
                                </a>
                                {% if (current_user.role.name if current_user.role else None) in ['Tenant Admin',
                                'Super Admin', 'HR Manager', 'HR_MANAGER', 'ADMIN', 'SUPER_ADMIN'] %}
                                <a href="{{ url_for('employee_edit', employee_id=employee.id) }}"
                                    class="btn btn-outline-secondary" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button
                                    onclick="resetPassword({{ employee.id }}, '{{ employee.first_name }} {{ employee.last_name }}')"
                                    class="btn btn-outline-warning" title="Reset Password">
                                    <i class="fas fa-key"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {% if not employees.items %}
    <div class="text-center py-5">
        <i class="fas fa-users fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">No employees found</h5>
        <p class="text-muted">Try adjusting your search criteria</p>
        {% if (current_user.role.name if current_user.role else None) in ['Tenant Admin', 'Super Admin', 'Admin', 'HR
        Manager', 'HR_MANAGER', 'ADMIN', 'SUPER_ADMIN'] %}
        <a href="{{ url_for('employee_add') }}" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i>Add First Employee
        </a>
        {% endif %}
    </div>
    {% endif %}

    <!-- Enhanced Pagination Section -->
    <div class="pagination-section">
        <!-- Left: Record count info -->
        <div class="pagination-info">
            Showing {{ ((employees.page - 1) * per_page) + 1 }} to {{ ((employees.page - 1) * per_page) +
            employees.items|length }} of {{ employees.total }} records
        </div>

        <!-- Center: Page navigation -->
        <div class="pagination-controls">
            <nav aria-label="Employee pagination">
                <ul class="pagination">
                    {% if employees.has_prev %}
                    <li class="page-item">
                        <a class="page-link"
                            href="{{ url_for('employee_list', page=employees.prev_num, search=search, department=current_filters.department, status=current_filters.status, designation_id=current_filters.designation_id, employment_type=current_filters.employment_type, company_id=current_filters.company_id, sort_by=sort_by, sort_order=sort_order, per_page=per_page) }}">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                    {% endif %}

                    {% for page_num in employees.iter_pages() %}
                    {% if page_num %}
                    {% if page_num != employees.page %}
                    <li class="page-item">
                        <a class="page-link"
                            href="{{ url_for('employee_list', page=page_num, search=search, department=current_filters.department, status=current_filters.status, designation_id=current_filters.designation_id, employment_type=current_filters.employment_type, company_id=current_filters.company_id, sort_by=sort_by, sort_order=sort_order, per_page=per_page) }}">
                            {{ page_num }}
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item active">
                        <span class="page-link">{{ page_num }}</span>
                    </li>
                    {% endif %}
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                    {% endif %}
                    {% endfor %}

                    {% if employees.has_next %}
                    <li class="page-item">
                        <a class="page-link"
                            href="{{ url_for('employee_list', page=employees.next_num, search=search, department=current_filters.department, status=current_filters.status, designation_id=current_filters.designation_id, employment_type=current_filters.employment_type, company_id=current_filters.company_id, sort_by=sort_by, sort_order=sort_order, per_page=per_page) }}">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>

        <!-- Right: Records-per-page selector -->
        <div class="records-per-page">
            <label for="per_page_select">Per page:</label>
            <select id="per_page_select" class="form-select" onchange="changeRecordsPerPage(this.value)">
                <option value="15" {% if per_page==15 %}selected{% endif %}>15</option>
                <option value="25" {% if per_page==25 %}selected{% endif %}>25</option>
                <option value="50" {% if per_page==50 %}selected{% endif %}>50</option>
                <option value="100" {% if per_page==100 %}selected{% endif %}>100</option>
            </select>
        </div>
    </div>
</div>

<!-- Password Reset Confirmation Modal -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1" aria-labelledby="resetPasswordModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resetPasswordModalLabel">
                    <i class="fas fa-key text-warning me-2"></i>Reset Password
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to reset the password for:</p>
                <p class="fw-bold text-primary" id="employeeNameDisplay"></p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    A temporary password will be generated and the employee will be required to change it on next login.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="confirmResetBtn">
                    <i class="fas fa-key me-1"></i>Reset Password
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentEmployeeId = null;
    let currentEmployeeName = null;

    function resetPassword(employeeId, employeeName) {
        currentEmployeeId = employeeId;
        currentEmployeeName = employeeName;

        document.getElementById('employeeNameDisplay').textContent = employeeName;

        const modal = new bootstrap.Modal(document.getElementById('resetPasswordModal'));
        modal.show();
    }

    document.getElementById('confirmResetBtn').addEventListener('click', function () {
        if (!currentEmployeeId) return;

        const btn = this;
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Resetting...';

        fetch(`/employees/${currentEmployeeId}/reset-password`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
            .then(response => response.json())
            .then(data => {
                btn.disabled = false;
                btn.innerHTML = originalText;

                const modal = bootstrap.Modal.getInstance(document.getElementById('resetPasswordModal'));
                modal.hide();

                if (data.success) {
                    // Show success message
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
                    alertDiv.style.zIndex = '9999';
                    alertDiv.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                <strong>Password Reset Successful!</strong><br>
                Temporary Password: <strong>${data.temp_password}</strong>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
                    document.body.appendChild(alertDiv);

                    setTimeout(() => {
                        alertDiv.remove();
                    }, 10000);
                } else {
                    // Show error message
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
                    alertDiv.style.zIndex = '9999';
                    alertDiv.innerHTML = `
                <i class="fas fa-exclamation-circle me-2"></i>
                <strong>Error:</strong> ${data.message || 'Failed to reset password'}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
                    document.body.appendChild(alertDiv);

                    setTimeout(() => {
                        alertDiv.remove();
                    }, 5000);
                }
            })
            .catch(error => {
                btn.disabled = false;
                btn.innerHTML = originalText;

                const modal = bootstrap.Modal.getInstance(document.getElementById('resetPasswordModal'));
                modal.hide();

                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
                alertDiv.style.zIndex = '9999';
                alertDiv.innerHTML = `
            <i class="fas fa-exclamation-circle me-2"></i>
            <strong>Error:</strong> Network error occurred
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
                document.body.appendChild(alertDiv);

                setTimeout(() => {
                    alertDiv.remove();
                }, 5000);
            });
    });

    function changeRecordsPerPage(perPage) {
        // Construct URL with per_page parameter and reset to page 1
        const url = new URL(window.location.href);
        url.searchParams.set('per_page', perPage);
        url.searchParams.set('page', 1);  // Reset to first page
        window.location.href = url.toString();
    }
</script>
{% endblock %}