<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>{% block title %}Nexar{% endblock %}</title>

    <!-- Bootstrap CSS -->
    <link href="{{ url_for('static', filename='vendors/bootstrap/css/bootstrap.min.css') }}" rel="stylesheet">

    <!-- Font Awesome Icons -->
    <link href="{{ url_for('static', filename='vendors/fontawesome/css/all.min.css') }}" rel="stylesheet">

    <!-- Roboto & Inter fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Inter:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Main CSS - includes responsive design -->
    <link href="{{ url_for('static', filename='css/styles.css') }}?v=20250924-navbar-fix-v2" rel="stylesheet">

    <!-- PWA Manifest -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/nexar_icon.png') }}">

    {% block head %}{% endblock %}
</head>

<body>
    <div class="page-wrapper">
        <!-- Professional Corporate Header -->
        <nav class="navbar navbar-expand-lg">
            <div class="container-fluid">
                <!-- Brand Logo Circle -->
                <div class="navbar-brand-wrapper">
                    <button class="navbar-toggler me-3 d-lg-none" type="button" id="sidebarToggle"
                        aria-label="Toggle sidebar">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <a class="navbar-brand p-0 m-0 d-flex align-items-center gap-2"
                        href="{{ url_for('dashboard') if current_user.is_authenticated else url_for('index') }}">
                        <div class="logo-circle">
                            <img src="{{ url_for('static', filename='img/nexar_icon.png') }}" alt="Nexar Mark">
                        </div>
                        <span class="fs-4 fw-bold text-white tracking-wide">Nexar</span>
                    </a>
                </div>

                {% if current_user.is_authenticated %}

                <!-- No central nav menu here anymore -->

                <div class="d-flex ms-auto">
                    <!-- Profile Dropdown (Gmail Style) -->
                    <ul class="navbar-nav">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle profile-trigger" href="#" role="button"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                <span class="profile-image-container avatar-circle">
                                    {% if hasattr(current_user, 'employee_profile') and current_user.employee_profile
                                    and current_user.employee_profile.profile_image_path %}
                                    <img src="{{ url_for('static', filename=current_user.employee_profile.profile_image_path) }}"
                                        alt="Profile" class="avatar-image">
                                    {% else %}
                                    <div class="avatar-placeholder">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    {% endif %}
                                </span>
                            </a>

                            <div class="dropdown-menu dropdown-menu-end profile-card-dropdown">
                                <!-- Profile Card Header -->
                                <div class="profile-card-header text-center">
                                    <div class="profile-card-avatar mb-2">
                                        {% if hasattr(current_user, 'employee_profile') and
                                        current_user.employee_profile and
                                        current_user.employee_profile.profile_image_path %}
                                        <img src="{{ url_for('static', filename=current_user.employee_profile.profile_image_path) }}"
                                            alt="Profile" class="avatar-lg rounded-circle">
                                        {% else %}
                                        <div class="avatar-placeholder avatar-lg rounded-circle mx-auto d-flex align-items-center justify-content-center"
                                            style="font-size: 1.5rem; width: 64px; height: 64px;">
                                            {{ current_user.first_name[0] if current_user.first_name else 'U' }}
                                        </div>
                                        {% endif %}
                                    </div>
                                    <h6 class="profile-card-name mb-0 fw-bold">{{ current_user.first_name }} {{
                                        current_user.last_name or '' }}</h6>
                                    <small class="profile-card-email text-muted">{{ current_user.email }}</small>
                                    {% if current_user.role %}
                                    <div class="mt-1"><span class="badge bg-secondary rounded-pill">{{
                                            current_user.role.name }}</span></div>
                                    {% endif %}
                                </div>

                                <!-- Profile Card Body -->
                                <div class="profile-card-body my-3 text-center">
                                    {% if hasattr(current_user, 'employee_profile') and current_user.employee_profile %}
                                    <a class="btn btn-outline-primary rounded-pill px-4"
                                        href="{{ url_for('profile') }}">Manage your Profile</a>
                                    {% endif %}
                                </div>

                                <!-- Profile Card Footer -->
                                <div class="profile-card-footer border-top pt-2 text-center">
                                    <a class="btn btn-light btn-sm text-secondary" href="{{ url_for('logout') }}">
                                        <i class="fas fa-sign-out-alt me-1"></i> Sign Out
                                    </a>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
                {% endif %}
            </div>
        </nav>

        {% if current_user.is_authenticated %}
        <!-- Sidebar Navigation -->
        <aside class="sidebar d-flex flex-column" id="mainSidebar">
            <div class="sidebar-nav flex-grow-1 overflow-auto custom-scrollbar" id="sidebarAccordion">
                {% set user_role = current_user.role.name if current_user.role else None %}
                {% set is_manager = user_role == 'Manager' %}
                {% set is_user = user_role == 'User' %}
                {# Check if employee has manager flag enabled #}
                {% set is_reporting_manager = hasattr(current_user, 'employee_profile') and
                current_user.employee_profile and current_user.employee_profile.is_manager %}

                <!-- Dashboard - Visible to all -->
                <a class="sidebar-link {{ 'active' if request.endpoint == 'dashboard' }}"
                    href="{{ url_for('dashboard') }}">
                    <i class="fas fa-home"></i>
                    Dashboard
                </a>

                <!-- HR Manager Dashboard - Visible only to Tenant Admin -->
                {% if user_role == 'Tenant Admin' %}
                <a class="sidebar-link {{ 'active' if request.endpoint == 'hr_manager_dashboard' }}"
                    href="{{ url_for('hr_manager_dashboard') }}">
                    <i class="fas fa-chart-line"></i>
                    HR Dashboard
                </a>
                {% endif %}

                <!-- Super Admin / Tenant Admin Menu (Masters) -->
                {% if check_ui_access(user_role, 'Admin Settings', 'Master Data') != 'Hidden' %}
                <a class="sidebar-link" data-bs-toggle="collapse" href="#submenuMasters" role="button"
                    aria-expanded="false" aria-controls="submenuMasters">
                    <span><i class="fas fa-cogs"></i> Masters</span>
                </a>
                <ul class="collapse sidebar-submenu" id="submenuMasters" data-bs-parent="#sidebarAccordion">
                    <li><a class="nav-link" href="{{ url_for('tenant_list') }}">Tenants</a></li>
                    <li><a class="nav-link" href="{{ url_for('company_list') }}">Companies</a></li>
                    <li><a class="nav-link" href="{{ url_for('employee_list') }}">All Employees</a></li>
                    <li><a class="nav-link" href="{{ url_for('tenant_payment_config_list') }}">Payment Config</a></li>
                    <li><a class="nav-link" href="{{ url_for('role_list') }}">Roles</a></li>
                    <li><a class="nav-link" href="{{ url_for('department_list') }}">Departments</a></li>
                    <li><a class="nav-link" href="{{ url_for('working_hours_list') }}">Working Hours</a></li>
                    <li><a class="nav-link" href="{{ url_for('work_schedule_list') }}">Work Schedules</a></li>
                    <li><a class="nav-link" href="{{ url_for('ot_type_list') }}">OT Types</a></li>
                </ul>
                {% endif %}

                <!-- Regular Admin/Manager/User Menus -->


                <!-- My Team -->
                {% if is_manager or is_user %}
                <a class="sidebar-link {{ 'active' if request.endpoint == 'team_list' }}"
                    href="{{ url_for('team_list') }}">
                    <i class="fas fa-users"></i>
                    My Team
                </a>
                {% endif %}

                <!-- Documents -->
                {% if is_user %}
                <a class="sidebar-link {{ 'active' if request.endpoint == 'documents_list' }}"
                    href="{{ url_for('documents_list') }}">
                    <i class="fas fa-file-alt"></i>
                    Documents
                </a>
                {% endif %}

                <!-- Employees -->
                {% if check_ui_access(user_role, 'Employees', 'Employee Management') != 'Hidden' %}
                <a class="sidebar-link" data-bs-toggle="collapse" href="#submenuEmployees" role="button"
                    aria-expanded="false" aria-controls="submenuEmployees">
                    <span><i class="fas fa-users"></i> Employees</span>
                </a>
                <ul class="collapse sidebar-submenu" id="submenuEmployees" data-bs-parent="#sidebarAccordion">
                    <li><a class="nav-link" href="{{ url_for('employee_add') }}">Add Employee</a></li>
                    <li><a class="nav-link" href="{{ url_for('employee_list') }}">All Employees</a></li>
                    <li><a class="nav-link" href="{{ url_for('employee_bulk_upload') }}">Bulk Upload</a></li>
                </ul>
                {% endif %}

                <!-- Attendance -->
                <a class="sidebar-link" data-bs-toggle="collapse" href="#submenuAttendance" role="button"
                    aria-expanded="false" aria-controls="submenuAttendance">
                    <span><i class="fas fa-calendar-check"></i> Attendance</span>
                </a>
                <ul class="collapse sidebar-submenu" id="submenuAttendance" data-bs-parent="#sidebarAccordion">
                    <li><a class="nav-link" href="{{ url_for('attendance_mark') }}">Mark Attendance</a></li>
                    <li><a class="nav-link" href="{{ url_for('attendance_list_view') }}">View Records</a></li>
                    {% if not is_super_admin %}
                    <li><a class="nav-link" href="{{ url_for('mark_ot_attendance') }}">Mark OT Attendance</a></li>
                    {% endif %}
                    {% if check_ui_access(user_role, 'Attendance', 'Attendance Management', 'Bulk Upload') != 'Hidden'
                    %}
                    <li><a class="nav-link" href="{{ url_for('attendance_bulk_manage') }}">Bulk Attendance</a></li>
                    {% endif %}
                </ul>

                <!-- Leave (User/Manager) -->
                {% if check_ui_access(user_role, 'Attendance', 'Leave Management', 'Apply Leave') != 'Hidden' %}
                <a class="sidebar-link" data-bs-toggle="collapse" href="#submenuLeave" role="button"
                    aria-expanded="false" aria-controls="submenuLeave">
                    <span><i class="fas fa-plane-departure"></i> Leave</span>
                </a>
                <ul class="collapse sidebar-submenu" id="submenuLeave" data-bs-parent="#sidebarAccordion">
                    <li><a class="nav-link" href="{{ url_for('leave_request') }}">Request Leave</a></li>
                    <li><a class="nav-link" href="{{ url_for('leave_list') }}">View Requests</a></li>
                </ul>
                {% endif %}

                <!-- Leave Management (Admin) -->
                {% if check_ui_access(user_role, 'Attendance', 'Leave Management', 'Leave Approval') != 'Hidden' %}
                <a class="sidebar-link" data-bs-toggle="collapse" href="#submenuLeaveMgmt" role="button"
                    aria-expanded="false" aria-controls="submenuLeaveMgmt">
                    <span><i class="fas fa-plane-departure"></i> Leave Management</span>
                </a>
                <ul class="collapse sidebar-submenu" id="submenuLeaveMgmt" data-bs-parent="#sidebarAccordion">
                    <li><a class="nav-link" href="{{ url_for('leave_configuration') }}">Configure Leave Types</a></li>
                </ul>
                {% endif %}

                <!-- OT Management -->
                {% if is_admin or is_reporting_manager %}
                <a class="sidebar-link" data-bs-toggle="collapse" href="#submenuOT" role="button" aria-expanded="false"
                    aria-controls="submenuOT">
                    <span><i class="fas fa-clock"></i> OT Management</span>
                </a>
                <ul class="collapse sidebar-submenu" id="submenuOT" data-bs-parent="#sidebarAccordion">
                    {% if is_admin %}
                    <li><a class="nav-link" href="{{ url_for('ot_attendance') }}">OT Attendance</a></li>
                    {% endif %}
                    <li><a class="nav-link"
                            href="{% if is_admin %}{{ url_for('ot_approval') }}{% else %}{{ url_for('ot_manager_approval') }}{% endif %}">OT
                            Approvals</a></li>
                    {% if is_admin %}
                    <li><a class="nav-link" href="{{ url_for('ot_payroll_summary') }}">Payroll Summary</a></li>
                    {% endif %}
                </ul>
                {% endif %}

                <!-- Payroll -->
                {% if check_ui_access(user_role, 'Payroll') != 'Hidden' %}
                <a class="sidebar-link" data-bs-toggle="collapse" href="#submenuPayroll" role="button"
                    aria-expanded="false" aria-controls="submenuPayroll">
                    <span><i class="fas fa-dollar-sign"></i> Payroll</span>
                </a>
                <ul class="collapse sidebar-submenu" id="submenuPayroll" data-bs-parent="#sidebarAccordion">
                    <li><a class="nav-link" href="{{ url_for('payroll_list') }}">Payroll List</a></li>
                    <li><a class="nav-link" href="{{ url_for('payroll_generate') }}">Generate Payroll</a></li>
                    <li><a class="nav-link" href="{{ url_for('payroll_config') }}">Payroll Configuration</a></li>
                </ul>
                {% endif %}

                <!-- Reports -->
                {% if check_ui_access(user_role, 'Payroll', 'Payroll Reports') != 'Hidden' or check_ui_access(user_role,
                'Employees', 'Employee Reports') != 'Hidden' %}
                <a class="sidebar-link" data-bs-toggle="collapse" href="#submenuReports" role="button"
                    aria-expanded="false" aria-controls="submenuReports">
                    <span><i class="fas fa-chart-bar"></i> Reports</span>
                </a>
                <ul class="collapse sidebar-submenu" id="submenuReports" data-bs-parent="#sidebarAccordion">
                    <li><a class="nav-link" href="{{ url_for('reports_menu') }}">All Reports</a></li>
                    <li><a class="nav-link" href="{{ url_for('report_employee_history') }}">Employee History</a></li>
                    <li><a class="nav-link" href="{{ url_for('report_payroll_configuration') }}">Payroll
                            Configuration</a></li>
                    <li><a class="nav-link" href="{{ url_for('report_attendance') }}">Attendance Report</a></li>
                </ul>
                {% endif %}

                <!-- Masters (Admin) -->
                {% if check_ui_access(user_role, 'Admin Settings', 'Master Data') != 'Hidden' %}
                <a class="sidebar-link" data-bs-toggle="collapse" href="#submenuMastersAdmin" role="button"
                    aria-expanded="false" aria-controls="submenuMastersAdmin">
                    <span><i class="fas fa-cogs"></i> Masters</span>
                </a>
                <ul class="collapse sidebar-submenu" id="submenuMastersAdmin">
                    <li><a class="nav-link" href="{{ url_for('tenant_list') }}">Tenants</a></li>
                    <li><a class="nav-link" href="{{ url_for('company_list') }}">Companies</a></li>
                    <li><a class="nav-link" href="{{ url_for('role_list') }}">Roles</a></li>
                    <li><a class="nav-link" href="{{ url_for('department_list') }}">Departments</a></li>
                    <li><a class="nav-link" href="{{ url_for('working_hours_list') }}">Working Hours</a></li>
                    <li><a class="nav-link" href="{{ url_for('work_schedule_list') }}">Work Schedules</a></li>
                    <li><a class="nav-link" href="{{ url_for('ot_type_list') }}">OT Types</a></li>
                    {% if check_ui_access(user_role, 'Admin Settings', 'User Role Mapping') != 'Hidden' %}
                    <li><a class="nav-link" href="{{ url_for('access_control.manage_user_companies') }}">Access
                            Control</a></li>
                    <li><a class="nav-link" href="{{ url_for('user_status_toggle') }}">User Status Toggle</a></li>
                    {% endif %}
                </ul>
                {% endif %}

                <!-- End of Regular Admin/Manager/User Menus -->
            </div>

            <!-- Sidebar Footer -->
            <div class="sidebar-footer mt-auto py-2 px-3 border-top border-secondary text-center"
                style="background: rgba(0,0,0,0.2);">
                <div class="d-flex flex-column gap-1">
                    <div class="fw-bold text-white text-truncate" style="font-size: 0.75rem;">
                        <i class="fas fa-building me-1 opacity-75"></i> {{ current_user.organization.name if
                        current_user.organization else 'Nexar Core' }}
                    </div>
                    <div class="text-white-50 text-truncate" style="font-size: 0.7rem;">
                        {{ current_user.employee_profile.designation.name if current_user.employee_profile and
                        current_user.employee_profile.designation else (current_user.role.name if current_user.role else
                        'User') }}
                    </div>
                </div>
            </div>
        </aside>
        {% endif %}

        <!-- Main content -->
        <main class="page-container">
            {% if request.endpoint != 'login' %}
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            <div class="container-fluid">
                {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show"
                    role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            {% endwith %}
            {% endif %}
            {% block content %}{% endblock %}
        </main>



        <!-- Mobile Floating Action Button -->
        {% if current_user.is_authenticated and (current_user.role.name if current_user.role else None) == 'User' %}
        <div class="dropdown dropup position-fixed" style="bottom: 1.5rem; right: 1.5rem; z-index: 1050;">
            <button class="fab" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-plus"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end mb-2">
                <li><a class="dropdown-item" href="{{ url_for('attendance_mark') }}">
                        <i class="fas fa-clock"></i>Mark Attendance
                    </a></li>
                <li><a class="dropdown-item" href="{{ url_for('leave_request') }}">
                        <i class="fas fa-plane-departure"></i>Request Leave
                    </a></li>
            </ul>
        </div>
        {% endif %}

        <!-- Global Loader -->
        <div id="global-loader" class="global-loader">
            <div class="loader-overlay"></div>
            <div class="loader-container">
                <div class="loader-spinner"></div>
                <p class="loader-text">Loading...</p>
            </div>
        </div>
    </div>
    <!-- Bootstrap JS -->
    <script src="{{ url_for('static', filename='vendors/bootstrap/js/bootstrap.bundle.min.js') }}"></script>

    <!-- Mobile dropdown fix -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Sidebar Toggle
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('mainSidebar');

            if (sidebarToggle && sidebar) {
                sidebarToggle.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    sidebar.classList.toggle('show');
                });

                // Close sidebar when clicking outside on mobile
                document.addEventListener('click', function (e) {
                    if (window.innerWidth <= 991 &&
                        sidebar.classList.contains('show') &&
                        !sidebar.contains(e.target) &&
                        !sidebarToggle.contains(e.target)) {
                        sidebar.classList.remove('show');
                    }
                });
            }

            // Mobile dropdown handler
            function handleMobileDropdowns() {
                const dropdownToggles = document.querySelectorAll('.sidebar-nav .sidebar-link[data-bs-toggle="collapse"]');
                // Bootstrap handles the collapse, we might just need to ensure correct icons
            }

            // Re-initialize on window resize
            window.addEventListener('resize', function () {
                if (window.innerWidth > 991 && sidebar) {
                    sidebar.classList.remove('show'); // Reset on desktop
                }
            });
        });
    </script>

    <!-- Global Loader Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const loader = document.getElementById('global-loader');

            if (!loader) return; // Exit if loader not found

            // Function to show loader
            function showLoader() {
                loader.classList.add('show');
            }

            // Function to hide loader
            function hideLoader() {
                loader.classList.remove('show');
            }

            // Improved loader hiding: Wait until browser is completely idle
            function waitForPageComplete() {
                if (document.readyState === 'complete') {
                    // Use Performance API to check if all resources are loaded
                    if (performance && performance.getEntriesByType) {
                        // Wait a bit more for any pending requests
                        setTimeout(hideLoader, 500);
                    } else {
                        hideLoader();
                    }
                } else {
                    // Check again soon
                    setTimeout(waitForPageComplete, 100);
                }
            }

            // Start checking when page is ready
            if (document.readyState === 'complete') {
                waitForPageComplete();
            } else {
                document.addEventListener('readystatechange', function () {
                    if (document.readyState === 'complete') {
                        waitForPageComplete();
                    }
                });
            }

            // Show loader on form submission
            document.querySelectorAll('form').forEach(form => {
                form.addEventListener('submit', function (e) {
                    // Validate form before showing loader
                    if (form.checkValidity() === false) {
                        e.preventDefault();
                        e.stopPropagation();
                    } else {
                        showLoader();
                    }
                });
            });

            // Show loader on button clicks (for AJAX or page navigation)
            // Common action buttons: Save, Submit, Update, Delete, Generate, etc.
            const actionButtons = document.querySelectorAll(
                'button[type="submit"], ' +
                'button[type="button"][onclick], ' +
                'a[href*="delete"], ' +
                'a[href*="update"], ' +
                'a[href*="generate"], ' +
                '.btn-primary, ' +
                '.btn-success, ' +
                '.action-btn'
            );

            actionButtons.forEach(button => {
                button.addEventListener('click', function (e) {
                    // Check if it's an anchor tag for page navigation
                    if (this.tagName === 'A' && this.href && !this.hasAttribute('onclick')) {
                        // Only show loader if it's not a hash link or external link
                        if (!this.href.includes('#') && !this.target === '_blank') {
                            showLoader();
                        }
                    }
                });
            });

            // Show loader on navigation with Ctrl+Click or Middle-click check
            document.addEventListener('click', function (e) {
                const link = e.target.closest('a');
                if (link && link.href && !link.href.includes('#') && !link.hasAttribute('onclick')) {
                    // Don't show loader if new tab/window is being opened or if data-no-loader is set
                    if (!e.ctrlKey && !e.metaKey && !e.shiftKey && link.target !== '_blank' && !link.hasAttribute('data-no-loader')) {
                        showLoader();
                    }
                }
            });

            // Hide loader if navigation is cancelled (back button, etc.)
            window.addEventListener('beforeunload', function () {
                // Keep loader visible during navigation
            });

            // Safety timeout: Hide loader after 60 seconds if still showing
            setTimeout(function () {
                if (loader.classList.contains('show')) {
                    hideLoader();
                }
            }, 60000);
        });
    </script>

    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>

    <!-- Form Validation Framework -->
    <script src="{{ url_for('static', filename='js/form-validation.js') }}"></script>

    {% block scripts %}{% endblock %}
</body>

</html>