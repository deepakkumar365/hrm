{% extends "base.html" %}

{% block title %}My Profile - Nexar{% endblock %}

{% block content %}
<div class="container-fluid profile-page-hr">
    <div class="row g-4 justify-content-center">
        <!-- Profile Sidebar -->
        <div class="col-xl-4 col-lg-5 col-md-6 col-sm-8">
            <div class="card profile-card shadow-sm mb-4">
                <div class="card-body text-center">
                    <div class="profile-image-frame mx-auto mb-3 position-relative">
                        <div class="profile-image-container">
                            {% if hasattr(current_user, 'employee_profile') and current_user.employee_profile and
                            current_user.employee_profile.profile_image_path %}
                            <img src="{{ url_for('static', filename=current_user.employee_profile.profile_image_path) }}"
                                alt="Profile photo of {{ current_user.first_name }} {{ current_user.last_name }}"
                                loading="lazy" class="avatar-image">
                            {% else %}
                            <div class="avatar-placeholder">
                                {{ current_user.first_name[0] if current_user.first_name else 'U' }}
                            </div>
                            {% endif %}
                        </div>
                        <button class="btn btn-sm btn-light profile-edit-photo" type="button"
                            title="Change Profile Photo" aria-label="Change Profile Photo"
                            onclick="document.getElementById('profileImageInput').click()">
                            <i class="fas fa-camera" aria-hidden="true"></i>
                        </button>
                        <form id="profileImageForm" method="POST" enctype="multipart/form-data">
                            <input type="file" id="profileImageInput" name="profile_image"
                                accept="image/jpeg,image/png,image/gif,image/webp"
                                aria-label="Select profile image file" onchange="this.form.submit()">
                        </form>
                    </div>
                    <h2 class="profile-name mb-1">{{ current_user.first_name }} {{ current_user.last_name }}</h2>
                    <div class="profile-position text-muted mb-2">{{ current_user.employee_profile.designation.name if
                        current_user.employee_profile and current_user.employee_profile.designation else '-' }}</div>
                    <div class="d-flex justify-content-center gap-2 mb-3 flex-wrap">
                        {% if current_user.department %}
                        <span class="badge profile-badge bg-primary">{{ current_user.department }}</span>
                        {% endif %}
                        {% if current_user.employment_type %}
                        <span class="badge profile-badge bg-secondary">{{ current_user.employment_type }}</span>
                        {% endif %}
                    </div>
                    <a href="{{ url_for('profile_edit') }}"
                        class="btn btn-outline-primary w-100 mb-2 d-flex align-items-center justify-content-center gap-2">
                        <i class="fas fa-edit" aria-hidden="true"></i>
                        <span>Edit Profile</span>
                    </a>
                </div>
            </div>
            <div class="card shadow-sm mb-4">
                <div class="card-header card-header-green">
                    <strong><i class="fas fa-chart-bar me-2"></i>Quick Stats</strong>
                </div>
                <div class="card-body p-3">
                    <div class="row text-center g-2">
                        <div class="col-6">
                            <div class="stat-value">{{ stats.attendance_rate if stats else '0' }}%</div>
                            <div class="stat-label">Attendance</div>
                        </div>
                        <div class="col-6">
                            <div class="stat-value">{{ stats.leave_balance if stats else '0' }}</div>
                            <div class="stat-label">Leave Balance</div>
                        </div>
                        <div class="col-6">
                            <div class="stat-value">{{ stats.pending_claims if stats else '0' }}</div>
                            <div class="stat-label">Pending Claims</div>
                        </div>
                        <div class="col-6">
                            <div class="stat-value">{{ stats.completed_tasks if stats else '0' }}</div>
                            <div class="stat-label">Tasks Done</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Profile Main Info -->
        <div class="col-xl-8 col-lg-7 col-md-12">
            <div class="row g-4">
                <div class="col-12">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header card-header-green">
                            <strong><i class="fas fa-id-card me-2"></i>Contact & Personal Info</strong>
                        </div>
                        <div class="card-body p-3">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="text-muted"><i class="fas fa-envelope me-2"></i>Email</label>
                                    <div>{{ current_user.email }}</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="text-muted"><i class="fas fa-phone me-2"></i>Phone</label>
                                    <div>{{ current_user.phone or 'Not set' }}</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="text-muted"><i class="fas fa-map-marker-alt me-2"></i>Address</label>
                                    <div>{{ current_user.address or 'Not set' }}</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="text-muted"><i class="fas fa-calendar me-2"></i>Joined Date</label>
                                    <div>{{ current_user.join_date.strftime('%d %B %Y') if current_user.join_date else
                                        'Not set' }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header card-header-green">
                            <strong><i class="fas fa-briefcase me-2"></i>Employment Details</strong>
                        </div>
                        <div class="card-body p-3">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="text-muted">Employee ID</label>
                                    <div><code>{{ current_user.employee_id }}</code></div>
                                </div>
                                <div class="col-md-6">
                                    <label class="text-muted">Designation</label>
                                    <div>{{ current_user.employee_profile.designation.name if
                                        current_user.employee_profile and current_user.employee_profile.designation else
                                        '-' }}</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="text-muted">Department</label>
                                    <div>{{ current_user.department or '-' }}</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="text-muted">Employment Type</label>
                                    <div>{{ current_user.employment_type or '-' }}</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="text-muted">Manager</label>
                                    <div>{{ current_user.manager_name or '-' }}</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="text-muted">Status</label>
                                    <div>{% if current_user.is_active %}<span class="badge bg-success">Active</span>{%
                                        else %}<span class="badge bg-danger">Inactive</span>{% endif %}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header card-header-green">
                            <strong><i class="fas fa-history me-2"></i>Recent Activity</strong>
                        </div>
                        <div class="card-body p-3">
                            <div class="timeline">
                                {% for activity in activities %}
                                <div class="timeline-item mb-4">
                                    <div class="d-flex">
                                        <div class="timeline-icon me-3">
                                            <span class="badge rounded-circle bg-{{ activity.color }} p-2">
                                                <i class="fas {{ activity.icon }}"></i>
                                            </span>
                                        </div>
                                        <div class="timeline-content">
                                            <div class="mb-0">{{ activity.message }}</div>
                                            <small class="text-muted">{{ activity.time }}</small>
                                        </div>
                                    </div>
                                </div>
                                {% else %}
                                <div class="text-center py-4">
                                    <i class="fas fa-stream fa-2x text-muted mb-2"></i>
                                    <p class="text-muted mb-0">No recent activity</p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div><script>
    // Profile image preview and validation
    document.addEventListener('DOMContentLoaded', function () {
        const profileImageInput = document.getElementById('profileImageInput');
        const profileImageContainer = document.querySelector('.profile-image-container');

        if (profileImageInput) {
            profileImageInput.addEventListener('change', function (e) {
                const file = this.files[0];

                if (!file) return;

                // Validate file size (max 5MB)
                const maxSize = 5 * 1024 * 1024; // 5MB
                if (file.size > maxSize) {
                    alert('File size must be less than 5MB');
                    this.value = '';
                    return;
                }

                // Validate file type
                const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                if (!allowedTypes.includes(file.type)) {
                    alert('Please select a valid image file (JPEG, PNG, GIF, or WebP)');
                    this.value = '';
                    return;
                }

                // Show loading state
                profileImageContainer.classList.add('loading');

                const reader = new FileReader();

                reader.onload = function (e) {
                    // Remove loading state
                    profileImageContainer.classList.remove('loading');

                    // Update preview
                    let preview = profileImageContainer.querySelector('img');
                    if (preview) {
                        preview.src = e.target.result;
                    } else {
                        // Create new img element if it doesn't exist
                        const defaultAvatar = profileImageContainer.querySelector('.bg-light');
                        if (defaultAvatar) {
                            defaultAvatar.remove();
                        }

                        preview = document.createElement('img');
                        preview.src = e.target.result;
                        preview.alt = 'Profile photo preview';
                        preview.loading = 'lazy';
                        profileImageContainer.appendChild(preview);
                    }
                };

                reader.onerror = function () {
                    // Remove loading state and show error
                    profileImageContainer.classList.remove('loading');
                    profileImageContainer.classList.add('error');
                    alert('Error reading file. Please try again.');
                    profileImageInput.value = '';

                    // Remove error state after 3 seconds
                    setTimeout(() => {
                        profileImageContainer.classList.remove('error');
                    }, 3000);
                };

                reader.readAsDataURL(file);
            });
        }

        // Handle form submission with loading state
        const profileImageForm = document.getElementById('profileImageForm');
        if (profileImageForm) {
            profileImageForm.addEventListener('submit', function () {
                const submitButton = document.querySelector('.profile-edit-photo');
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin" aria-hidden="true"></i>';
                }
            });
        }

        // Add keyboard navigation for profile edit button
        const editButton = document.querySelector('.profile-edit-photo');
        if (editButton) {
            editButton.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.click();
                }
            });
        }
    });
</script>
{% endblock %}