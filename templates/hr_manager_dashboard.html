{% extends "base.html" %}

{% block title %}HR Manager Dashboard - Nexar{% endblock %}

{% block content %}
<div class="container-fluid px-3 py-2">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h4 class="h4 mb-0">HR Manager Dashboard</h4>
            <p class="text-muted small mb-0">Real-time performance and operations overview</p>
        </div>
        <div class="d-flex gap-2 align-items-center">
            <div class="company-selector">
                <form method="GET" class="d-flex gap-2 align-items-center">
                    <select name="company_id" class="form-select form-select-sm w-auto" onchange="this.form.submit()">
                        {% for company in companies %}
                        <option value="{{ company.id }}" {% if company.id==selected_company.id %}selected{% endif %}>
                            {{ company.name }}
                        </option>
                        {% endfor %}
                    </select>
                </form>
            </div>
            <button class="btn btn-sm btn-outline-primary" onclick="refreshDashboard()">
                <i class="fas fa-sync-alt"></i>
                <span>Refresh</span>
            </button>
        </div>
    </div>

    <!-- Today's Summary Row (4-column grid) -->
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-3 mb-3">
        <!-- Present -->
        <div class="col">
            <div class="stat-card border border-1 p-3 h-100 text-center cursor-pointer"
                onclick="openAttendanceModal('Present', {{ today_summary.attendance.present }})">
                <div class="h2 fw-bold text-info mb-1">{{ today_summary.attendance.present }}</div>
                <div class="text-secondary small text-uppercase fw-bold">Present</div>
            </div>
        </div>

        <!-- Absent -->
        <div class="col">
            <div class="stat-card border border-1 p-3 h-100 text-center cursor-pointer"
                onclick="openAttendanceModal('Absent', {{ today_summary.attendance.absent }})">
                <div class="h2 fw-bold text-info mb-1">{{ today_summary.attendance.absent }}</div>
                <div class="text-secondary small text-uppercase fw-bold">Absent</div>
            </div>
        </div>

        <!-- Late -->
        <div class="col">
            <div class="stat-card border border-1 p-3 h-100 text-center cursor-pointer"
                onclick="openAttendanceModal('Late', {{ today_summary.attendance.late }})">
                <div class="h2 fw-bold text-info mb-1">{{ today_summary.attendance.late }}</div>
                <div class="text-secondary small text-uppercase fw-bold">Late</div>
            </div>
        </div>

        <!-- On Leave -->
        <div class="col">
            <div class="stat-card border border-1 p-3 h-100 text-center cursor-pointer"
                onclick="openAttendanceModal('leaves', {{ today_summary.leaves }})">
                <div class="h2 fw-bold text-info mb-1">{{ today_summary.leaves }}</div>
                <div class="text-secondary small text-uppercase fw-bold">On Leave</div>
            </div>
        </div>
    </div>

    <!-- Operational Hub Section -->
    <div class="row row-cols-2 row-cols-md-3 row-cols-lg-5 g-3 mb-3">
        <!-- OT Approval Manager -->
        <div class="col">
            <a href="/ot/manager-approval"
                class="stat-card border border-1 d-flex flex-column align-items-center justify-content-center text-decoration-none p-3 h-100 text-dark">
                <i class="fas fa-user-check text-success fs-4 mb-2"></i>
                <div class="small fw-bold text-center">OT Approval (Manager)</div>
            </a>
        </div>

        <!-- OT Attendance -->
        <div class="col">
            <a href="/dashboard/hr-manager/ot-attendance?company_id={{ selected_company.id }}"
                class="stat-card border border-1 d-flex flex-column align-items-center justify-content-center text-decoration-none p-3 h-100 text-dark">
                <i class="fas fa-clock text-info fs-4 mb-2"></i>
                <div class="small fw-bold text-center">OT Hours</div>
                <div class="small fw-bold mt-1">{{ "%.1f" | format(mtd_ot.total_hours) }}h</div>
            </a>
        </div>

        <!-- Payroll Reminder -->
        <div class="col">
            <a href="/dashboard/hr-manager/payroll-reminder?company_id={{ selected_company.id }}"
                class="stat-card border border-1 d-flex flex-column align-items-center justify-content-center text-decoration-none p-3 h-100 text-dark">
                <i class="fas fa-bell text-warning fs-4 mb-2"></i>
                <div class="small fw-bold text-center">Payroll Reminder</div>
            </a>
        </div>

        <!-- Generate Payroll -->
        <div class="col">
            <a href="/dashboard/hr-manager/generate-payroll"
                class="stat-card border border-1 d-flex flex-column align-items-center justify-content-center text-decoration-none p-3 h-100 text-dark">
                <i class="fas fa-file-invoice-dollar text-primary fs-4 mb-2"></i>
                <div class="small fw-bold text-center">Generate Payroll</div>
            </a>
        </div>

        <!-- Payroll History -->
        <div class="col">
            <a href="#payroll-history"
                class="stat-card border border-1 d-flex flex-column align-items-center justify-content-center text-decoration-none p-3 h-100 text-dark">
                <i class="fas fa-history text-muted fs-4 mb-2"></i>
                <div class="small fw-bold text-center">Payroll History</div>
            </a>
        </div>
    </div>

    <!-- Additional Info Section (Max Space) -->
    <div class="row g-3">
        <div class="col-lg-12">
            <div class="stat-card p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="fw-bold mb-0">System Summary</h6>
                    <span id="todayDate" class="text-muted smaller"></span>
                </div>
                <div class="row text-center">
                    <div class="col-3 border-end">
                        <div class="small text-muted">Total Employees</div>
                        <div class="h6 fw-bold mb-0">{{ today_summary.attendance.total }}</div>
                    </div>
                    <div class="col-3 border-end">
                        <div class="small text-muted">Attendance Sync</div>
                        <div class="h6 fw-bold mb-0">{{ today_summary.not_updated }} Pending</div>
                    </div>
                    <div class="col-3 border-end">
                        <div class="small text-muted">MTD OT</div>
                        <div class="h6 fw-bold mb-0">{{ "%.1f" | format(mtd_ot.total_hours) }}h</div>
                    </div>
                    <div class="col-3">
                        <div class="small text-muted">Current Month</div>
                        <div class="h6 fw-bold mb-0">{{ month_name }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Attendance Details Modal -->
<div id="attendanceDetailModal" class="detail-modal">
    <div class="modal-content">
        <div class="modal-header d-flex justify-content-between align-items-center">
            <h4 id="attendanceModalTitle" class="mb-0">Employee Details</h4>
            <button class="modal-close" onclick="closeAttendanceModal()">&times;</button>
        </div>
        <div id="attendanceModalBody" class="modal-body-scroll">
            <!-- Content will be populated via JavaScript -->
        </div>
    </div>
</div>

<script>
    // Set today's date
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    const dateStr = new Date().toLocaleDateString('en-US', options);
    const dateEl = document.getElementById('todayDate');
    if (dateEl) dateEl.textContent = dateStr;

    // Refresh Dashboard Function
    function refreshDashboard() {
        const refreshBtn = document.querySelector('.btn i.fa-sync-alt').parentElement;
        refreshBtn.disabled = true;
        refreshBtn.querySelector('i').classList.add('fa-spin');

        setTimeout(() => {
            location.reload();
        }, 300);
    }

    // Attendance Modal Functions
    let presentData = {{ today_summary.present_details_json | safe }};

    // Ensure present data is an array
    if (!Array.isArray(presentData)) {
        presentData = [];
    }

    let attendanceModalCache = {
        'Present': presentData,
        'Absent': null,
        'Late': null,
        'leaves': null,
        'not_updated': null
    };

    function openAttendanceModal(status, count) {
        if (count === 0) {
            if (typeof showNotification === 'function') {
                showNotification(`No ${status} employees today`, 'info');
            } else {
                alert(`No ${status} employees today`);
            }
            return;
        }

        const modal = document.getElementById('attendanceDetailModal');
        const titleEl = document.getElementById('attendanceModalTitle');
        const bodyEl = document.getElementById('attendanceModalBody');

        if (!modal || !titleEl || !bodyEl) return;

        // Set title
        const titleMap = {
            'Present': 'Present Employees',
            'Absent': 'Absent Employees',
            'Late': 'Late Employees',
            'leaves': 'Employees on Leave',
            'not_updated': 'Attendance Not Updated'
        };
        titleEl.textContent = titleMap[status] || status;

        // Check cache
        if (attendanceModalCache[status]) {
            displayAttendanceData(attendanceModalCache[status], bodyEl);
            modal.style.display = 'block';
        } else {
            // Fetch via AJAX
            bodyEl.innerHTML = '<div class="text-center p-4"><i class="fas fa-spinner fa-spin fa-2x mb-2"></i><p>Loading...</p></div>';
            modal.style.display = 'block';

            const company_id = document.querySelector('select[name="company_id"]').value;
            const endpoint = (status === 'leaves')
                ? `/api/leave-details?company_id=${company_id}`
                : `/api/attendance-details?status=${status}&company_id=${company_id}`;

            fetch(endpoint)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        bodyEl.innerHTML = `<div class="alert alert-danger m-3">${data.error}</div>`;
                    } else {
                        attendanceModalCache[status] = data.data;
                        displayAttendanceData(data.data, bodyEl);
                    }
                })
                .catch(error => {
                    bodyEl.innerHTML = `<div class="alert alert-danger m-3">Failed to load data</div>`;
                });
        }
    }

    function displayAttendanceData(data, container) {
        if (!data || data.length === 0) {
            container.innerHTML = '<div class="text-center p-4 text-muted">No employees found</div>';
            return;
        }

        let html = `
            <div class="table-responsive">
                <table class="table mb-0">
                    <thead>
                        <tr>
                            <th>Employee Name</th>
                            <th>ID</th>
                            <th>Department</th>
                            <th>Designation</th>
                            <th>Time/Status</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        data.forEach(emp => {
            html += `
                <tr>
                    <td><strong>${emp.name}</strong></td>
                    <td>${emp.id}</td>
                    <td>${emp.department || 'N/A'}</td>
                    <td>${emp.designation || 'N/A'}</td>
                    <td><span class="badge bg-secondary">${emp.time || 'N/A'}</span></td>
                </tr>
            `;
        });

        html += `
                    </tbody>
                </table>
            </div>
        `;

        container.innerHTML = html;
    }

    function closeAttendanceModal() {
        const modal = document.getElementById('attendanceDetailModal');
        modal.style.display = 'none';
    }

    // Close attendance modal when clicking outside
    window.addEventListener('click', function (event) {
        const modal = document.getElementById('attendanceDetailModal');
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });
</script>
{% endblock %}