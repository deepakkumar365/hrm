{% extends "base.html" %}

{% block title %}Request Leave - Nexar{% endblock %}

{% block content %}
<div class="dashboard-wrapper">
    <div class="dashboard-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-4">
            <div>
                <h1 class="dashboard-title">{% if is_edit %}Edit Leave Request{% else %}Submit Leave Request{% endif %}
                </h1>
                <p class="dashboard-subtitle">Keep your manager informed and plan your time away with clarity</p>
            </div>
            <div class="d-flex gap-3 flex-wrap">
                <a href="{{ url_for('leave_list') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-list"></i>
                    View Requests
                </a>
                <a href="{{ url_for('dashboard') }}" class="btn btn-outline-primary">
                    <i class="fas fa-home"></i>
                    Dashboard
                </a>
            </div>
        </div>
    </div>

    <form method="POST" enctype="multipart/form-data" class="leave-request-form needs-validation" novalidate>
        <div class="leave-form-compact">
            <!-- Section 1: Leave Details & Period (Side by Side) -->
            <div class="card mb-3">
                <div class="card-body p-3">
                    <div class="row g-3">
                        <!-- Left: Leave Details -->
                        <div class="col-md-6">
                            <h6 class="mb-3"><i class="fas fa-info-circle me-2"></i>Leave Details</h6>
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <label for="leave_type" class="form-label small mb-0">Leave Type *</label>
                                        {% if (current_user.role.name if current_user.role else None) in ['Tenant
                                        Admin', 'HR Manager', 'Super Admin'] %}
                                        <a href="{{ url_for('operation_master_dashboard') }}"
                                            class="text-decoration-none small" title="Configure Leave Types">
                                            <i class="fas fa-plus-circle text-primary"></i> <span
                                                class="d-none d-sm-inline">Quick Add</span>
                                        </a>
                                        {% endif %}
                                    </div>
                                    <select class="form-select form-select-sm" id="leave_type" name="leave_type"
                                        required {% if not has_leave_types %}disabled{% endif %}>
                                        <option value="">Select Leave Type</option>
                                        {% for type in leave_types %}
                                        <option value="{{ type.name }}" {% if (form_data and
                                            form_data.get('leave_type')==type.name) or (leave and
                                            leave.leave_type==type.name and not form_data) %}selected{% endif %}
                                            data-allocation="{{ type.annual_allocation }}"
                                            data-color="{{ type.color }}">
                                            {{ type.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    {% if not has_leave_types %}
                                    <div class="form-text text-danger small">
                                        <i class="fas fa-exclamation-circle me-1"></i>No leave types configured. Please
                                        contact HR.
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small">Available Balance</label>
                                    <div class="form-control form-control-sm bg-light" id="balanceDisplay">Select type
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label for="start_date" class="form-label small">Start Date *</label>
                                    <input type="date" class="form-control form-control-sm" id="start_date"
                                        name="start_date"
                                        value="{{ form_data.get('start_date') if form_data else (leave.start_date.strftime('%Y-%m-%d') if leave else '') }}"
                                        required onclick="this.showPicker()">
                                </div>
                                <div class="col-md-4">
                                    <label for="end_date" class="form-label small">End Date *</label>
                                    <input type="date" class="form-control form-control-sm" id="end_date"
                                        name="end_date"
                                        value="{{ form_data.get('end_date') if form_data else (leave.end_date.strftime('%Y-%m-%d') if leave else '') }}"
                                        required onclick="this.showPicker()">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small">Half Day</label>
                                    <div class="form-check form-switch mt-1">
                                        <input class="form-check-input" type="checkbox" id="halfDay">
                                        <label class="form-check-label small" for="halfDay">Yes</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Right: Leave Period Summary -->
                        <div class="col-md-6">
                            <h6 class="mb-3"><i class="fas fa-calendar-alt me-2"></i>Leave Period</h6>
                            <div class="row g-2">
                                <div class="col-4">
                                    <div class="text-center p-2 bg-light rounded">
                                        <small class="text-muted d-block">Total Days</small>
                                        <strong id="totalDays" class="fs-5">0</strong>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="text-center p-2 bg-light rounded">
                                        <small class="text-muted d-block">Working Days</small>
                                        <strong id="workingDays" class="fs-5">0</strong>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="text-center p-2 bg-success bg-opacity-10 rounded">
                                        <small class="text-muted d-block">Balance</small>
                                        <strong id="summaryBalance" class="fs-5 text-success">—</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 2: Reason & Contact (Side by Side) -->
            <div class="card mb-3">
                <div class="card-body p-3">
                    <div class="row g-3">
                        <!-- Left: Reason & Documentation -->
                        <div class="col-md-6">
                            <h6 class="mb-3"><i class="fas fa-file-alt me-2"></i>Reason & Documentation</h6>
                            <div class="mb-2">
                                <label for="reason" class="form-label small">Reason for Leave</label>
                                <textarea class="form-control form-control-sm" id="reason" name="reason" rows="2"
                                    placeholder="Brief context">{{ form_data.get('reason') if form_data else (leave.reason if leave else '') }}</textarea>
                            </div>
                            <div class="mb-2">
                                <label for="attachment" class="form-label small">
                                    <i class="fas fa-paperclip me-1"></i>Attach Document (Optional)
                                </label>
                                <input type="file" class="form-control form-control-sm" id="attachment"
                                    name="attachment" accept=".pdf,.jpg,.jpeg,.png">
                                <small class="form-text text-muted">Accepted: PDF, JPG, PNG (Max 5MB)</small>
                            </div>
                            <div class="alert alert-warning py-2 px-3 mb-0">
                                <small><i class="fas fa-info-circle me-1"></i><strong>Guidelines:</strong> Annual leave:
                                    2 weeks advance. Medical leave >3 days: MC required.</small>
                            </div>
                        </div>
                        <!-- Right: Contact & Coverage -->
                        <div class="col-md-6">
                            <h6 class="mb-3"><i class="fas fa-phone-alt me-2"></i>Contact & Coverage</h6>
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <label for="contact_phone" class="form-label small">Emergency Contact</label>
                                    <input type="tel" class="form-control form-control-sm" id="contact_phone"
                                        name="contact_phone" placeholder="+65 XXXX XXXX">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small">Contactable</label>
                                    <div class="form-check form-switch mt-1">
                                        <input class="form-check-input" type="checkbox" id="contactable" checked>
                                        <label class="form-check-label small" for="contactable">Available for urgent
                                            matters</label>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <label for="coverage_notes" class="form-label small">Handover Notes</label>
                                    <textarea class="form-control form-control-sm" id="coverage_notes"
                                        name="coverage_notes" rows="2" placeholder="Task coverage details"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 3: Request Summary (Bottom) -->
            <div class="card">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">Request Summary</h6>
                            <small class="text-muted">
                                <span id="summaryType">—</span> |
                                <span id="summaryPeriod">—</span> |
                                <span id="summaryDays">0</span> days
                            </small>
                        </div>
                        <div class="d-flex gap-2">
                            <a href="{{ url_for('leave_list') }}" class="btn btn-sm btn-outline-secondary">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-sm btn-primary" id="submitBtn">
                                <i class="fas fa-paper-plane"></i> Submit Request
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

{% block scripts %}
<script>
    // Form validation
    (function () {
        'use strict';
        window.addEventListener('load', function () {
            var forms = document.getElementsByClassName('needs-validation');
            var validation = Array.prototype.filter.call(forms, function (form) {
                form.addEventListener('submit', function (event) {
                    if (form.checkValidity() === false) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            });
        }, false);
    })();

    // Date calculation
    function calculateDays() {
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;

        if (startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);

            if (end >= start) {
                const totalMs = end.getTime() - start.getTime() + (24 * 60 * 60 * 1000);
                const totalDays = Math.floor(totalMs / (24 * 60 * 60 * 1000));

                // Calculate working days (excluding weekends)
                let workingDays = 0;
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    if (d.getDay() !== 0 && d.getDay() !== 6) { // Not Sunday or Saturday
                        workingDays++;
                    }
                }

                document.getElementById('totalDays').textContent = totalDays;
                document.getElementById('workingDays').textContent = workingDays;

                // Update summary
                document.getElementById('summaryDays').textContent = workingDays;

                // Adjust for half day
                const isHalfDay = document.getElementById('halfDay').checked;
                if (isHalfDay && totalDays === 1) {
                    document.getElementById('workingDays').textContent = '0.5';
                    document.getElementById('summaryDays').textContent = '0.5';
                }
            } else {
                document.getElementById('totalDays').textContent = '0';
                document.getElementById('workingDays').textContent = '0';
                document.getElementById('summaryDays').textContent = '0';
            }
        }
    }

    // Leave balance logic
    function updateLeaveBalance() {
        const leaveTypeSelect = document.getElementById('leave_type');
        const selectedOption = leaveTypeSelect.options[leaveTypeSelect.selectedIndex];

        const balanceDisplay = document.getElementById('balanceDisplay');
        const summaryBalance = document.getElementById('summaryBalance');
        const summaryType = document.getElementById('summaryType');

        if (leaveTypeSelect.value) {
            summaryType.textContent = leaveTypeSelect.value;

            // Use allocation data from the option if available
            const allocation = selectedOption.getAttribute('data-allocation');
            if (allocation && allocation !== '0') {
                const balanceText = allocation + ' days (Annual)'; // Simplified logic
                balanceDisplay.textContent = balanceText;
                summaryBalance.textContent = balanceText;
            } else {
                // Fallback for types without specific allocation set
                balanceDisplay.textContent = 'Check with HR';
                summaryBalance.textContent = '—';
            }
        } else {
            balanceDisplay.textContent = 'Select leave type';
            summaryBalance.textContent = '—';
            summaryType.textContent = '—';
        }
    }

    // Update summary period
    function updateSummaryPeriod() {
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;
        const summaryPeriod = document.getElementById('summaryPeriod');

        if (startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);

            const startFormatted = start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const endFormatted = end.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

            if (startDate === endDate) {
                summaryPeriod.textContent = startFormatted + ', ' + start.getFullYear();
            } else {
                summaryPeriod.textContent = startFormatted + ' - ' + endFormatted;
            }
        } else {
            summaryPeriod.textContent = '—';
        }
    }

    // Event listeners
    document.getElementById('start_date').addEventListener('change', function () {
        calculateDays();
        updateSummaryPeriod();
    });

    document.getElementById('end_date').addEventListener('change', function () {
        calculateDays();
        updateSummaryPeriod();
    });

    document.getElementById('halfDay').addEventListener('change', calculateDays);
    document.getElementById('leave_type').addEventListener('change', updateLeaveBalance);

    // Initialize
    updateLeaveBalance();
    calculateDays();
    updateSummaryPeriod();
</script>
{% endblock %}

{% endblock %}