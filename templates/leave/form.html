{% extends "base.html" %}

{% block title %}Request Leave - Noltrion{% endblock %}

{% block content %}
<div class="leave-layout">
    <div class="section-header">
        <div>
            <h1 class="section-title">{% if is_edit %}Edit Leave Request{% else %}Submit Leave Request{% endif %}</h1>
            <p class="section-subtitle">Keep your manager informed and plan your time away with clarity.</p>
        </div>
        <div class="d-flex gap-3">
            <a href="{{ url_for('leave_list') }}" class="btn btn-outline-secondary">
                <i class="fas fa-list"></i>
                View Requests
            </a>
            <a href="{{ url_for('dashboard') }}" class="btn btn-primary">
                <i class="fas fa-home"></i>
                Back to Dashboard
            </a>
        </div>
    </div>

    <form method="POST" class="dashboard-grid needs-validation" novalidate>
        <div class="col-span-8">
            <div class="section-card">
                <h3 class="mb-4">Leave Details</h3>
                <div class="row g-4">
                    <div class="col-md-6">
                        <label for="leave_type" class="form-label">Leave Type *</label>
                        <select class="form-select" id="leave_type" name="leave_type" required>
                            <option value="">Select Leave Type</option>
                            <option value="Annual Leave" {% if (form_data and form_data.get('leave_type') == 'Annual Leave') or (leave and leave.leave_type == 'Annual Leave' and not form_data) %}selected{% endif %}>Annual Leave</option>
                            <option value="Medical Leave" {% if (form_data and form_data.get('leave_type') == 'Medical Leave') or (leave and leave.leave_type == 'Medical Leave' and not form_data) %}selected{% endif %}>Medical Leave</option>
                            <option value="Maternity Leave" {% if (form_data and form_data.get('leave_type') == 'Maternity Leave') or (leave and leave.leave_type == 'Maternity Leave' and not form_data) %}selected{% endif %}>Maternity Leave</option>
                            <option value="Paternity Leave" {% if (form_data and form_data.get('leave_type') == 'Paternity Leave') or (leave and leave.leave_type == 'Paternity Leave' and not form_data) %}selected{% endif %}>Paternity Leave</option>
                            <option value="Compassionate Leave" {% if (form_data and form_data.get('leave_type') == 'Compassionate Leave') or (leave and leave.leave_type == 'Compassionate Leave' and not form_data) %}selected{% endif %}>Compassionate Leave</option>
                            <option value="Childcare Leave" {% if (form_data and form_data.get('leave_type') == 'Childcare Leave') or (leave and leave.leave_type == 'Childcare Leave' and not form_data) %}selected{% endif %}>Childcare Leave</option>
                            <option value="Emergency Leave" {% if (form_data and form_data.get('leave_type') == 'Emergency Leave') or (leave and leave.leave_type == 'Emergency Leave' and not form_data) %}selected{% endif %}>Emergency Leave</option>
                            <option value="Study Leave" {% if (form_data and form_data.get('leave_type') == 'Study Leave') or (leave and leave.leave_type == 'Study Leave' and not form_data) %}selected{% endif %}>Study Leave</option>
                            <option value="Unpaid Leave" {% if (form_data and form_data.get('leave_type') == 'Unpaid Leave') or (leave and leave.leave_type == 'Unpaid Leave' and not form_data) %}selected{% endif %}>Unpaid Leave</option>
                        </select>
                        <div class="invalid-feedback">Please select a leave type.</div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Available Balance</label>
                        <div class="form-control d-flex align-items-center justify-content-between" style="background: var(--grey-50); border-color: var(--grey-200);">
                            <span class="fw-semibold" style="color: var(--primary-green);" id="balanceDisplay">Select leave type</span>
                            <i class="fas fa-chart-pie" style="color: var(--primary-green);"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section-card">
                <h3 class="mb-4">Leave Period</h3>
                <div class="row g-4">
                    <div class="col-md-6">
                        <label for="start_date" class="form-label">Start Date *</label>
                        <input type="date" class="form-control" id="start_date" name="start_date" value="{{ form_data.get('start_date') if form_data else (leave.start_date.strftime('%Y-%m-%d') if leave else '') }}" required>
                        <div class="invalid-feedback">Please select a start date.</div>
                    </div>
                    <div class="col-md-6">
                        <label for="end_date" class="form-label">End Date *</label>
                        <input type="date" class="form-control" id="end_date" name="end_date" value="{{ form_data.get('end_date') if form_data else (leave.end_date.strftime('%Y-%m-%d') if leave else '') }}" required>
                        <div class="invalid-feedback">Please select an end date.</div>
                    </div>
                </div>

                <div class="leave-timeline">
                    <div class="item">
                        <span>Total Days</span>
                        <strong id="totalDays">0</strong>
                    </div>
                    <div class="item">
                        <span>Working Days</span>
                        <strong id="workingDays">0</strong>
                    </div>
                    <div class="item">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="halfDay">
                            <label class="form-check-label" for="halfDay">Half Day leave</label>
                        </div>
                        <small class="text-muted">Use for partial-day requests</small>
                    </div>
                </div>
            </div>

            <div class="section-card">
                <h3 class="mb-4">Reason & Documentation</h3>
                <div class="mb-4">
                    <label for="reason" class="form-label">Reason for Leave</label>
                    <textarea class="form-control" id="reason" name="reason" rows="4" placeholder="Provide brief context or supporting details">{{ form_data.get('reason') if form_data else (leave.reason if leave else '') }}</textarea>
                    <small class="text-muted d-block mt-2">
                        <i class="fas fa-lightbulb"></i>
                        Be specific for medical or emergency leaves.
                    </small>
                </div>
                <div class="alert alert-warning">
                    <h6 class="fw-semibold mb-2">
                        <i class="fas fa-info-circle"></i>
                        Guidelines
                    </h6>
                    <ul class="mb-0 ps-3">
                        <li>Submit annual leave at least two weeks in advance.</li>
                        <li>Medical leave longer than 3 days requires a medical certificate.</li>
                        <li>Emergency leave should be notified as soon as possible.</li>
                    </ul>
                </div>
            </div>

            <div class="section-card">
                <h3 class="mb-4">Contact & Coverage</h3>
                <div class="row g-4">
                    <div class="col-md-6">
                        <label for="contact_phone" class="form-label">Emergency Contact Number</label>
                        <input type="tel" class="form-control" id="contact_phone" name="contact_phone" placeholder="+65 XXXX XXXX">
                        <small class="text-muted">For urgent communication while away.</small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Contact Preference</label>
                        <div class="form-check form-switch mt-2">
                            <input class="form-check-input" type="checkbox" id="contactable" checked>
                            <label class="form-check-label" for="contactable">Available for urgent matters</label>
                        </div>
                    </div>
                    <div class="col-12">
                        <label for="coverage_notes" class="form-label">Handover Notes</label>
                        <textarea class="form-control" id="coverage_notes" name="coverage_notes" rows="3" placeholder="Outline task coverage, handover details, and key contacts"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-span-4">
            <div class="section-card">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h3 class="mb-1">Request Summary</h3>
                        <p class="text-muted mb-0">Double-check details before submitting.</p>
                    </div>
                    <span class="badge bg-primary">Draft</span>
                </div>

                <div class="stat-card mb-4">
                    <div class="stat-card-icon success" style="width: 40px; height: 40px; font-size: 1rem;">
                        <i class="fas fa-leaf"></i>
                    </div>
                    <div class="stat-card-value" id="summaryBalance">—</div>
                    <div class="stat-card-label">Leave Balance</div>
                    <div class="stat-card-change" id="summaryTrend">
                        <i class="fas fa-info-circle"></i>
                        Stay within allowance
                    </div>
                </div>

                <div class="mb-4">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Leave Type</span>
                        <strong id="summaryType">—</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Period</span>
                        <strong id="summaryPeriod">—</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">Days Requested</span>
                        <strong id="summaryDays">0</strong>
                    </div>
                </div>

                <div class="alert alert-info">
                    <div class="d-flex align-items-start gap-2">
                        <i class="fas fa-info-circle mt-1"></i>
                        <div>
                            <h6 class="fw-semibold mb-1">Approval workflow</h6>
                            <p class="mb-0 small">Your manager will review within 2 business days. Track status under "Leave Requests".</p>
                        </div>
                    </div>
                </div>

                <div class="d-flex gap-3 mt-4">
                    <a href="{{ url_for('leave_list') }}" class="btn btn-outline-secondary flex-fill">
                        <i class="fas fa-times"></i>
                        Cancel
                    </a>
                    <button type="submit" class="btn btn-primary flex-fill" id="submitBtn">
                        <i class="fas fa-paper-plane"></i>
                        Submit Request
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

{% block scripts %}
<script>
// Form validation
(function() {
    'use strict';
    window.addEventListener('load', function() {
        var forms = document.getElementsByClassName('needs-validation');
        var validation = Array.prototype.filter.call(forms, function(form) {
            form.addEventListener('submit', function(event) {
                if (form.checkValidity() === false) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    }, false);
})();

// Date calculation
function calculateDays() {
    const startDate = document.getElementById('start_date').value;
    const endDate = document.getElementById('end_date').value;
    
    if (startDate && endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        
        if (end >= start) {
            const totalMs = end.getTime() - start.getTime() + (24 * 60 * 60 * 1000);
            const totalDays = Math.floor(totalMs / (24 * 60 * 60 * 1000));
            
            // Calculate working days (excluding weekends)
            let workingDays = 0;
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                if (d.getDay() !== 0 && d.getDay() !== 6) { // Not Sunday or Saturday
                    workingDays++;
                }
            }
            
            document.getElementById('totalDays').textContent = totalDays;
            document.getElementById('workingDays').textContent = workingDays;
            
            // Update summary
            document.getElementById('summaryDays').textContent = workingDays;
            
            // Adjust for half day
            const isHalfDay = document.getElementById('halfDay').checked;
            if (isHalfDay && totalDays === 1) {
                document.getElementById('workingDays').textContent = '0.5';
                document.getElementById('summaryDays').textContent = '0.5';
            }
        } else {
            document.getElementById('totalDays').textContent = '0';
            document.getElementById('workingDays').textContent = '0';
            document.getElementById('summaryDays').textContent = '0';
        }
    }
}

// Leave balance simulation (in real app, this would fetch from API)
function updateLeaveBalance() {
    const leaveType = document.getElementById('leave_type').value;
    const balanceDisplay = document.getElementById('balanceDisplay');
    const summaryBalance = document.getElementById('summaryBalance');
    const summaryType = document.getElementById('summaryType');
    
    if (leaveType) {
        // Simulate different balances for different leave types
        const balances = {
            'Annual Leave': '12 days',
            'Medical Leave': '10 days',
            'Maternity Leave': '90 days',
            'Paternity Leave': '14 days',
            'Compassionate Leave': '5 days',
            'Childcare Leave': '6 days',
            'Emergency Leave': '3 days',
            'Study Leave': '5 days',
            'Unpaid Leave': 'No limit'
        };
        
        const balance = balances[leaveType] || 'Check with HR';
        balanceDisplay.textContent = balance;
        summaryBalance.textContent = balance;
        summaryType.textContent = leaveType;
    } else {
        balanceDisplay.textContent = 'Select leave type';
        summaryBalance.textContent = '—';
        summaryType.textContent = '—';
    }
}

// Update summary period
function updateSummaryPeriod() {
    const startDate = document.getElementById('start_date').value;
    const endDate = document.getElementById('end_date').value;
    const summaryPeriod = document.getElementById('summaryPeriod');
    
    if (startDate && endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        
        const startFormatted = start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        const endFormatted = end.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        
        if (startDate === endDate) {
            summaryPeriod.textContent = startFormatted + ', ' + start.getFullYear();
        } else {
            summaryPeriod.textContent = startFormatted + ' - ' + endFormatted;
        }
    } else {
        summaryPeriod.textContent = '—';
    }
}

// Event listeners
document.getElementById('start_date').addEventListener('change', function() {
    calculateDays();
    updateSummaryPeriod();
});

document.getElementById('end_date').addEventListener('change', function() {
    calculateDays();
    updateSummaryPeriod();
});

document.getElementById('halfDay').addEventListener('change', calculateDays);
document.getElementById('leave_type').addEventListener('change', updateLeaveBalance);

// Initialize
updateLeaveBalance();
calculateDays();
updateSummaryPeriod();
</script>
{% endblock %}

{% endblock %}
