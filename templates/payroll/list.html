{% extends "base.html" %}

{% block title %}Payroll Management - Nexar{% endblock %}

{% block content %}
{% macro render_money(amount, class_name='', zero_dash=True, show_currency_symbol=True) %}
{% if not amount or amount == 0.0 %}
{% if zero_dash %}
<span class="text-muted opacity-25" style="font-weight: 300;">-</span>
{% else %}
<span class="text-muted opacity-50">{{ 0 | currency }}</span>
{% endif %}
{% else %}
<span class="{{ class_name }}">{{ amount | currency }}</span>
{% endif %}
{% endmacro %}

<style>
    /* Premium Dashboard Styling */
    :root {
        --primary-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
        --glass-bg: rgba(255, 255, 255, 0.95);
        --glass-border: 1px solid rgba(255, 255, 255, 0.18);
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .dashboard-container {
        padding: 1rem 1.5rem;
        background-color: #f8fafc;
        min-height: 100vh;
        max-width: 100%;
    }

    /* Summary Cards - Compact */
    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 1rem;
        box-shadow: var(--shadow-sm);
        border: 1px solid #e2e8f0;
        height: 100%;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .stat-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        flex-shrink: 0;
    }

    .stat-content {
        flex-grow: 1;
    }

    .stat-label {
        font-size: 0.75rem;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }

    .stat-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1e293b;
        line-height: 1.2;
    }

    /* Filters Section - Compact */
    .filter-card {
        background: white;
        border-radius: 12px;
        padding: 1rem;
        box-shadow: var(--shadow-sm);
        margin-bottom: 1.5rem;
        border: 1px solid #e2e8f0;
    }

    .form-select-sm-custom {
        padding-top: 0.375rem;
        padding-bottom: 0.375rem;
        font-size: 0.875rem;
    }

    /* Modern Table - Dense & Full Width */
    .custom-table-container {
        background: white;
        border-radius: 12px;
        box-shadow: var(--shadow-sm);
        border: 1px solid #e2e8f0;
        overflow: hidden;
    }

    .custom-table {
        width: 100%;
        font-size: 0.8125rem;
    }

    .custom-table thead {
        background: #f1f5f9;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .custom-table th {
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.7rem;
        letter-spacing: 0.05em;
        color: #475569;
        padding: 0.5rem 0.25rem;
        border-bottom: 2px solid #e2e8f0;
        white-space: nowrap;
        vertical-align: middle;
    }

    .custom-table td {
        padding: 0.25rem 0.25rem;
        vertical-align: middle;
        border-bottom: 1px solid #f1f5f9;
        white-space: nowrap;
        height: 48px;
    }

    .custom-table tr:hover {
        background-color: #f8fafc;
    }

    /* Status Indicators */
    .status-badge {
        padding: 0.15rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.65rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }

    .status-draft {
        background-color: #f1f5f9;
        color: #475569;
        border: 1px solid #e2e8f0;
    }

    .status-approved {
        background-color: #f0fdf4;
        color: #15803d;
        border: 1px solid #dcfce7;
    }

    .status-finalized {
        background-color: #eff6ff;
        color: #1d4ed8;
        border: 1px solid #dbeafe;
    }

    .status-paid {
        background-color: #ecfccb;
        color: #3f6212;
        border: 1px solid #d9f99d;
    }

    .status-pending {
        background-color: #fff7ed;
        color: #c2410c;
        border: 1px solid #ffedd5;
    }

    .avatar-circle {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: #e0e7ff;
        color: #4338ca;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.75rem;
        margin-right: 0.5rem;
        flex-shrink: 0;
    }

    /* Column Widths */
    .col-employee {
        min-width: 160px;
        width: 20%;
    }

    .col-period {
        width: 10%;
    }

    .col-money {
        text-align: right;
        font-family: 'SF Mono', 'Roboto Mono', Menlo, monospace;
        letter-spacing: -0.5px;
        min-width: 80px;
    }

    .col-action {
        width: 120px;
        text-align: center;
    }

    .text-earn {
        color: #059669;
    }

    .text-deduct {
        color: #dc2626;
    }

    .bg-subtle-blue {
        background-color: rgba(224, 231, 255, 0.2);
    }
</style>

<div class="dashboard-container">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0 small">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}"
                            class="text-decoration-none">Dashboard</a></li>
                    <li class="breadcrumb-item active">Payroll</li>
                </ol>
            </nav>
            <h5 class="fw-bold text-dark mb-0 mt-1">Payroll Management</h5>
        </div>
        {% if (current_user.role.name if current_user.role else None) in ['Super Admin', 'Admin', 'HR Manager', 'Tenant
        Admin'] %}
        <div>
            <a href="{{ url_for('payroll_generate') }}" class="btn btn-sm btn-primary shadow-sm">
                <i class="fas fa-plus me-1"></i>Generate Payroll
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Filters -->
    <form method="GET" class="filter-card">
        <div class="row g-2 align-items-end">
            {% if (current_user.role.name if current_user.role else None) in ['HR Manager', 'Tenant Admin'] %}
            <div class="col-md-3">
                <label class="form-label text-muted small fw-bold mb-1">Company</label>
                <select name="company_id" class="form-select form-select-sm form-select-sm-custom">
                    <option value="">All Companies</option>
                    {% for company in companies %}
                    <option value="{{ company.id|string }}" {% if company_id==company.id|string %}selected{% endif %}>
                        {{ company.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label text-muted small fw-bold mb-1">Employee</label>
                <select name="employee_id" class="form-select form-select-sm form-select-sm-custom">
                    <option value="">All Employees</option>
                    {% for emp in employees %}
                    <option value="{{ emp.id }}" {% if employee_id|int==emp.id %}selected{% endif %}>
                        {{ emp.first_name }} {{ emp.last_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}

            <div class="col-md-2">
                <label class="form-label text-muted small fw-bold mb-1">Month</label>
                <select name="month" class="form-select form-select-sm form-select-sm-custom">
                    <option value="">All Months</option>
                    {% for i in range(1, 13) %}
                    <option value="{{ i }}" {% if i==month %}selected{% endif %}>
                        {{ calendar.month_name[i] }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label text-muted small fw-bold mb-1">Year</label>
                <select name="year" class="form-select form-select-sm form-select-sm-custom">
                    <option value="">All Years</option>
                    {% for y in years %}
                    <option value="{{ y }}" {% if y==year %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary btn-sm w-100 py-2">
                    <i class="fas fa-search me-2"></i>Filter
                </button>
            </div>
        </div>
    </form>

    <!-- Summary Cards -->
    <div class="row g-3 mb-3">
        <div class="col-6 col-md-3">
            <div class="stat-card">
                <div class="stat-icon bg-blue-50 text-primary">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Records</div>
                    <div class="stat-value" id="summaryCount">0</div>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="stat-card">
                <div class="stat-icon bg-green-50 text-success">
                    <i class="fas fa-wallet"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Total Net Pay</div>
                    <div class="stat-value text-success" id="summaryNet">$0.00</div>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="stat-card">
                <div class="stat-icon bg-cyan-50 text-info">
                    <i class="fas fa-file-invoice-dollar"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Total Gross</div>
                    <div class="stat-value" id="summaryGross">$0.00</div>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="stat-card">
                <div class="stat-icon bg-red-50 text-danger">
                    <i class="fas fa-percentage"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">CPF (Total)</div>
                    <div class="stat-value text-danger" id="summaryCpf">$0.00</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="custom-table-container position-relative">
        <div class="table-responsive">
            <table class="table custom-table table-hover mb-0" id="payrollTable">
                <thead>
                    <tr>
                        <th class="col-employee ps-3">Employee</th>
                        <th class="col-period">Period</th>
                        <th class="col-money">Basic</th>
                        <th class="col-money">Allowances</th>
                        <th class="col-money">OT Pay</th>
                        <th class="col-money text-earn fw-bold">Gross</th>
                        <th class="col-money text-deduct">CPF(Emp)</th>
                        <th class="col-money text-deduct">CPF(Empr)</th>
                        <th class="col-money text-deduct">Other Ded</th>
                        <th class="col-money bg-subtle-blue fw-bold text-primary">Net Pay</th>
                        <th>Status</th>
                        <th class="col-action">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for payroll in payrolls.items %}
                    <tr class="payroll-row" data-net="{{ payroll.net_pay }}" data-gross="{{ payroll.gross_pay }}"
                        data-cpf-emp="{{ payroll.employee_cpf }}" data-cpf-empr="{{ payroll.employer_cpf }}">
                        <td class="ps-3">
                            <div class="d-flex align-items-center">
                                <div class="avatar-circle">
                                    {{ payroll.employee.first_name[0] }}{{ payroll.employee.last_name[0] }}
                                </div>
                                <div class="text-truncate" style="max-width: 140px;"
                                    title="{{ payroll.employee.first_name }} {{ payroll.employee.last_name }}">
                                    <div class="fw-bold text-dark">{{ payroll.employee.first_name }} {{
                                        payroll.employee.last_name }}</div>
                                    <div class="small text-muted" style="font-size: 0.65rem;">{{
                                        payroll.employee.employee_id }}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="small">
                                {{ payroll.pay_period_end.strftime('%b %Y') }}
                            </div>
                        </td>
                        <td class="col-money">{{ render_money(payroll.basic_pay) }}</td>
                        <td class="col-money">{{ render_money(payroll.allowances) }}</td>
                        <td class="col-money">{{ render_money(payroll.overtime_pay, 'text-danger') }}</td>
                        <td class="col-money">{{ render_money(payroll.gross_pay, 'text-earn fw-bold') }}</td>
                        <td class="col-money text-deduct">
                            {% if payroll.employee_cpf > 0 %}-{% endif %}{{ render_money(payroll.employee_cpf) }}
                        </td>
                        <td class="col-money text-deduct">
                            {% if payroll.employer_cpf > 0 %}-{% endif %}{{ render_money(payroll.employer_cpf) }}
                        </td>
                        <td class="col-money text-deduct">
                            {% if payroll.other_deductions > 0 %}-{% endif %}{{ render_money(payroll.other_deductions)
                            }}
                        </td>
                        <td class="col-money bg-subtle-blue fw-bold text-primary">{{ render_money(payroll.net_pay) }}
                        </td>
                        <td>
                            {% if payroll.status == 'Draft' %}
                            <span class="status-badge status-draft"><i class="fas fa-file me-1"></i>Draft</span>
                            {% elif payroll.status == 'Approved' %}
                            <span class="status-badge status-approved"><i
                                    class="fas fa-check-circle me-1"></i>Approved</span>
                            {% elif payroll.status == 'Finalized' %}
                            <span class="status-badge status-finalized"><i class="fas fa-lock me-1"></i>Finalized</span>
                            {% elif payroll.status == 'Paid' %}
                            <span class="status-badge status-paid"><i
                                    class="fas fa-money-bill-wave me-1"></i>Paid</span>
                            {% elif payroll.status == 'Pending' %}
                            <span class="status-badge status-pending"><i class="fas fa-clock me-1"></i>Pending</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ payroll.status }}</span>
                            {% endif %}
                        </td>
                        <td class="col-action">
                            <div class="btn-group btn-group-sm">
                                <a href="{{ url_for('payroll_payslip', payroll_id=payroll.id) }}"
                                    class="btn btn-light border py-0 px-2" title="View Payslip" target="_blank">
                                    <i class="fas fa-eye text-primary small"></i>
                                </a>
                                {% if (current_user.role.name if current_user.role else None) in ['Super Admin',
                                'Admin', 'Tenant Admin', 'HR Manager'] %}
                                {% if payroll.status == 'Draft' %}
                                <button class="btn btn-light border py-0 px-2"
                                    onclick="approvePayroll({{ payroll.id }})" title="Approve">
                                    <i class="fas fa-check-circle text-success small"></i>
                                </button>
                                {% elif payroll.status == 'Approved' %}
                                <button class="btn btn-light border py-0 px-2"
                                    onclick="finalizePayroll({{ payroll.id }})" title="Finalize">
                                    <i class="fas fa-file-signature text-warning small"></i>
                                </button>
                                {% endif %}
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="12" class="text-center py-5 text-muted">
                            <i class="fas fa-file-invoice-dollar fa-2x mb-2 opacity-25"></i>
                            <p class="mb-0">No payroll records found for the selected period.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if payrolls.pages > 1 %}
        <div class="p-2 border-top bg-light d-flex justify-content-between align-items-center">
            <small class="text-muted ms-2">Page {{ payrolls.page }} of {{ payrolls.pages }}</small>
            <nav>
                <ul class="pagination pagination-sm mb-0">
                    <li class="page-item {% if not payrolls.has_prev %}disabled{% endif %}">
                        <a class="page-link border-0 bg-transparent text-secondary"
                            href="{{ url_for('payroll_list', page=payrolls.prev_num, month=month, year=year, company_id=company_id, employee_id=employee_id) }}">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                    <li class="page-item {% if not payrolls.has_next %}disabled{% endif %}">
                        <a class="page-link border-0 bg-transparent text-secondary"
                            href="{{ url_for('payroll_list', page=payrolls.next_num, month=month, year=year, company_id=company_id, employee_id=employee_id) }}">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>

<script>
    // Constants for formatting
    const currencyFormatter = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD', // Adjust if needed, or stick to generic format
    });

    document.addEventListener('DOMContentLoaded', function () {
        calculateSummary();
    });

    function calculateSummary() {
        let count = 0;
        let totalNet = 0;
        let totalGross = 0;
        let totalCpf = 0;

        document.querySelectorAll('.payroll-row').forEach(row => {
            count++;
            totalNet += parseFloat(row.dataset.net || 0);
            totalGross += parseFloat(row.dataset.gross || 0);
            totalCpf += parseFloat(row.dataset.cpfEmp || 0) + parseFloat(row.dataset.cpfEmpr || 0);
        });

        document.getElementById('summaryCount').innerText = count;
        document.getElementById('summaryNet').innerText = '$' + totalNet.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        document.getElementById('summaryGross').innerText = '$' + totalGross.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        document.getElementById('summaryCpf').innerText = '$' + totalCpf.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // --- Actions ---

    function approvePayroll(payrollId) {
        if (confirm('Are you sure you want to approve this payroll?')) {
            fetch(`/payroll/${payrollId}/approve`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Error approving payroll');
                    }
                })
                .catch(error => {
                    alert('Error approving payroll');
                    console.error(error);
                });
        }
    }

    function finalizePayroll(payrollId) {
        if (confirm('Are you sure you want to finalize this payroll? Once finalized, it cannot be changed.')) {
            fetch(`/payroll/${payrollId}/finalize`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Error finalizing payroll');
                    }
                })
                .catch(error => {
                    alert('Error finalizing payroll');
                    console.error(error);
                });
        }
    }
</script>
{% endblock %}