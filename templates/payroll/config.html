{% extends "base.html" %}

{% block title %}Payroll Configuration - Nexar{% endblock %}

{% block content %}<div class="payroll-config-container">
    <!-- Header Section -->
    <div class="payroll-header">
        <div>
            <div>
                <h3>
                    <i class="fas fa-dollar-sign me-2"></i>Payroll Configuration
                </h3>
                <p>Manage salary components and CPF contributions</p>
            </div>
            <div>
                <a href="{{ url_for('payroll_list') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Back
                </a>
            </div>
        </div>
    </div>

    <!-- Toolbar Section -->
    <div class="payroll-toolbar">
        <form method="GET">
            <input type="text" name="search" placeholder="Search employee..." value="{{ search }}">
            <button type="submit">
                <i class="fas fa-search"></i> Search
            </button>
            {% if search %}
            <a href="{{ url_for('payroll_config') }}">
                <i class="fas fa-times"></i> Clear
            </a>
            {% endif %}
        </form>
    </div>

    <!-- Content Section -->
    <div class="payroll-content">
        {% if employees and employees.items|length > 0 %}
        <div class="grid-wrapper">
            <table class="payroll-grid">
                <thead>
                    <tr>
                        <th class="sortable" data-column="employee_id">Emp ID</th>
                        <th class="sortable" data-column="first_name">Employee Name</th>
                        <th class="sortable" data-column="designation">Job Title</th>
                        <th class="sortable numeric" data-column="basic_salary">Basic Salary</th>
                        <th class="sortable numeric">Transport</th>
                        <th class="sortable numeric">Housing</th>
                        <th class="sortable numeric">Meal</th>
                        <th class="sortable numeric">Other</th>
                        <th class="sortable numeric" data-column="ot_rate_per_hour">OT Rate</th>
                        <th class="sortable numeric">Emp. CPF</th>
                        <th class="sortable numeric">Net Salary</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for employee in employees.items %}
                    <tr data-employee-id="{{ employee.id }}">
                        <td>{{ employee.employee_id }}</td>
                        <td>{{ employee.first_name }} {{ employee.last_name }}</td>
                        <td>{{ employee.designation.name if employee.designation else '-' }}</td>
                        <td class="numeric">
                            <span class="display-value">${{ "%.2f"|format(employee.basic_salary or 0) }}</span>
                            <input type="number" class="edit-value" name="basic_salary" value="{{ employee.basic_salary or 0 }}" step="0.01">
                        </td>
                        <td class="numeric">
                            <span class="display-value">${{ "%.2f"|format(employee.payroll_config.allowance_1_amount if employee.payroll_config else 0) }}</span>
                            <input type="number" class="edit-value" name="allowance_1_amount" value="{{ employee.payroll_config.allowance_1_amount if employee.payroll_config else 0 }}" step="0.01">
                        </td>
                        <td class="numeric">
                            <span class="display-value">${{ "%.2f"|format(employee.payroll_config.allowance_2_amount if employee.payroll_config else 0) }}</span>
                            <input type="number" class="edit-value" name="allowance_2_amount" value="{{ employee.payroll_config.allowance_2_amount if employee.payroll_config else 0 }}" step="0.01">
                        </td>
                        <td class="numeric">
                            <span class="display-value">${{ "%.2f"|format(employee.payroll_config.allowance_3_amount if employee.payroll_config else 0) }}</span>
                            <input type="number" class="edit-value" name="allowance_3_amount" value="{{ employee.payroll_config.allowance_3_amount if employee.payroll_config else 0 }}" step="0.01">
                        </td>
                        <td class="numeric">
                            <span class="display-value">${{ "%.2f"|format(employee.payroll_config.allowance_4_amount if employee.payroll_config else 0) }}</span>
                            <input type="number" class="edit-value" name="allowance_4_amount" value="{{ employee.payroll_config.allowance_4_amount if employee.payroll_config else 0 }}" step="0.01">
                        </td>
                        <td class="numeric">
                            <span class="display-value">${{ "%.2f"|format(employee.payroll_config.ot_rate_per_hour if employee.payroll_config and employee.payroll_config.ot_rate_per_hour else 0) }}</span>
                            <input type="number" class="edit-value" name="ot_rate_per_hour" value="{{ employee.payroll_config.ot_rate_per_hour if employee.payroll_config and employee.payroll_config.ot_rate_per_hour else 0 }}" step="0.01">
                        </td>
                        <td class="numeric">
                            <span class="display-value">${{ "%.2f"|format(employee.payroll_config.employee_cpf if employee.payroll_config else 0) }}</span>
                        </td>
                        <td class="numeric">
                            <span class="display-value">${{ "%.2f"|format(employee.payroll_config.net_salary if employee.payroll_config else 0) }}</span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-edit" onclick="enableEdit(this)" title="Edit">Edit</button>
                                <button class="btn-save" onclick="saveConfig(this, {{ employee.id }})" title="Save">Save</button>
                                <button class="btn-cancel" onclick="cancelEdit(this)" title="Cancel">âœ•</button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Footer with Pagination and Records Per Page -->
        <div class="payroll-footer">
            <div class="pagination-info">
                Showing {{ (employees.page - 1) * employees.per_page + 1 }}-{{ [employees.page * employees.per_page, employees.total]|min }} of {{ employees.total }} records
            </div>

            <div class="pagination-controls">
                <button {% if not employees.has_prev %}disabled{% endif %} onclick="goToPage(1)">First</button>
                <button {% if not employees.has_prev %}disabled{% endif %} onclick="goToPage({{ employees.prev_num }})">Previous</button>
                
                <input type="number" class="pagination-input" id="pageInput" value="{{ employees.page }}" min="1" max="{{ employees.pages }}" onchange="goToPage(this.value)">
                
                <span>of {{ employees.pages }}</span>
                
                <button {% if not employees.has_next %}disabled{% endif %} onclick="goToPage({{ employees.next_num }})">Next</button>
                <button {% if not employees.has_next %}disabled{% endif %} onclick="goToPage({{ employees.pages }})">Last</button>
            </div>

            <div class="records-per-page">
                <label for="perPageSelect">Records per page:</label>
                <select id="perPageSelect" onchange="changePerPage(this.value)">
                    <option value="15" {% if per_page == 15 %}selected{% endif %}>15</option>
                    <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
                    <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                    <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                </select>
            </div>
        </div>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-inbox"></i>
            <p>No employees found</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
function goToPage(pageNum) {
    const search = new URLSearchParams(window.location.search).get('search') || '';
    const perPage = document.getElementById('perPageSelect').value;
    const sortBy = new URLSearchParams(window.location.search).get('sort_by') || 'employee_id';
    const sortOrder = new URLSearchParams(window.location.search).get('sort_order') || 'asc';
    const url = new URL(window.location);
    url.searchParams.set('page', pageNum);
    url.searchParams.set('per_page', perPage);
    url.searchParams.set('sort_by', sortBy);
    url.searchParams.set('sort_order', sortOrder);
    if (search) url.searchParams.set('search', search);
    window.location.href = url.toString();
}

function changePerPage(value) {
    const url = new URL(window.location);
    url.searchParams.set('page', 1);
    url.searchParams.set('per_page', value);
    window.location.href = url.toString();
}

// Sorting functionality
document.querySelectorAll('.payroll-grid th.sortable').forEach(th => {
    th.addEventListener('click', function() {
        const column = this.dataset.column;
        const currentSort = new URLSearchParams(window.location.search).get('sort_by') || 'employee_id';
        const currentOrder = new URLSearchParams(window.location.search).get('sort_order') || 'asc';
        
        let newOrder = 'asc';
        if (column === currentSort && currentOrder === 'asc') {
            newOrder = 'desc';
        }
        
        const url = new URL(window.location);
        url.searchParams.set('sort_by', column);
        url.searchParams.set('sort_order', newOrder);
        url.searchParams.set('page', 1);
        window.location.href = url.toString();
    });
});

// Edit/Save functionality
function enableEdit(btn) {
    const row = btn.closest('tr');
    row.classList.add('editing');
    
    row.querySelectorAll('.edit-value').forEach(input => {
        input.style.display = 'block';
    });
    
    row.querySelectorAll('.display-value').forEach(span => {
        span.style.display = 'none';
    });
    
    row.querySelector('.btn-edit').style.display = 'none';
    row.querySelector('.btn-save').style.display = 'inline-block';
    row.querySelector('.btn-cancel').style.display = 'inline-block';
}

function cancelEdit(btn) {
    const row = btn.closest('tr');
    row.classList.remove('editing');
    
    row.querySelectorAll('.edit-value').forEach(input => {
        input.style.display = 'none';
    });
    
    row.querySelectorAll('.display-value').forEach(span => {
        span.style.display = 'block';
    });
    
    row.querySelector('.btn-edit').style.display = 'inline-block';
    row.querySelector('.btn-save').style.display = 'none';
    row.querySelector('.btn-cancel').style.display = 'none';
}

function saveConfig(btn, employeeId) {
    const row = btn.closest('tr');
    const data = {
        employee_id: employeeId,
        basic_salary: row.querySelector('input[name="basic_salary"]').value,
        allowance_1_amount: row.querySelector('input[name="allowance_1_amount"]').value,
        allowance_2_amount: row.querySelector('input[name="allowance_2_amount"]').value,
        allowance_3_amount: row.querySelector('input[name="allowance_3_amount"]').value,
        allowance_4_amount: row.querySelector('input[name="allowance_4_amount"]').value,
        ot_rate_per_hour: row.querySelector('input[name="ot_rate_per_hour"]').value
    };

    fetch('{{ url_for("payroll_config_update") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('Configuration saved successfully!');
            location.reload();
        } else {
            alert('Error: ' + result.message);
        }
    })
    .catch(error => {
        alert('Error saving configuration: ' + error);
    });
}

// Highlight sort column
function highlightSortColumn() {
    const sortBy = new URLSearchParams(window.location.search).get('sort_by') || 'employee_id';
    const sortOrder = new URLSearchParams(window.location.search).get('sort_order') || 'asc';
    
    document.querySelectorAll('.payroll-grid th.sortable').forEach(th => {
        if (th.dataset.column === sortBy) {
            th.classList.add(sortOrder === 'asc' ? 'sorted-asc' : 'sorted-desc');
        }
    });
}

document.addEventListener('DOMContentLoaded', highlightSortColumn);
</script>

{% endblock %}