{% extends "base.html" %}

{% block title %}Payroll Configuration - Nexar{% endblock %}

{% block content %}<div class="payroll-config-container">
    <!-- Header Section -->
    <div class="payroll-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h3>
                    <i class="fas fa-dollar-sign me-2"></i>Payroll Configuration
                </h3>
                <p class="text-muted mb-0">Manage salary components and CPF contributions</p>
            </div>
            <div class="d-flex gap-2">
                <a href="{{ url_for('reports_menu') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Back
                </a>
                <a href="{{ url_for('report_payroll_configuration', export='csv') }}" class="btn btn-success">
                    <i class="fas fa-file-csv me-1"></i>Export CSV
                </a>
            </div>
        </div>
    </div>

    <!-- Content Section -->
    <div class="payroll-content">
        {% if configs and configs|length > 0 %}
        <div class="grid-wrapper">
            <table class="payroll-grid">
                <thead>
                    <tr>
                        <th class="sortable" data-column="company_code">Co. Code</th>
                        <th class="sortable" data-column="employee_id">Emp ID</th>
                        <th class="sortable" data-column="first_name">Employee Name</th>
                        <th class="sortable" data-column="designation">Job Title</th>
                        <th class="sortable numeric" data-column="basic_salary">Basic Salary</th>
                        <th class="sortable numeric" data-column="allowances">Allowances</th>
                        <th class="sortable numeric" data-column="employer_cpf">Emp. CPF %</th>
                        <th class="sortable numeric" data-column="employee_cpf">Emp. CPF</th>
                        <th class="sortable numeric" data-column="gross_salary">Gross</th>
                        <th class="sortable numeric" data-column="net_salary">Net Salary</th>
                        <th class="sortable numeric" data-column="ot_rate">OT Rate</th>
                        <th class="sortable" data-column="remarks">Remarks</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for config in configs %}
                    <tr data-config-id="{{ config.id }}">
                        <td>{{ config.company_code }}</td>
                        <td>{{ config.employee_id }}</td>
                        <td>{{ config.name }}</td>
                        <td>{{ config.designation }}</td>
                        <td class="numeric">
                            <span class="display-value">${{ "%.2f"|format(config.basic_salary) }}</span>
                            <input type="number" class="edit-value" name="basic_salary"
                                value="{{ config.basic_salary }}" step="0.01">
                        </td>
                        <td class="numeric">
                            <span class="display-value">${{ "%.2f"|format(config.allowances) }}</span>
                            <input type="number" class="edit-value" name="allowances" value="{{ config.allowances }}"
                                step="0.01">
                        </td>
                        <td class="numeric">
                            <span class="display-value">${{ "%.2f"|format(config.employer_cpf) }}</span>
                            <input type="number" class="edit-value" name="employer_cpf"
                                value="{{ config.employer_cpf }}" step="0.01">
                        </td>
                        <td class="numeric">
                            <span class="display-value">${{ "%.2f"|format(config.employee_cpf) }}</span>
                            <input type="number" class="edit-value" name="employee_cpf"
                                value="{{ config.employee_cpf }}" step="0.01">
                        </td>
                        <td class="numeric">
                            <span class="display-value">${{ "%.2f"|format(config.gross_salary) }}</span>
                        </td>
                        <td class="numeric">
                            <span class="display-value">${{ "%.2f"|format(config.net_salary) }}</span>
                            <input type="number" class="edit-value" name="net_salary" value="{{ config.net_salary }}"
                                step="0.01">
                        </td>
                        <td class="numeric">
                            <span class="display-value">${{ "%.2f"|format(config.ot_rate) }}</span>
                            <input type="number" class="edit-value" name="ot_rate" value="{{ config.ot_rate }}"
                                step="0.01">
                        </td>
                        <td>
                            <span class="display-value" title="{{ config.remarks }}">{{ config.remarks[:20] if
                                config.remarks else '-' }}</span>
                            <input type="text" class="edit-value" name="remarks" value="{{ config.remarks }}">
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-edit" onclick="editRow(this)" title="Edit row">Edit</button>
                                <button class="btn-save" onclick="saveRow(this)" title="Save changes">Save</button>
                                <button class="btn-cancel" onclick="cancelEdit(this)" title="Cancel edit">✕</button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Footer with Pagination and Records Per Page -->
        <div class="payroll-footer">
            <div class="pagination-info">
                Showing <strong>{{ (page - 1) * per_page + 1 }}-{{ [page * per_page, total]|min }}</strong> of
                <strong>{{ total }}</strong> records
            </div>

            <div class="pagination-controls">
                <button onclick="goToPage(1)" {% if page <=1 %}disabled{% endif %}>First</button>
                <button onclick="goToPage({{ page - 1 }})" {% if page <=1 %}disabled{% endif %}>← Previous</button>
                <input type="number" class="pagination-input" id="pageInput" value="{{ page }}" min="1"
                    max="{{ total_pages }}" onchange="goToPage(this.value)">
                <span>of {{ total_pages }}</span>
                <button onclick="goToPage({{ page + 1 }})" {% if page>= total_pages %}disabled{% endif %}>Next
                    →</button>
                <button onclick="goToPage({{ total_pages }})" {% if page>= total_pages %}disabled{% endif
                    %}>Last</button>
            </div>

            <div class="records-per-page">
                <label>Records per page:</label>
                <select onchange="changeRecordsPerPage(this.value)">
                    <option value="15" {% if per_page==15 %}selected{% endif %}>15</option>
                    <option value="25" {% if per_page==25 %}selected{% endif %}>25</option>
                    <option value="50" {% if per_page==50 %}selected{% endif %}>50</option>
                    <option value="100" {% if per_page==100 %}selected{% endif %}>100</option>
                </select>
            </div>
        </div>

        {% else %}
        <div class="grid-wrapper">
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <p>No payroll configurations found</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
    let currentSort = {
        column: '{{ sort_by }}',
        order: '{{ sort_order }}'
    };

    // Initialize sort indicators
    document.addEventListener('DOMContentLoaded', function () {
        updateSortIndicators();
    });

    function updateSortIndicators() {
        document.querySelectorAll('.payroll-grid th.sortable').forEach(th => {
            th.classList.remove('sorted-asc', 'sorted-desc');
            if (th.dataset.column === currentSort.column) {
                th.classList.add(currentSort.order === 'asc' ? 'sorted-asc' : 'sorted-desc');
            }
        });
    }

    // Sorting
    document.querySelectorAll('.payroll-grid th.sortable').forEach(th => {
        th.addEventListener('click', function () {
            const column = this.dataset.column;
            let order = 'asc';

            if (currentSort.column === column && currentSort.order === 'asc') {
                order = 'desc';
            }

            const url = new URL(window.location);
            url.searchParams.set('sort_by', column);
            url.searchParams.set('sort_order', order);
            url.searchParams.set('page', 1);
            url.searchParams.set('per_page', '{{ per_page }}');
            window.location.href = url.toString();
        });
    });

    // Edit Row
    function editRow(button) {
        const row = button.closest('tr');
        row.classList.add('editing');

        // Show edit inputs and hide display values
        row.querySelectorAll('.display-value').forEach(el => el.style.display = 'none');
        row.querySelectorAll('.edit-value').forEach(el => el.style.display = 'block');

        // Show save/cancel, hide edit
        row.querySelector('.btn-edit').style.display = 'none';
        row.querySelector('.btn-save').style.display = 'inline-block';
        row.querySelector('.btn-cancel').style.display = 'inline-block';

        // Focus first edit field
        row.querySelector('.edit-value')?.focus();
    }

    // Cancel Edit
    function cancelEdit(button) {
        const row = button.closest('tr');
        row.classList.remove('editing');

        // Show display values, hide edit inputs
        row.querySelectorAll('.display-value').forEach(el => el.style.display = 'inline');
        row.querySelectorAll('.edit-value').forEach(el => el.style.display = 'none');

        // Show edit, hide save/cancel
        row.querySelector('.btn-edit').style.display = 'inline-block';
        row.querySelector('.btn-save').style.display = 'none';
        row.querySelector('.btn-cancel').style.display = 'none';
    }

    // Save Row
    function saveRow(button) {
        const row = button.closest('tr');
        const configId = row.dataset.configId;

        // Collect edited values
        const data = {};
        row.querySelectorAll('.edit-value').forEach(input => {
            data[input.name] = input.value;
        });

        // Send to server
        fetch(`{{ url_for('update_payroll_configuration', config_id=0) }}`.replace('0', configId), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Update display values with new values
                    row.querySelectorAll('.edit-value').forEach(input => {
                        const displayEl = input.parentElement.querySelector('.display-value');
                        if (displayEl) {
                            if (input.type === 'number') {
                                displayEl.textContent = '$' + parseFloat(input.value).toFixed(2);
                            } else {
                                displayEl.textContent = input.value || '-';
                                displayEl.title = input.value;
                            }
                        }
                    });

                    cancelEdit(button);
                    alert('Configuration updated successfully!');
                } else {
                    alert('Error: ' + result.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error saving configuration');
            });
    }

    // Pagination
    function goToPage(pageNum) {
        const url = new URL(window.location);
        url.searchParams.set('page', pageNum);
        url.searchParams.set('per_page', '{{ per_page }}');
        url.searchParams.set('sort_by', currentSort.column);
        url.searchParams.set('sort_order', currentSort.order);
        window.location.href = url.toString();
    }

    function changeRecordsPerPage(value) {
        const url = new URL(window.location);
        url.searchParams.set('per_page', value);
        url.searchParams.set('page', 1);
        url.searchParams.set('sort_by', currentSort.column);
        url.searchParams.set('sort_order', currentSort.order);
        window.location.href = url.toString();
    }
</script>

{% endblock %}