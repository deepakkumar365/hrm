{% extends "base.html" %}

{% block title %}Monthly Attendance Register{% endblock %}

{% block head %}
<style>
    .attendance-grid-container {
        overflow-x: auto;
    }

    .attendance-table th,
    .attendance-table td {
        text-align: center;
        vertical-align: middle;
        font-size: 0.85rem;
        padding: 0.4rem;
        white-space: nowrap;
    }

    .status-cell {
        font-weight: bold;
        width: 30px;
    }

    .status-P {
        color: #198754;
        background-color: #d1e7dd;
    }

    /* Present - Green */
    .status-A {
        color: #dc3545;
        background-color: #f8d7da;
    }

    /* Absent - Red */
    .status-L {
        color: #0d6efd;
        background-color: #cfe2ff;
    }

    /* Leave - Blue */
    .status-HD {
        color: #fd7e14;
        background-color: #ffe5d0;
    }

    /* Half Day - Orange */
    .status-WO {
        color: #6c757d;
        background-color: #e2e3e5;
    }

    /* Weekly Off - Grey */
    .status-H {
        color: #6610f2;
        background-color: #e0cffc;
    }

    /* Holiday - Purple */
    .status-INC {
        color: #d63384;
        background-color: #f7d6e6;
    }

    /* Incomplete - Pink */
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="mb-1">Monthly Attendance Register</h4>
            <div class="text-muted small">Overview for {{ days[0].strftime('%B %Y') }}</div>
        </div>
        <div class="d-flex gap-2">
            <form class="d-flex gap-2" method="GET">
                <select name="department" class="form-select form-select-sm" onchange="this.form.submit()">
                    <option value="">All Departments</option>
                    {% for dept in departments %}
                    <option value="{{ dept }}" {% if current_department==dept %}selected{% endif %}>{{ dept }}</option>
                    {% endfor %}
                </select>
                <select name="month" class="form-select form-select-sm" onchange="this.form.submit()">
                    {% for m in range(1, 13) %}
                    <option value="{{ m }}" {% if month==m %}selected{% endif %}>{{ m }}</option>
                    {% endfor %}
                </select>
                <select name="year" class="form-select form-select-sm" onchange="this.form.submit()">
                    <option value="2025" {% if year==2025 %}selected{% endif %}>2025</option>
                    <option value="2026" {% if year==2026 %}selected{% endif %}>2026</option>
                </select>
            </form>
            <button class="btn btn-outline-success btn-sm"><i class="fas fa-file-export"></i> Export</button>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <div class="attendance-grid-container">
                <table class="table table-bordered attendance-table mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-3 text-start"
                                style="position: sticky; left: 0; background: #f8f9fa; z-index: 10; min-width: 150px;">
                                Employee</th>
                            {% for day in days %}
                            <th>{{ day.day }}<br><span class="small text-muted" style="font-weight: normal;">{{
                                    day.strftime('%a')[0] }}</span></th>
                            {% endfor %}
                            <th>P</th> <!-- Summary Columns -->
                            <th>A</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for emp in employees %}
                        <tr>
                            <td class="ps-3 text-start fw-bold"
                                style="position: sticky; left: 0; background: white; z-index: 5;">
                                {{ emp.first_name }} {{ emp.last_name }}
                            </td>
                            {% set ns = namespace(p_count=0, a_count=0) %}
                            {% for day in days %}
                            {% set record = attendance_map.get((emp.id, day.day)) %}
                            {% set code = record['code'] if record else '-' %}
                            {% if code == 'P' %}{% set ns.p_count = ns.p_count + 1 %}{% endif %}
                            {% if code == 'A' %}{% set ns.a_count = ns.a_count + 1 %}{% endif %}

                            <td class="status-cell status-{{ code }}"
                                title="{{ record['status'] if record else 'No Record' }}">
                                {{ code }}
                            </td>
                            {% endfor %}
                            <td class="bg-light fw-bold text-success">{{ ns.p_count }}</td>
                            <td class="bg-light fw-bold text-danger">{{ ns.a_count }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="mt-3 d-flex gap-3 small text-muted">
        <div class="d-flex align-items-center"><span class="status-cell status-P d-inline-block me-1 rounded"
                style="width: 15px; height: 15px;"></span> Present</div>
        <div class="d-flex align-items-center"><span class="status-cell status-A d-inline-block me-1 rounded"
                style="width: 15px; height: 15px;"></span> Absent</div>
        <div class="d-flex align-items-center"><span class="status-cell status-HD d-inline-block me-1 rounded"
                style="width: 15px; height: 15px;"></span> Half Day</div>
        <div class="d-flex align-items-center"><span class="status-cell status-WO d-inline-block me-1 rounded"
                style="width: 15px; height: 15px;"></span> Weekly Off</div>
        <div class="d-flex align-items-center"><span class="status-cell status-H d-inline-block me-1 rounded"
                style="width: 15px; height: 15px;"></span> Holiday</div>
        <div class="d-flex align-items-center"><span class="status-cell status-L d-inline-block me-1 rounded"
                style="width: 15px; height: 15px;"></span> Leave</div>
    </div>
</div>
{% endblock %}