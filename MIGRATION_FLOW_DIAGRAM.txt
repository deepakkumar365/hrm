================================================================================
                    DATABASE MIGRATION AUTO-RUN FLOW DIAGRAM
================================================================================

APPLICATION STARTUP FLOW:

┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│                         APP STARTS (main.py)                              │
│                                                                             │
└────────────────────────────────────┬────────────────────────────────────────┘
                                     │
                                     ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│                    Check: FLASK_SKIP_DB_INIT = '1' ?                      │
│                                                                             │
└────────────────────────────────────┬────────────────────────────────────────┘
                  YES                │                  NO
                   │                 │                   │
                   ↓                 │                   ↓
            ┌────────────┐           │       ┌──────────────────────┐
            │ SKIP INIT  │           │       │ Call:                │
            │ (no action)│           │       │ check_and_run_       │
            └────────────┘           │       │ migrations()         │
                   │                 │       └──────────────────────┘
                   │                 │                   │
                   │                 │                   ↓
                   │                 │       ┌──────────────────────────────┐
                   │                 │       │                              │
                   │                 │       │ Check: Already run?          │
                   │                 │       │ (_migrations_applied=True)  │
                   │                 │       │                              │
                   │                 │       └──────────────────────────────┘
                   │                 │                   │
                   │                 │      YES          │      NO
                   │                 │       │           │       │
                   │                 │       ↓           ↓       │
                   │                 │     RETURN    ┌──────────┐│
                   │                 │              │ Set flag  ││
                   │                 │              │_migr=True││
                   │                 │              └──────────┘│
                   │                 │                          │
                   │                 │                          ↓
                   │                 │         ┌─────────────────────────────┐
                   │                 │         │                             │
                   │                 │         │ Check DB Connection         │
                   │                 │         │                             │
                   │                 │         └────────────────┬────────────┘
                   │                 │                          │
                   │                 │                    ✅ Connected
                   │                 │                          │
                   │                 │                          ↓
                   │                 │    ┌────────────────────────────────────┐
                   │                 │    │                                    │
                   │                 │    │ Check: Tables exist?               │
                   │                 │    │ - hrm_users                        │
                   │                 │    │ - hrm_employees                    │
                   │                 │    │ - hrm_roles                        │
                   │                 │    │                                    │
                   │                 │    └────────────────────┬───────────────┘
                   │                 │                         │
                   │           YES   │       NO               │
                   │            │    │        │                │
                   │            ↓    │        ↓                │
                   │      ┌────────┐ │   ┌───────────────────────────┐
                   │      │SKIP    │ │   │                           │
                   │      │MIGRATION│ │   │ Check: AUTO_MIGRATE_     │
                   │      │(logged)  │ │   │ ON_STARTUP = true?       │
                   │      └────────┘ │ │   │                           │
                   │           │      │ │   └───────────────┬──────────┘
                   │           │      │ │                   │
                   │           │      │ │         YES       │       NO
                   │           │      │ │          │        │        │
                   │           │      │ │          ↓        │        ↓
                   │           │      │ │    ┌─────────┐   │   ┌──────────┐
                   │           │      │ │    │ RUN     │   │   │ SKIP     │
                   │           │      │ │    │ MIGRATE │   │   │ (warn)   │
                   │           │      │ │    │ (upgrade)   │   │ (logged) │
                   │           │      │ │    └────┬────┘   │   └──────────┘
                   │           │      │ │         │        │        │
                   │           │      │ │      ✅ Success  │        │
                   │           │      │ │         │        │        │
                   │           │      │ │         ↓        │        │
                   │           │      │ │    ┌─────────┐   │        │
                   │           │      │ │    │ TABLES  │   │        │
                   │           │      │ │    │ CREATED │   │        │
                   │           │      │ │    └────┬────┘   │        │
                   │           │      │ │         │        │        │
                   │           │      └─┴─────────┴────────┴────────┘
                   │           │                  │
                   │           └──────────────────┘
                   │                  │
                   │                  ↓
                   │    ┌──────────────────────────┐
                   │    │                          │
                   │    │ Call:                    │
                   │    │ initialize_default_data()│
                   │    │                          │
                   │    └──────────┬───────────────┘
                   │               │
                   │               ↓
                   │    ┌──────────────────────────┐
                   │    │                          │
                   │    │ Check: Tables exist?     │
                   │    │                          │
                   │    └──────────┬───────────────┘
                   │               │
                   │    ✅ YES     │     ❌ NO
                   │     │         │       │
                   │     ↓         │       ↓
                   │  ┌─────┐     │  ┌─────────┐
                   │  │ INIT│     │  │ SKIP    │
                   │  │DATA │     │  │ (warn)  │
                   │  └──┬──┘     │  └─────────┘
                   │     │        │       │
                   └─────┴────────┴───────┘
                         │
                         ↓
          ┌──────────────────────────────┐
          │                              │
          │ ✅ APP READY FOR USE        │
          │                              │
          └──────────────────────────────┘


DECISION TREE - WHAT HAPPENS BASED ON CONDITIONS:

                                     START
                                      │
                         ┌────────────┴────────────┐
                         │                         │
                  FLASK_SKIP_DB_INIT=1?           │
                 YES ↓                NO ↓         │
                 │                     │           │
              SKIP ALL              Check Tables  │
                 │                     │           │
                 └─→ Continue   ✅ EXIST ─┐        │
                     (no action)         │        │
                                   ❌ MISSING     │
                                    │            │
                            AUTO_MIGRATE=true?   │
                            YES ↓  NO ↓          │
                            │      │             │
                        RUN MIGRATE SKIP         │
                        │       └────────────┐   │
                        ↓                    ↓   ↓
                   Initialize Default Data ─┐
                        │                   │
                        ↓                   ↓
                   All Done - App Ready!
                   ✅ SUCCESSFUL STARTUP


MESSAGE FLOW - WHAT GETS LOGGED:

SCENARIO 1: First Run (No Tables, AUTO_MIGRATE=true)
  
  📦 Database tables not found. Running migrations...
  🔄 Applying migration: [migration_name] ...
  ✅ Migrations completed successfully!
  ✅ Default users created successfully!
  ✅ Default master data created successfully!
  → App starts normally


SCENARIO 2: Normal Run (Tables Exist)

  ✅ Database tables exist - skipping migrations
  ✅ Default users created successfully!
  ✅ Default master data created successfully!
  → App starts normally


SCENARIO 3: Missing Tables, AUTO_MIGRATE=false

  ⚠️  Database tables not found.
     To auto-run migrations on startup, set: AUTO_MIGRATE_ON_STARTUP=true
     Otherwise, run manually: flask db upgrade
  → App may have limited functionality


SCENARIO 4: Migration Error

  📦 Database tables not found. Running migrations...
  ❌ Migration failed: [error_details]
  → App startup fails - manual intervention needed


STATE MACHINE - TABLE EXISTENCE STATES:

┌─────────────────────────────────────────────────────────┐
│                    INITIAL STATE                         │
│         No database tables exist                         │
│     (hrm_users, hrm_employees, hrm_roles missing)       │
└───────────────────────────┬─────────────────────────────┘
                            │
                ┌───────────┴───────────┐
                │                       │
        AUTO_MIGRATE=true       AUTO_MIGRATE=false
                │                       │
                ↓                       ↓
        ┌──────────────┐         ┌─────────────┐
        │ RUNNING      │         │ WAITING     │
        │ MIGRATION    │         │ FOR MANUAL  │
        │              │         │ UPGRADE     │
        └──────┬───────┘         └─────────────┘
               │
        Migration succeeds
               │
               ↓
        ┌──────────────┐
        │ TABLES EXIST │
        │ APP READY    │
        └──────────────┘


DEPLOYMENT FLOW - DIFFERENT ENVIRONMENTS:

┌─────────────────────────────────────────────────────────────┐
│                     DEVELOPMENT                              │
│  AUTO_MIGRATE_ON_STARTUP=true                               │
│  Tables auto-create on restart                              │
│  Developer-friendly                                         │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                   DOCKER/CONTAINER                           │
│  AUTO_MIGRATE_ON_STARTUP=true                               │
│  Tables auto-create on container start                      │
│  First deployment: tables created automatically             │
│  Subsequent: skip migration, app ready                      │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│            PRODUCTION (Single Instance)                      │
│  AUTO_MIGRATE_ON_STARTUP=true                               │
│  Tables auto-create on deployment                           │
│  Simple deployment process                                  │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│       PRODUCTION (High Availability / Multiple Instances)    │
│  AUTO_MIGRATE_ON_STARTUP=false                              │
│  Manual: flask db upgrade (before deployment)               │
│  All instances start normally (no concurrent migrations)    │
└─────────────────────────────────────────────────────────────┘


ERROR HANDLING FLOW:

Database Connection Error
          ↓
   ❌ Cannot Connect
          ↓
   Log: "Error checking database tables"
          ↓
   App startup fails (fail-fast)
          ↓
   Admin must fix database connectivity

---

Migration Syntax Error
          ↓
   Running: flask db upgrade
          ↓
   ❌ Migration Failed
          ↓
   Log: "Migration failed: [error]"
          ↓
   App startup fails (fail-fast)
          ↓
   Admin must fix migration file

---

Missing Tables + AUTO_MIGRATE=false
          ↓
   ⚠️  Log warning
          ↓
   App continues (reduced functionality)
          ↓
   Admin runs: flask db upgrade
          ↓
   Restart app


CONTROL FLOW - ONE-TIME EXECUTION:

_migrations_applied = False (global flag)

First Call to check_and_run_migrations():
  1. Check: if _migrations_applied == False  ✅ (True)
  2. Set: _migrations_applied = True
  3. Check tables
  4. Run migrations (if needed)
  5. Return result

Subsequent Calls (if any):
  1. Check: if _migrations_applied == False  ✅ (False)
  2. Return immediately (skip execution)
  3. No duplicate migrations

Result: Only runs once per app startup!


ENVIRONMENT VARIABLE CONTROL:

                        STARTUP
                          │
                          ↓
          Read: AUTO_MIGRATE_ON_STARTUP env var
                          │
                ┌─────────┴─────────┐
                │                   │
         "true"/"1"/"yes"    anything else
                │                   │
                ↓                   ↓
        AUTO-MIGRATE        SKIP AUTO-MIGRATE
        (if needed)         (manual control)
                │                   │
                └─────────┬─────────┘
                          ↓
                       CONTINUE


================================================================================
                       SUMMARY OF KEY CONCEPTS
================================================================================

✅ SAFE EXECUTION:
   - One-time per startup (global flag)
   - Only if tables missing (existence check)
   - Proper error handling (fail-fast)
   - Clear logging (success/error/warning messages)

✅ ENVIRONMENT CONTROL:
   - AUTO_MIGRATE_ON_STARTUP true/false
   - Different behavior per environment
   - Easy to adjust deployment strategy

✅ BACKWARD COMPATIBLE:
   - Existing code still works
   - Existing migrations still work
   - Optional feature (can disable)

✅ DEVELOPER FRIENDLY:
   - Auto-runs in development
   - No manual steps in dev environment
   - Clear error messages if problems

================================================================================

For more details, see:
  📄 QUICK_START_DB_MIGRATION.md
  📄 docs/DATABASE_MIGRATION_AUTO_RUN.md
  📄 IMPLEMENTATION_SUMMARY_DB_MIGRATION.md

================================================================================